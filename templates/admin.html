<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Discord Server Manager</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='responsive.css') }}">
    {% include 'partials/config_styles.html' %}
    <script src="{{ url_for('static', filename='tab_enforcement.js') }}"></script>
    <script>
        window.DB_VERSION = {{ db_version }};
        window.DB_WIPE_MESSAGE = "{{ db_wipe_message }}";
    </script>
    <script src="{{ url_for('static', filename='db_wipe_notice.js') }}"></script>
    <script src="{{ url_for('static', filename='custom_modals.js') }}"></script>
    <style>
        /* Custom radio button styling with #15d8bc accent */
        input[type="radio"] {
            appearance: none;
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border: 2px solid #15d8bc;
            border-radius: 50%;
            background: transparent;
            cursor: pointer;
            position: relative;
        }
        input[type="radio"]:checked {
            background: #15d8bc;
            border-color: #15d8bc;
        }
        input[type="radio"]:checked::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 6px;
            height: 6px;
            background: #fff;
            border-radius: 50%;
        }
        input[type="radio"]:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .admin-layout {
            display: grid;
            grid-template-columns: 450px 1fr;
            gap: 20px;
            height: calc(100vh - 70px);
            padding: 20px;
            background: #121215;
        }

        .admin-left-panel {
            background: #191A1F;
            border-radius: 8px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            overflow-y: auto;
        }

        .admin-filters {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .filter-title {
            color: #fff;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .filter-checkbox {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 4px;
            cursor: pointer;
        }

        .filter-checkbox input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
            background: transparent;
            border: 2px solid #15d8bc;
            border-radius: 4px;
            position: relative;
        }

        .filter-checkbox input[type="checkbox"]:checked {
            background: #15d8bc;
            border-color: #15d8bc;
        }

        .filter-checkbox input[type="checkbox"]:checked::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 12px;
            height: 12px;
            background-image: url('/static/tick.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }

        .filter-checkbox label {
            color: #e0e0e0;
            cursor: pointer;
            flex: 1;
            user-select: none;
        }

        .users-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 15px;
        }

        .user-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: #212227;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            border: 2px solid transparent;
        }

        .user-item:hover {
            background: #2a2a30;
            transform: scale(1.015);
        }

        .user-item.selected {
            background: #212227;
            transform: scale(1.02);
            /* Border color and box-shadow are applied dynamically via JavaScript */
        }

        .user-item-tags {
            position: absolute;
            right: 12px;
            display: flex;
            gap: 6px;
            align-items: center;
        }

        .user-tag {
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .user-tag.flagged {
            background: #ffa500;
            color: #000;
        }

        .user-tag.banned {
            background: #ff4444;
            color: #fff;
        }

        .user-tag.admin {
            background: #fff;
            color: #000;
        }

        .user-item-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #2a2b32;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .user-item-avatar.default-avatar img {
            width: 24px;
            height: 24px;
            object-fit: contain;
            opacity: 0.6;
        }

        .user-item-info {
            flex: 1;
        }

        .user-item-name {
            color: #fff;
            font-size: 14px;
            font-weight: 500;
        }

        .user-item-id {
            color: #949BA4;
            font-size: 12px;
        }

        .admin-right-panel {
            background: #191A1F;
            border-radius: 8px;
            padding: 30px;
            overflow-y: auto;
        }

        .admin-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #949BA4;
            font-size: 16px;
        }

        .user-details-header {
            color: #fff;
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #282930;
        }

        .user-details-section {
            margin-bottom: 25px;
        }

        .detail-row {
            display: flex;
            padding: 12px 0;
            border-bottom: 1px solid #282930;
        }

        .detail-label {
            color: #949BA4;
            font-size: 14px;
            width: 200px;
            flex-shrink: 0;
        }

        .detail-value {
            color: #fff;
            font-size: 14px;
            flex: 1;
        }

        .detail-value.banned {
            color: #ff4444;
            font-weight: 600;
        }

        .detail-value.flagged {
            color: #ffaa00;
            font-weight: 600;
        }

        .admin-actions {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 30px;
        }

        .admin-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            color: #ffffff;
            background: linear-gradient(to bottom, #3a3a4d, #2a2a3d);
        }

        .admin-btn:hover:not(:disabled) {
            background: linear-gradient(to bottom, #4a4a5d, #3a3a4d);
        }

        .admin-btn.delete {
            background: linear-gradient(to bottom, #991a35, #3b0b15);
            color: #ffffff;
        }

        .admin-btn.delete:hover:not(:disabled) {
            background: linear-gradient(to bottom, #7a152b, #2d0810);
        }

        .admin-btn.delete.confirm-delete {
            background: linear-gradient(to bottom, #7a152b, #2d0810);
        }

        .admin-btn.ban {
            background: linear-gradient(to bottom, #991a35, #3b0b15);
            color: #ffffff;
        }

        .admin-btn.ban:hover:not(:disabled) {
            background: linear-gradient(to bottom, #7a152b, #2d0810);
        }

        .admin-btn.ban.confirm-ban {
            background: linear-gradient(to bottom, #7a152b, #2d0810);
        }

        .admin-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .grey-btn {
            background: linear-gradient(to bottom, #3a3a4d, #2a2a3d);
            border: none;
            color: #ffffff;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .grey-btn:hover {
            background: linear-gradient(to bottom, #4a4a5d, #3a3a4d);
        }

        /* Dialog styles */
        .dialog-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .dialog-overlay.active {
            display: flex;
        }

        .dialog-box {
            background: #191A1F;
            border-radius: 12px;
            padding: 1rem 1rem 0.5rem 1rem;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .dialog-header {
            color: #dcddde;
            font-size: 1.25rem;
            font-weight: 600;
            margin: 0;
            text-align: center;
        }

        .dialog-content {
            color: #949BA4;
            font-size: 0.9rem;
            line-height: 1.6;
            margin: 0;
            padding: 0.5rem;
            background: #121215;
            border-radius: 8px;
            white-space: pre-wrap;
            word-break: break-word;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            justify-content: flex-start;
        }

        .dialog-actions {
            display: flex;
            gap: 0.5rem;
            margin: 0 -1rem;
        }

        .dialog-btn {
            flex: 1;
            padding: 0.5rem;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .dialog-btn.primary {
            background: linear-gradient(to bottom, #15d8bc, #006e59);
            color: #121215;
        }

        .dialog-btn.primary:hover {
            background: linear-gradient(to bottom, #10b89e, #004e40);
        }

        .dialog-btn.secondary {
            background: linear-gradient(to bottom, #3a3a4d, #2a2a3d);
            color: #ffffff;
            font-weight: 600;
        }

        .dialog-btn.secondary:hover {
            background: linear-gradient(to bottom, #4a4a5d, #3a3a4d);
        }

        .no-users {
            color: #949BA4;
            font-size: 14px;
            text-align: center;
            padding: 20px;
        }

        .search-section {
            margin-bottom: 15px;
        }

        .search-input {
            width: 100%;
            padding: 10px 12px;
            background: #212227;
            border: none;
            border-radius: 6px;
            color: #fff;
            font-size: 14px;
        }

        .search-input:focus {
            outline: none;
        }

        .search-input:active {
            transform: none;
        }

        .search-input::placeholder {
            color: #949BA4;
        }

        /* Scrollbar styling */
        .admin-left-panel::-webkit-scrollbar,
        .admin-right-panel::-webkit-scrollbar,
        .users-list::-webkit-scrollbar {
            width: 8px;
        }

        .admin-left-panel::-webkit-scrollbar-track,
        .admin-right-panel::-webkit-scrollbar-track,
        .users-list::-webkit-scrollbar-track {
            background: #1e1e1e;
        }

        .admin-left-panel::-webkit-scrollbar-thumb,
        .admin-right-panel::-webkit-scrollbar-thumb,
        .users-list::-webkit-scrollbar-thumb {
            background: #555;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="panel">
        <nav class="navbar">
            <div class="navbar-content">
                <div class="navbar-left">
                    <div class="menu-icon" id="menu-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="3" y1="12" x2="21" y2="12"></line>
                            <line x1="3" y1="6" x2="21" y2="6"></line>
                            <line x1="3" y1="18" x2="21" y2="18"></line>
                        </svg>
                    </div>
                    <div class="navbar-text">
                        <h1 class="navbar-title">Ad <span class="gradient-z">Z</span> send</h1>
                        <p class="navbar-subtitle">Manage users and monitor platform activity</p>
                    </div>
                </div>
                <div class="nav-right"></div>
            </div>

            <!-- Dropdown Menu -->
            <div class="dropdown-menu" id="dropdown-menu">
                <a href="{{ url_for('home') }}" class="dropdown-item">Home</a>
                <a href="{{ url_for('purchase') }}" class="dropdown-item">Purchase</a>
                {% if not (plan_status and plan_status.plan_id and plan_status.plan_id.startswith('team_plan_')) %}
                <a href="{{ url_for('panel') }}" class="dropdown-item">Personal Panel</a>
                {% endif %}
                {% if has_business %}
                {% if is_owner %}
                <a href="{{ url_for('team_management') }}" class="dropdown-item">Team Management</a>
                {% endif %}
                <a href="{{ url_for('team_panel') }}" class="dropdown-item">Team Panel</a>
                {% endif %}
                <a href="{{ url_for('settings') }}" class="dropdown-item">Settings</a>
                <a href="{{ url_for('admin_panel') }}" class="dropdown-item">Admin</a>
                <div class="dropdown-divider"></div>
                <a href="https://discord.gg/KWt6rvCukp" target="_blank" class="dropdown-item discord-item">Discord Server</a>
                <a href="{{ url_for('logout') }}" class="dropdown-item logout-item">Logout</a>
            </div>
        </nav>

        <div class="admin-layout">
            <!-- Left Panel: Filters and User List -->
            <div class="admin-left-panel">
                <div class="search-section">
                    <input type="text" id="user-search" class="search-input" placeholder="Search by email or Adzsend ID...">
                </div>

                <div class="admin-filters">
                    <div class="filter-title">Filter users</div>
                    <div class="filter-checkbox">
                        <input type="checkbox" id="filter-non-plan" value="non_plan">
                        <label for="filter-non-plan">Free plan members</label>
                    </div>
                    <div class="filter-checkbox">
                        <input type="checkbox" id="filter-plan" value="plan">
                        <label for="filter-plan">Paid plan members</label>
                    </div>
                    <div class="filter-checkbox">
                        <input type="checkbox" id="filter-banned" value="banned">
                        <label for="filter-banned">Banned users</label>
                    </div>
                    <div class="filter-checkbox">
                        <input type="checkbox" id="filter-flagged" value="flagged">
                        <label for="filter-flagged">Flagged users</label>
                    </div>
                    <div class="filter-checkbox">
                        <input type="checkbox" id="filter-no-discord" value="no_discord">
                        <label for="filter-no-discord">No linked Discord</label>
                    </div>
                </div>

                <div class="users-list" id="users-list">
                    <div class="no-users">Select filters to view users</div>
                </div>
            </div>

            <!-- Right Panel: User Details -->
            <div class="admin-right-panel" id="user-details-panel">
                <div class="admin-placeholder">Select a user to view details</div>
            </div>
        </div>
    </div>

    <!-- Message Dialog -->
    <div class="dialog-overlay" id="message-dialog">
        <div class="dialog-box">
            <div class="dialog-header" id="dialog-title">User Message</div>
            <div class="dialog-content" id="dialog-message"></div>
            <div class="dialog-actions">
                <button class="dialog-btn primary" id="copy-message-btn" onclick="copyMessage()">Copy to Clipboard</button>
                <button class="dialog-btn secondary" onclick="closeDialog()">Close</button>
            </div>
        </div>
    </div>

    <!-- Flagging Dialog -->
    <div class="dialog-overlay" id="flagging-dialog">
        <div class="dialog-box">
            <div class="dialog-header">User flagging information</div>
            <div class="dialog-content" id="flagging-reason"></div>
            <div class="dialog-actions">
                <button class="dialog-btn primary" id="unflag-confirm-btn" onclick="confirmUnflag()">Unflag user</button>
                <button class="dialog-btn secondary" onclick="closeFlaggingDialog()">Close</button>
            </div>
        </div>
    </div>

    <!-- Plans and Usage Dialog -->
    <div class="dialog-overlay" id="plans-usage-dialog">
        <div class="dialog-box" style="max-width: 550px;">
            <div class="dialog-header">Plans and Usage</div>

            <!-- Tab Navigation -->
            <div style="display: flex; gap: 1.5rem; margin: 0;">
                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                    <input type="radio" name="plans-tab" value="plan-info" checked onchange="switchPlansTab('plan-info')" style="cursor: pointer;">
                    <span style="color: #dcddde; font-weight: 500;">Plan information</span>
                </label>
                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                    <input type="radio" name="plans-tab" value="invoices" onchange="switchPlansTab('invoices')" style="cursor: pointer;">
                    <span style="color: #dcddde; font-weight: 500;">Invoices</span>
                </label>
                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                    <input type="radio" name="plans-tab" value="usage" onchange="switchPlansTab('usage')" style="cursor: pointer;">
                    <span style="color: #dcddde; font-weight: 500;">Usage</span>
                </label>
            </div>

            <!-- Tab Content -->
            <div class="dialog-content" id="plans-usage-content" style="min-height: auto; text-align: left;">
                Loading...
            </div>

            <div class="dialog-actions">
                <button class="dialog-btn primary" onclick="closePlansUsageDialog()">Close</button>
            </div>
        </div>
    </div>

    <!-- Discord Account View Dialog -->
    <div class="dialog-overlay" id="discord-view-dialog">
        <div class="dialog-box" style="max-width: 450px;">
            <div class="dialog-header">Linked Discord account</div>
            <div class="dialog-content" id="discord-account-content" style="padding: 0; overflow-y: auto; overflow-x: hidden; display: block;">
                <!-- Discord account card will be populated here -->
            </div>
            <div class="dialog-actions">
                <button class="dialog-btn primary" onclick="closeDiscordViewDialog()">Close</button>
            </div>
        </div>
    </div>

    <script>
        let currentUser = null;
        let allUsers = [];
        let currentMessageContent = '';

        // Format date as mm/dd/yy
        function formatDate(dateStr) {
            if (!dateStr) return 'Unknown';
            const d = new Date(dateStr);
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            const year = String(d.getFullYear()).slice(-2);
            return `${month}/${day}/${year}`;
        }

        // Extract dominant color from avatar image
        function getDominantColor(imgElement) {
            try {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = imgElement.width || 40;
                canvas.height = imgElement.height || 40;

                ctx.drawImage(imgElement, 0, 0, canvas.width, canvas.height);
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imageData.data;

                let r = 0, g = 0, b = 0, count = 0;

                for (let i = 0; i < data.length; i += 4) {
                    const alpha = data[i + 3];
                    if (alpha > 128) {
                        r += data[i];
                        g += data[i + 1];
                        b += data[i + 2];
                        count++;
                    }
                }

                if (count === 0) return '#335FFF';

                r = Math.floor(r / count);
                g = Math.floor(g / count);
                b = Math.floor(b / count);

                return `rgb(${r}, ${g}, ${b})`;
            } catch (e) {
                console.error('Error extracting color:', e);
                return '#335FFF';
            }
        }

        // Hamburger menu toggle
        const menuIcon = document.getElementById('menu-icon');
        const dropdownMenu = document.getElementById('dropdown-menu');

        if (menuIcon) {
            menuIcon.addEventListener('click', function(event) {
                event.stopPropagation();
                if (dropdownMenu) {
                    dropdownMenu.classList.toggle('show');
                }
            });
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            if (dropdownMenu && menuIcon && !menuIcon.contains(event.target) && !dropdownMenu.contains(event.target)) {
                dropdownMenu.classList.remove('show');
            }
        });

        // Load users when filters change
        document.querySelectorAll('.filter-checkbox input').forEach(checkbox => {
            checkbox.addEventListener('change', loadUsers);
        });

        // Search functionality
        const searchInput = document.getElementById('user-search');
        let searchTimeout;
        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                const searchTerm = this.value.trim();
                if (searchTerm) {
                    searchUserById(searchTerm);
                } else {
                    loadUsers();
                }
            }, 300);
        });

        async function loadUsers() {
            const filters = Array.from(document.querySelectorAll('.filter-checkbox input:checked'))
                .map(cb => cb.value);

            const params = new URLSearchParams();

            if (filters.length > 0) {
                filters.forEach(filter => params.append(filter, 'true'));
            } else {
                // Show all users when no filter is selected
                params.append('non_plan', 'true');
                params.append('plan', 'true');
            }

            try {
                const response = await fetch(`/api/admin/users?${params}`);
                const data = await response.json();

                if (data.success) {
                    allUsers = data.users;
                    renderUsersList(data.users);
                } else {
                    console.error('Failed to load users:', data.error);
                }
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        async function searchUserById(searchTerm) {
            const usersList = document.getElementById('users-list');

            try {
                // Check if it looks like an email or Adzsend ID (18 digits)
                const isEmail = searchTerm.includes('@');
                const queryParam = isEmail ? 'email' : 'adzsend_id';
                const response = await fetch(`/api/admin/search-user?${queryParam}=${encodeURIComponent(searchTerm)}`);
                const data = await response.json();

                if (data.success && data.user) {
                    allUsers = [data.user];
                    renderUsersList([data.user]);
                } else {
                    usersList.innerHTML = '<div class="no-users">No user found</div>';
                }
            } catch (error) {
                console.error('Error searching user:', error);
                usersList.innerHTML = '<div class="no-users">Error searching user</div>';
            }
        }

        function renderUsersList(users) {
            const usersList = document.getElementById('users-list');

            if (users.length === 0) {
                usersList.innerHTML = '<div class="no-users">No users found</div>';
                return;
            }

            usersList.innerHTML = users.map(user => {
                // Check if user has linked Discord account (for avatar color extraction)
                const hasDiscordLinked = user.discord_oauth_discord_id && user.discord_oauth_discord_id.trim() !== '';
                const avatarUrl = (hasDiscordLinked && user.discord_oauth_avatar)
                    ? `https://cdn.discordapp.com/avatars/${user.discord_oauth_discord_id}/${user.discord_oauth_avatar}.png`
                    : null;

                const tags = [];
                if (user.banned) tags.push('<span class="user-tag banned">Banned</span>');
                if (user.flagged) tags.push('<span class="user-tag flagged">Flagged</span>');
                if (user.is_admin) tags.push('<span class="user-tag admin">Admin</span>');

                // Check if this user is currently selected
                const isSelected = currentUser && currentUser.id === user.id;
                const selectedClass = isSelected ? ' selected' : '';

                // Display only Adzsend ID in the list
                const displayAdzsendId = user.adzsend_id || 'No ID';

                return `
                <div class="user-item${selectedClass}" onclick="selectUser(${user.id}, event)" data-user-id="${user.id}" data-avatar-url="${avatarUrl || ''}" data-has-discord="${hasDiscordLinked ? 'true' : 'false'}">
                    <div class="user-item-info" style="padding-left: 4px;">
                        <div class="user-item-id" style="font-size: 14px; color: #e0e0e0;">${displayAdzsendId}</div>
                    </div>
                    ${tags.length > 0 ? `<div class="user-item-tags">${tags.join('')}</div>` : ''}
                </div>
            `;
            }).join('');

            // Restore styling for the selected user
            if (currentUser) {
                restoreSelectedUserStyling();
            }
        }

        function restoreSelectedUserStyling() {
            if (!currentUser) return;

            const selectedItem = document.querySelector(`.user-item[data-user-id="${currentUser.id}"]`);
            if (!selectedItem) return;

            // Only apply glow for users with linked Discord
            const hasDiscord = selectedItem.dataset.hasDiscord === 'true';
            if (hasDiscord) {
                // Use teal color for linked Discord users
                selectedItem.style.borderColor = 'rgba(21, 216, 188, 0.6)';
                selectedItem.style.boxShadow = '0 0 15px rgba(21, 216, 188, 0.4)';
            } else {
                // No glow for non-linked members - just a subtle border
                selectedItem.style.borderColor = 'rgba(148, 155, 164, 0.3)';
                selectedItem.style.boxShadow = 'none';
            }
        }

        function applyAvatarColorStyling(selectedItem, avatarImg) {
            const dominantColor = getDominantColor(avatarImg);
            const rgbaColor = dominantColor.replace('rgb', 'rgba').replace(')', ', 0.4)');
            const rgbaBorder = dominantColor.replace('rgb', 'rgba').replace(')', ', 0.6)');
            selectedItem.style.borderColor = rgbaBorder;
            selectedItem.style.boxShadow = `0 0 15px ${rgbaColor}`;
        }

        async function selectUser(userId, event) {
            // Highlight selected user
            document.querySelectorAll('.user-item').forEach(item => {
                item.classList.remove('selected');
                item.style.borderColor = 'transparent';
                item.style.boxShadow = 'none';
            });

            const selectedItem = event.currentTarget;
            selectedItem.classList.add('selected');

            // Only apply glow for users with linked Discord
            const hasDiscord = selectedItem.dataset.hasDiscord === 'true';
            if (hasDiscord) {
                // Use teal color for linked Discord users
                selectedItem.style.borderColor = 'rgba(21, 216, 188, 0.6)';
                selectedItem.style.boxShadow = '0 0 15px rgba(21, 216, 188, 0.4)';
            } else {
                // No glow for non-linked members - just a subtle border
                selectedItem.style.borderColor = 'rgba(148, 155, 164, 0.3)';
                selectedItem.style.boxShadow = 'none';
            }

            // Show loading indicator while fetching user details
            const panel = document.getElementById('user-details-panel');
            panel.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #949BA4; font-size: 1rem;">
                    Loading...
                </div>
            `;

            try {
                const response = await fetch(`/api/admin/user/${userId}`);
                const data = await response.json();

                if (data.success) {
                    currentUser = data.user;
                    renderUserDetails(data.user);
                } else {
                    console.error('Failed to load user details:', data.error);
                }
            } catch (error) {
                console.error('Error loading user details:', error);
            }
        }

        function renderUserDetails(user) {
            const panel = document.getElementById('user-details-panel');
            const hasBusinessTeam = user.is_business_owner || user.is_business_member;
            const businessInfo = user.is_business_owner
                ? 'Owner'
                : user.is_business_member
                    ? `Team member of ${(user.business_team_owner?.discord_id && !user.business_team_owner?.discord_id.startsWith('pending_') && user.business_team_owner?.discord_id !== 'no_discord_userid') ? user.business_team_owner.discord_id : 'Unknown'}`
                    : 'No';

            const isAdmin = user.is_admin;
            const disabledAttr = isAdmin ? 'disabled' : '';

            panel.innerHTML = `
                <div class="user-details-header">${user.username}</div>

                <div class="user-details-section">
                    <div class="detail-row">
                        <div class="detail-label">Account created (mm/dd/yy)</div>
                        <div class="detail-value">${new Date(user.signup_date).toLocaleString()}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Signup IP</div>
                        <div class="detail-value">${user.signup_ip}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Email</div>
                        <div class="detail-value" style="display: flex; align-items: center; gap: 8px;">
                            ${user.email || 'No email'}
                            ${user.email ? `<img src="{{ url_for('static', filename='copy.png') }}" style="width: 14px; height: 14px; cursor: pointer; opacity: 0.6; filter: sepia(1) saturate(5) hue-rotate(130deg) brightness(0.9);" onclick="copyToClipboard('${user.email}')">` : ''}
                        </div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Adzsend ID</div>
                        <div class="detail-value" style="display: flex; align-items: center; gap: 8px;">
                            ${user.adzsend_id || 'No ID'}
                            ${user.adzsend_id ? `<img src="{{ url_for('static', filename='copy.png') }}" style="width: 14px; height: 14px; cursor: pointer; opacity: 0.6; filter: sepia(1) saturate(5) hue-rotate(130deg) brightness(0.9);" onclick="copyToClipboard('${user.adzsend_id}')">` : ''}
                        </div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Discord</div>
                        <div class="detail-value" style="display: flex; align-items: center; gap: 8px;">
                            ${(user.discord_id && !user.discord_id.startsWith('pending_') && !user.discord_id.startsWith('email_') && user.discord_id !== 'no_discord_userid') ? 'Linked' : 'Not linked'}
                            ${(user.discord_id && !user.discord_id.startsWith('pending_') && !user.discord_id.startsWith('email_') && user.discord_id !== 'no_discord_userid') ? `<button class="grey-btn" onclick="viewDiscordAccount()" style="margin-left: 6px; padding: 4px 10px; border-radius: 4px; font-size: 12px;">View</button>` : ''}
                        </div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Plans and Usage</div>
                        <div class="detail-value">
                            ${user.subscriptions.length > 0 ? user.subscriptions.map(s => s.plan_name).join(', ') : 'No active plan'}
                            <button class="grey-btn" onclick="viewPlansUsage()" style="margin-left: 10px; padding: 4px 10px; border-radius: 4px; font-size: 12px;">View</button>
                        </div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Team</div>
                        <div class="detail-value">${businessInfo}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Banned</div>
                        <div class="detail-value ${user.banned ? 'banned' : ''}">${user.banned ? 'Yes' : 'No'}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Flagged</div>
                        <div class="detail-value ${user.flagged ? 'flagged' : ''}">${user.flagged ? 'Yes' : 'No'} (${user.flag_count || 0} time${(user.flag_count || 0) !== 1 ? 's' : ''})</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Last flagged (mm/dd/yy)</div>
                        <div class="detail-value ${user.flagged_at ? 'flagged' : ''}">${user.flagged_at ? new Date(user.flagged_at).toLocaleString() : 'Never'}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Admin</div>
                        <div class="detail-value">${user.is_admin ? 'Yes' : 'No'}</div>
                    </div>
                </div>

                <div class="admin-actions">
                    ${user.subscriptions.length > 0 ? `<button class="admin-btn" onclick="viewMessage()">View saved message</button>` : `<button class="admin-btn" onclick="viewMessage()" disabled style="opacity: 0.5; cursor: not-allowed;">View saved message</button>`}
                    ${hasBusinessTeam ? `<button class="admin-btn" onclick="viewTeamMessage()">View team message</button>` : `<button class="admin-btn" onclick="viewTeamMessage()" disabled style="opacity: 0.5; cursor: not-allowed;">View team message</button>`}
                    <button class="admin-btn" onclick="viewFlagging()" ${!user.flagged ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : ''}>View Flagging</button>
                    ${user.banned ?
                        `<button class="admin-btn ban" id="ban-btn" onclick="handleBanUnban()" ${disabledAttr}>Unban user</button>` :
                        `<button class="admin-btn ban" id="ban-btn" onclick="handleBanUnban()" ${disabledAttr}>Ban user</button>`
                    }
                    <button class="admin-btn delete" id="delete-btn" onclick="handleDelete()" ${disabledAttr}>Delete account</button>
                </div>
            `;
        }


        function copyToClipboard(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.opacity = '0';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();

            try {
                const success = document.execCommand('copy');
                if (success) {
                    alert('Copied to clipboard');
                }
            } catch (err) {
                console.error('Copy failed:', err);
            }

            document.body.removeChild(textArea);
        }

        async function viewMessage() {
            if (!currentUser) return;

            try {
                const response = await fetch(`/api/admin/user/${currentUser.id}/message`);
                const data = await response.json();

                if (data.success) {
                    currentMessageContent = data.message;
                    document.getElementById('dialog-title').textContent = 'User Saved Message';
                    document.getElementById('dialog-message').textContent = data.has_message ? data.message : 'No message saved';

                    const copyBtn = document.getElementById('copy-message-btn');
                    copyBtn.style.display = 'inline-block';
                    if (!data.has_message) {
                        copyBtn.disabled = true;
                        copyBtn.style.opacity = '0.5';
                        copyBtn.style.cursor = 'not-allowed';
                    } else {
                        copyBtn.disabled = false;
                        copyBtn.style.opacity = '1';
                        copyBtn.style.cursor = 'pointer';
                    }

                    document.getElementById('message-dialog').classList.add('active');
                }
            } catch (error) {
                console.error('Error loading message:', error);
            }
        }

        async function viewTeamMessage() {
            if (!currentUser) return;

            try {
                const response = await fetch(`/api/admin/user/${currentUser.id}/team-message`);
                const data = await response.json();

                if (data.success) {
                    currentMessageContent = data.message;
                    document.getElementById('dialog-title').textContent = 'Team Message';
                    document.getElementById('dialog-message').textContent = data.has_message ? data.message : 'No team message set';

                    const copyBtn = document.getElementById('copy-message-btn');
                    if (!data.has_message) {
                        copyBtn.disabled = true;
                        copyBtn.style.opacity = '0.5';
                        copyBtn.style.cursor = 'not-allowed';
                    } else {
                        copyBtn.disabled = false;
                        copyBtn.style.opacity = '1';
                        copyBtn.style.cursor = 'pointer';
                    }

                    document.getElementById('message-dialog').classList.add('active');
                }
            } catch (error) {
                console.error('Error loading team message:', error);
            }
        }

        function copyMessage() {
            const textArea = document.createElement('textarea');
            textArea.value = currentMessageContent;
            textArea.style.position = 'fixed';
            textArea.style.opacity = '0';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            const success = document.execCommand('copy');
            document.body.removeChild(textArea);

            if (success) {
                alert('Copied to clipboard');
            }
        }

        function closeDialog() {
            document.getElementById('message-dialog').classList.remove('active');
        }

        async function viewBillingHistory() {
            if (!currentUser) return;

            try {
                const response = await fetch(`/api/admin/user/${currentUser.id}/billing-history`);
                const data = await response.json();

                if (data.success) {
                    let historyHtml = '';
                    if (data.history && data.history.length > 0) {
                        historyHtml = data.history.map(sub => {
                            const startDate = formatDate(sub.start_date);
                            const endDate = sub.end_date ? formatDate(sub.end_date) : 'No expiry';
                            const status = sub.is_active ? '<span style="color: #57f287;">Active</span>' : '<span style="color: #949BA4;">Inactive</span>';
                            return `<div style="padding: 10px; border-radius: 6px; margin-bottom: 4px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                    <strong style="color: #fff;">${sub.plan_name || sub.plan_id}</strong>
                                    ${status}
                                </div>
                                <div style="font-size: 12px; color: #949BA4;">
                                    <div>Type: ${sub.plan_type || 'subscription'}</div>
                                    <div>Billing: ${sub.billing_period || 'N/A'}</div>
                                    <div>Started (mm/dd/yy): ${startDate}</div>
                                    <div>Expires (mm/dd/yy): ${endDate}</div>
                                    <div>Message limit: ${sub.message_limit === -1 ? 'Unlimited' : sub.message_limit}</div>
                                </div>
                            </div>`;
                        }).join('');
                    } else {
                        historyHtml = '<span style="color: #949BA4;">No billing history found</span>';
                    }

                    document.getElementById('dialog-title').textContent = 'Billing History';
                    document.getElementById('dialog-message').innerHTML = historyHtml;

                    const copyBtn = document.getElementById('copy-message-btn');
                    copyBtn.style.display = 'none';

                    document.getElementById('message-dialog').classList.add('active');
                }
            } catch (error) {
                console.error('Error loading billing history:', error);
            }
        }

        // Plans and Usage Dialog Functions
        let currentPlansTab = 'plan-info';

        function viewPlansUsage() {
            if (!currentUser) return;

            // Reset to first tab and show dialog
            currentPlansTab = 'plan-info';
            const planInfoRadio = document.querySelector('input[name="plans-tab"][value="plan-info"]');
            if (planInfoRadio) planInfoRadio.checked = true;

            document.getElementById('plans-usage-dialog').classList.add('active');
            loadPlansTabContent('plan-info');
        }

        function closePlansUsageDialog() {
            document.getElementById('plans-usage-dialog').classList.remove('active');
        }

        function viewDiscordAccount() {
            if (!currentUser) return;

            const discordContent = document.getElementById('discord-account-content');
            const hasDiscord = currentUser.discord_id &&
                              !currentUser.discord_id.startsWith('pending_') &&
                              !currentUser.discord_id.startsWith('email_') &&
                              currentUser.discord_id !== 'no_discord_userid';

            if (!hasDiscord) {
                // No Discord account - show single card
                discordContent.innerHTML = `
                    <div style="background: #212227; border-radius: 8px; padding: 1rem; display: flex; align-items: center; gap: 1rem;">
                        <div style="width: 48px; height: 48px; border-radius: 50%; overflow: hidden; flex-shrink: 0; background: #2a2b32; display: flex; align-items: center; justify-content: center;">
                            <img src="{{ url_for('static', filename='DiscordLogo.png') }}" alt="Discord" style="width: 28px; height: 28px; object-fit: contain; opacity: 0.5;">
                        </div>
                        <div style="flex: 1;">
                            <div style="color: #949BA4; font-size: 0.9rem;">No Discord account linked</div>
                        </div>
                    </div>
                `;
            } else {
                // Has Discord account - show scroll frame with account cards (matching settings page)
                let avatarHtml;
                if (currentUser.avatar) {
                    avatarHtml = `<img src="https://cdn.discordapp.com/avatars/${currentUser.discord_id}/${currentUser.avatar}.png" alt="Discord Avatar" style="width: 100%; height: 100%; object-fit: cover;">`;
                } else {
                    avatarHtml = `<div style="width: 100%; height: 100%; background: linear-gradient(135deg, #5865f2 0%, #15d8bc 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 0.9rem;">${currentUser.username ? currentUser.username[0].toUpperCase() : '?'}</div>`;
                }

                discordContent.innerHTML = `
                    <div style="display: flex; flex-direction: column;">
                        <!-- Linked Discord Account -->
                        <div style="background: #212227; border-radius: 8px; padding: 0.4rem 0.6rem; display: flex; align-items: center; gap: 0.5rem;">
                            <div style="width: 32px; height: 32px; border-radius: 50%; overflow: hidden; flex-shrink: 0; display: flex; align-items: center; justify-content: center;">
                                ${avatarHtml}
                            </div>
                            <div style="flex: 1; min-width: 0;">
                                <div style="color: #dcddde; font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; font-size: 0.85rem; line-height: 1.2; margin: 0; padding: 0;">${currentUser.username || 'Unknown User'}</div>
                                <div style="color: #949BA4; font-size: 0.75rem; display: flex; align-items: center; gap: 0.3rem; line-height: 1.2; margin: 0; padding: 0;">
                                    <span>ID: ${currentUser.discord_id}</span>
                                    <img src="{{ url_for('static', filename='copy.png') }}" style="width: 12px; height: 12px; cursor: pointer; opacity: 0.6; filter: brightness(0.5) opacity(0.7);" onclick="copyToClipboard('${currentUser.discord_id}')" title="Copy ID">
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            document.getElementById('discord-view-dialog').classList.add('active');
        }

        function closeDiscordViewDialog() {
            document.getElementById('discord-view-dialog').classList.remove('active');
        }

        function switchPlansTab(tabName) {
            currentPlansTab = tabName;
            loadPlansTabContent(tabName);
        }

        async function loadPlansTabContent(tabName) {
            const container = document.getElementById('plans-usage-content');
            container.innerHTML = 'Loading...';

            if (tabName === 'plan-info') {
                // Show current plan info - check if it's a paid plan (not free)
                const hasPaidPlan = currentUser.subscriptions && currentUser.subscriptions.length > 0 &&
                    currentUser.subscriptions.some(sub => sub.plan_id && sub.plan_id !== 'plan_free');

                if (hasPaidPlan) {
                    // Show full info for paid plans
                    container.innerHTML = currentUser.subscriptions.filter(sub => sub.plan_id !== 'plan_free').map(sub => `
                        <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                            <div style="display: flex; flex-direction: column; gap: 0.25rem;">
                                <div style="color: #949BA4; font-size: 0.85rem;">Status</div>
                                <div style="color: #15d8bc; font-size: 0.95rem;">Active</div>
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 0.25rem;">
                                <div style="color: #949BA4; font-size: 0.85rem;">Current plan</div>
                                <div style="color: #dcddde; font-size: 0.95rem;">${sub.plan_name}</div>
                            </div>
                            ${sub.plan_type === 'subscription' && sub.billing_period ? `
                            <div style="display: flex; flex-direction: column; gap: 0.25rem;">
                                <div style="color: #949BA4; font-size: 0.85rem;">Billing period</div>
                                <div style="color: #dcddde; font-size: 0.95rem;">${sub.billing_period.charAt(0).toUpperCase() + sub.billing_period.slice(1)}</div>
                            </div>
                            ` : ''}
                            ${sub.started_at ? `
                            <div style="display: flex; flex-direction: column; gap: 0.25rem;">
                                <div style="color: #949BA4; font-size: 0.85rem;">Plan started (mm/dd/yy)</div>
                                <div style="color: #dcddde; font-size: 0.95rem;">${formatDate(sub.started_at)}</div>
                            </div>
                            ` : ''}
                        </div>
                    `).join('');
                } else {
                    // Free plan - only show Status and Current plan
                    container.innerHTML = `
                        <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                            <div style="display: flex; flex-direction: column; gap: 0.25rem;">
                                <div style="color: #949BA4; font-size: 0.85rem;">Status</div>
                                <div style="color: #15d8bc; font-size: 0.95rem;">Active</div>
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 0.25rem;">
                                <div style="color: #949BA4; font-size: 0.85rem;">Current plan</div>
                                <div style="color: #dcddde; font-size: 0.95rem;">Free</div>
                            </div>
                        </div>
                    `;
                }
            } else if (tabName === 'invoices') {
                try {
                    const response = await fetch(`/api/admin/user/${currentUser.id}/billing-history`);
                    const data = await response.json();

                    if (data.success && data.history && data.history.length > 0) {
                        // Compact invoice layout with no gaps
                        container.innerHTML = `
                            <div style="display: flex; padding: 0.25rem 0; border-bottom: 1px solid rgba(255,255,255,0.1); color: #949BA4; font-size: 0.85rem; font-weight: 500; width: 100%; box-sizing: border-box; line-height: 1;">
                                <div style="flex: 1.5; min-width: 0; padding-right: 0.5rem; box-sizing: border-box;">Date (mm/dd/yy)</div>
                                <div style="flex: 1; min-width: 0; padding-right: 0.5rem; box-sizing: border-box;">Total</div>
                                <div style="flex: 1; min-width: 0; box-sizing: border-box;">Status</div>
                            </div>
                            <div style="max-height: 200px; overflow-y: auto; overflow-x: hidden; width: 100%; box-sizing: border-box;">
                                ${data.history.map((item, index) => `
                                    <div style="display: flex; padding: 0.25rem 0; align-items: center; gap: 0; width: 100%; box-sizing: border-box; border-bottom: 1px solid rgba(255,255,255,0.05); line-height: 1;">
                                        <div style="flex: 1.5; min-width: 0; color: #dcddde; font-size: 0.9rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; padding-right: 0.5rem; box-sizing: border-box;">${formatDate(item.start_date)}</div>
                                        <div style="flex: 1; min-width: 0; color: #dcddde; font-size: 0.9rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; padding-right: 0.5rem; box-sizing: border-box;">$${item.price || '0.00'}</div>
                                        <div style="flex: 1; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; box-sizing: border-box;">
                                            <span style="color: ${item.is_active ? '#15d8bc' : '#949BA4'}; font-size: 0.85rem;">${item.is_active ? 'Active' : 'Expired'}</span>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                    } else {
                        container.innerHTML = '<div style="color: #949BA4; text-align: center; padding: 1.5rem;">No invoice history available</div>';
                    }
                } catch (error) {
                    console.error('Error loading invoice history:', error);
                    container.innerHTML = '<div style="color: #991a35;">Error loading invoice history</div>';
                }
            } else if (tabName === 'usage') {
                // Get message limit from subscription data
                let messageLimit = 'N/A';
                let usageType = 'allowance';
                let allowancePeriod = null;
                if (currentUser.subscriptions && currentUser.subscriptions.length > 0) {
                    const activeSub = currentUser.subscriptions[0];
                    messageLimit = activeSub.message_limit === -1 ? 'Unlimited' : activeSub.message_limit;
                    usageType = activeSub.usage_type || 'allowance';
                    allowancePeriod = activeSub.allowance_period;
                }

                try {
                    const response = await fetch(`/api/admin/user/${currentUser.id}/plan-status`);
                    const data = await response.json();

                    if (data.success && data.plan_status) {
                        const planStatus = data.plan_status;
                        const messagesSent = planStatus.messages_sent || 0;
                        const nextReset = planStatus.next_reset;
                        const period = planStatus.allowance_period;

                        // Format period display
                        let periodLabel = '';
                        if (period === 'daily') periodLabel = 'Daily';
                        else if (period === 'weekly') periodLabel = 'Weekly';
                        else if (period === 'monthly') periodLabel = 'Monthly';

                        // Calculate reset countdown
                        let resetCountdown = 'N/A';
                        if (nextReset && planStatus.usage_type === 'allowance') {
                            const now = new Date();
                            const reset = new Date(nextReset);
                            const diff = reset - now;

                            if (diff > 0) {
                                const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                                const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));

                                if (days > 0) {
                                    const remainingHours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                                    if (remainingHours > 0) {
                                        resetCountdown = `${days}d ${remainingHours}h`;
                                    } else {
                                        resetCountdown = `${days} day${days > 1 ? 's' : ''}`;
                                    }
                                } else {
                                    resetCountdown = `${hours}h ${minutes}m`;
                                }
                            } else {
                                resetCountdown = 'Resetting soon';
                            }
                        }

                        let usageHtml = `
                            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                <div style="display: flex; flex-direction: column; gap: 0.25rem;">
                                    <div style="color: #949BA4; font-size: 0.85rem;">Messages sent</div>
                                    <div style="color: #dcddde; font-size: 0.95rem;">${messagesSent}</div>
                                </div>
                                <div style="display: flex; flex-direction: column; gap: 0.25rem;">
                                    <div style="color: #949BA4; font-size: 0.85rem;">Message limit</div>
                                    <div style="color: #dcddde; font-size: 0.95rem;">${planStatus.is_unlimited ? 'Unlimited' : planStatus.message_limit}</div>
                                </div>`;

                        // Only show reset countdown for allowance-based plans
                        if (planStatus.usage_type === 'allowance' && nextReset) {
                            usageHtml += `
                                <div style="display: flex; flex-direction: column; gap: 0.25rem;">
                                    <div style="color: #949BA4; font-size: 0.85rem;">Limit resets in${periodLabel ? ` (${periodLabel})` : ''}</div>
                                    <div style="color: #dcddde; font-size: 0.95rem;">${resetCountdown}</div>
                                </div>`;
                        }

                        usageHtml += `</div>`;
                        container.innerHTML = usageHtml;
                    } else {
                        container.innerHTML = '<div style="text-align: center; color: #949BA4;">No usage data available</div>';
                    }
                } catch (error) {
                    console.error('Error loading usage data:', error);
                    container.innerHTML = '<div style="color: #991a35;">Error loading usage data</div>';
                }
            }
        }

        let banConfirmed = false;
        let deleteConfirmed = false;

        async function handleBanUnban() {
            if (!currentUser) return;

            const banBtn = document.getElementById('ban-btn');
            const isBanned = currentUser.banned;

            if (isBanned) {
                // Unban action - no confirmation needed
                banBtn.textContent = 'Unbanning...';
                banBtn.disabled = true;
                try {
                    const response = await fetch(`/api/admin/unban/${currentUser.id}`, { method: 'POST', headers: { 'X-CSRF-Token': '{{ csrf_token }}' } });
                    const data = await response.json();

                    if (data.success) {
                        await showAlert('User unbanned successfully', 'Success');
                        await selectUser(currentUser.id, { currentTarget: document.querySelector('.user-item.selected') });
                        loadUsers();
                        banConfirmed = false;
                    } else {
                        await showAlert(data.error || 'Failed to unban user', 'Error');
                        banBtn.disabled = false;
                        banBtn.textContent = 'Unban user';
                    }
                } catch (error) {
                    console.error('Error unbanning user:', error);
                    await showAlert('Network error while unbanning user', 'Error');
                    banBtn.disabled = false;
                    banBtn.textContent = 'Unban user';
                }
            } else {
                // Ban action - needs confirmation
                if (!banConfirmed) {
                    const confirmation = await showConfirm('Are you sure you want to ban this user? They will not be able to use any panels or be added to teams.', 'Ban user', { danger: true, confirmText: 'Ban user' });
                    if (confirmation) {
                        banConfirmed = true;
                        banBtn.textContent = 'Confirm ban';
                        banBtn.classList.add('confirm-ban');
                    }
                } else {
                    banBtn.textContent = 'Banning...';
                    banBtn.disabled = true;

                    try {
                        const response = await fetch(`/api/admin/ban/${currentUser.id}`, { method: 'POST', headers: { 'X-CSRF-Token': '{{ csrf_token }}' } });
                        const data = await response.json();

                        if (data.success) {
                            await showAlert('User banned successfully', 'Success');
                            await selectUser(currentUser.id, { currentTarget: document.querySelector('.user-item.selected') });
                            loadUsers();
                            banConfirmed = false;
                        } else {
                            await showAlert(data.error || 'Failed to ban user', 'Error');
                            banBtn.disabled = false;
                            banBtn.textContent = 'Ban user';
                            banBtn.classList.remove('confirm-ban');
                            banConfirmed = false;
                        }
                    } catch (error) {
                        console.error('Error banning user:', error);
                        await showAlert('Network error while banning user', 'Error');
                        banBtn.disabled = false;
                        banBtn.textContent = 'Ban user';
                        banBtn.classList.remove('confirm-ban');
                        banConfirmed = false;
                    }
                }
            }
        }

        async function handleDelete() {
            if (!currentUser) return;

            const deleteBtn = document.getElementById('delete-btn');

            if (!deleteConfirmed) {
                const confirmation = await showConfirm('Are you sure you want to permanently delete this account? This action cannot be undone and will remove all user data.', 'Delete account', { danger: true, confirmText: 'Delete account' });
                if (confirmation) {
                    deleteConfirmed = true;
                    deleteBtn.textContent = 'Confirm Delete';
                    deleteBtn.classList.add('confirm-delete');
                }
            } else {
                deleteBtn.textContent = 'Deleting...';
                deleteBtn.disabled = true;

                try {
                    const response = await fetch(`/api/admin/delete/${currentUser.id}`, { method: 'POST', headers: { 'X-CSRF-Token': '{{ csrf_token }}' } });
                    const data = await response.json();

                    if (data.success) {
                        await showAlert('User deleted successfully', 'Success');
                        document.getElementById('user-details-panel').innerHTML = '<div class="admin-placeholder">Select a user to view details</div>';
                        currentUser = null;
                        loadUsers();
                        deleteConfirmed = false;
                    } else {
                        await showAlert(data.error || 'Failed to delete user', 'Error');
                        deleteBtn.disabled = false;
                        deleteBtn.textContent = 'Delete account';
                        deleteBtn.classList.remove('confirm-delete');
                        deleteConfirmed = false;
                    }
                } catch (error) {
                    console.error('Error deleting user:', error);
                    await showAlert('Network error while deleting user', 'Error');
                    deleteBtn.disabled = false;
                    deleteBtn.textContent = 'Delete account';
                    deleteBtn.classList.remove('confirm-delete');
                    deleteConfirmed = false;
                }
            }
        }

        async function viewFlagging() {
            if (!currentUser) return;
            if (!currentUser.flagged) return; // Only show if user is flagged

            const flagReason = currentUser.flag_reason || 'No reason provided';
            const reasonElement = document.getElementById('flagging-reason');
            reasonElement.style.whiteSpace = 'pre-wrap';

            // Helper function to escape HTML to prevent XSS
            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            // Parse the flag reason to format it nicely
            if (flagReason.includes('Prohibited content:')) {
                // Extract the prohibited words and message
                const lines = flagReason.split('\n');
                const prohibitedLine = lines[0]; // "Prohibited content: 'word1', 'word2'"
                const messageStart = flagReason.indexOf('Full message:');

                if (messageStart !== -1) {
                    let fullMessage = flagReason.substring(messageStart + 'Full message:'.length).trim();

                    // Extract just the words from the prohibited line
                    const wordsMatch = prohibitedLine.match(/Prohibited content: (.+)/);
                    const words = wordsMatch ? wordsMatch[1] : 'unknown';

                    // Escape HTML in the full message to prevent XSS
                    let escapedMessage = escapeHtml(fullMessage);

                    // Extract individual prohibited words from the list
                    const prohibitedWordsArray = words.match(/'([^']+)'/g);
                    if (prohibitedWordsArray) {
                        // Highlight each prohibited word in the message with yellow color
                        prohibitedWordsArray.forEach(wordWithQuotes => {
                            const word = wordWithQuotes.replace(/'/g, ''); // Remove quotes
                            const escapedWord = escapeHtml(word);
                            // Use case-insensitive regex with escaped word
                            const regex = new RegExp(`(${escapedWord.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
                            escapedMessage = escapedMessage.replace(regex, '<span style="color: #ffaa00; font-weight: 600;">$1</span>');
                        });
                    }

                    // Escape the words as well
                    const escapedWords = escapeHtml(words);

                    // Format nicely - now safe because we escaped everything
                    reasonElement.innerHTML = `<strong>Prohibited Words Used:</strong><br>${escapedWords}<br><br><strong>Full Message:</strong><br>${escapedMessage.replace(/\n/g, '<br>')}`;
                } else {
                    reasonElement.textContent = flagReason;
                }
            } else {
                reasonElement.textContent = flagReason;
            }

            document.getElementById('flagging-dialog').classList.add('active');
        }

        function closeFlaggingDialog() {
            document.getElementById('flagging-dialog').classList.remove('active');
        }

        async function confirmUnflag() {
            if (!currentUser) return;

            try {
                const response = await fetch(`/api/admin/unflag/${currentUser.id}`, { method: 'POST', headers: { 'X-CSRF-Token': '{{ csrf_token }}' } });
                const data = await response.json();

                if (data.success) {
                    closeFlaggingDialog();
                    await showAlert('User unflagged successfully', 'Success');
                    await selectUser(currentUser.id, { currentTarget: document.querySelector('.user-item.selected') });
                    loadUsers();
                }
            } catch (error) {
                console.error('Error unflagging user:', error);
                await showAlert('Error unflagging user: ' + error, 'Error');
            }
        }

        // Load users on page load (no filters = all users)
        // Call immediately since script is at end of body and DOM is ready
        loadUsers();
    </script>
</body>
</html>
