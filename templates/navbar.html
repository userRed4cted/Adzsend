<nav class="navbar">
    <div class="navbar-content">
        <div class="navbar-left">
            <a href="{{ url_for('home') }}" style="display: flex; align-items: center; gap: 12px; text-decoration: none;">
                <img src="/static/favicon.png" alt="Logo" style="width: 51px; height: 51px; display: block; object-fit: contain;" loading="eager">
                <h1 class="navbar-title">Ad <span class="gradient-z">Z</span> send</h1>
            </a>
        </div>
        <div class="nav-right">
            <!-- Navigation Links -->
            <nav class="nav-links">
                <a href="{{ url_for('home') }}" class="nav-link" data-page="home">Home</a>
                <a href="{{ url_for('purchase') }}" class="nav-link" data-page="purchase">Purchase</a>
                <a href="{{ url_for('discover') }}" class="nav-link" data-page="discover">Discover</a>
                <a href="{{ url_for('dashboard') if user else '#' }}" class="nav-link{% if not user %} disabled{% endif %}" data-page="dashboard"{% if not user %} onclick="return false;"{% endif %}>Dashboard</a>
                <a href="{{ url_for('bridge') if user else '#' }}" class="nav-link{% if not user %} disabled{% endif %}" data-page="bridge"{% if not user %} onclick="return false;"{% endif %}>Bridge</a>
                <a href="{{ url_for('support') }}" class="nav-link" data-page="support">Support</a>
            </nav>

            <!-- User Profile / Auth Buttons -->
            <div class="navbar-profile-container">
                {% if user %}
                <div class="navbar-profile-circle">
                    <img src="{{ url_for('static', filename='profile_photos/' ~ (user_data.profile_photo if user_data and user_data.profile_photo else 'Light_Blue.jpg')) }}" alt="Profile" class="user-profile-photo">
                </div>
                <span class="navbar-welcome-text" id="navbar-welcome-text">{{ welcome_slideshow.messages[0] }}</span>
                <img src="{{ url_for('static', filename='gear.png') }}" alt="Settings" title="Settings" class="navbar-settings-icon" onclick="openSettings()">
                {% else %}
                <a href="{{ url_for('signup_page') }}" class="navbar-auth-link">Sign up</a>
                <a href="{{ url_for('login_page') }}" class="navbar-auth-link">Login</a>
                {% endif %}
            </div>
        </div>
    </div>
</nav>

<script>
// Detect active page and mark navigation link
(function() {
    const currentPath = window.location.pathname;
    const navLinks = document.querySelectorAll('.nav-link');

    navLinks.forEach(link => {
        const page = link.getAttribute('data-page');

        // Check if current path matches this link
        let isActive = false;

        if (page === 'home' && (currentPath === '/' || currentPath === '/home')) {
            isActive = true;
        } else if (page === 'purchase' && currentPath.startsWith('/purchase')) {
            isActive = true;
        } else if (page === 'discover' && currentPath.startsWith('/discover')) {
            isActive = true;
        } else if (page === 'dashboard' && currentPath.startsWith('/dashboard')) {
            isActive = true;
        } else if (page === 'bridge' && currentPath.startsWith('/bridge')) {
            isActive = true;
        } else if (page === 'support' && currentPath.startsWith('/support')) {
            isActive = true;
        }

        if (isActive) {
            link.classList.add('active');
        }
    });
})();

// Logo retry on fail - retry every 100ms until loads
(function() {
    const logoImg = document.querySelector('.navbar-left img[src*="favicon.png"]');
    if (logoImg) {
        let retryCount = 0;
        const maxRetries = 100; // Stop after 10 seconds (100 * 100ms)

        logoImg.addEventListener('error', function retryLoad() {
            if (retryCount >= maxRetries) return;
            retryCount++;

            setTimeout(() => {
                const currentSrc = logoImg.src.split('?')[0]; // Remove old retry param
                logoImg.src = '';
                logoImg.src = currentSrc + '?retry=' + Date.now();
            }, 100);
        });
    }
})();

// Welcome text slideshow - uses setInterval with requestAnimationFrame fallback
{% if user %}
(function() {
    const welcomeText = document.getElementById('navbar-welcome-text');
    if (!welcomeText) return;

    const messages = {{ welcome_slideshow.messages | tojson }};
    const interval = {{ welcome_slideshow.interval }};
    const fadeDuration = {{ welcome_slideshow.fade_duration }};
    let currentIndex = 0;

    // Add CSS transition dynamically
    welcomeText.style.transition = `opacity ${fadeDuration}ms ease`;

    // Auto-scale text to fit container
    function scaleTextToFit() {
        const container = welcomeText.parentElement;
        const maxWidth = 80; // Max width in pixels for the text
        let fontSize = parseFloat(window.getComputedStyle(welcomeText).fontSize);

        // Reset to default size first
        welcomeText.style.fontSize = '0.9rem';

        // Check if text overflows
        if (welcomeText.scrollWidth > maxWidth) {
            // Reduce font size until it fits
            while (welcomeText.scrollWidth > maxWidth && fontSize > 8) {
                fontSize -= 0.5;
                welcomeText.style.fontSize = fontSize + 'px';
            }
        }
    }

    function changeSlide() {
        // Fade out
        welcomeText.style.opacity = '0';

        setTimeout(() => {
            // Change text
            currentIndex = (currentIndex + 1) % messages.length;
            welcomeText.textContent = messages[currentIndex];

            // Auto-scale to fit
            scaleTextToFit();

            // Fade in
            welcomeText.style.opacity = '1';
        }, fadeDuration);
    }

    // Initial scale check
    scaleTextToFit();

    // Use setInterval for consistent timing
    setInterval(changeSlide, interval);

    // Re-scale on window resize
    window.addEventListener('resize', scaleTextToFit);
})();
{% endif %}
</script>
