<!-- Settings Popup -->
<script>
    window.userDateFormat = '{{ user_data.date_format if user_data and user_data.date_format else "mm/dd/yy" }}';
    window.csrfToken = '{{ csrf_token }}';
</script>
<div class="settings-popup-overlay" id="settings-popup-overlay">
    <div class="settings-popup">
        <!-- Settings Side Menu -->
        <div class="settings-side-menu">
            <!-- Profile Section -->
            <div class="settings-profile-section">
                <div style="width: 32px; height: 32px; border-radius: 50%; overflow: hidden; flex-shrink: 0;">
                    <img src="{{ url_for('static', filename='profile_photos/' ~ (user_data.profile_photo if user_data and user_data.profile_photo else 'Light_Blue.jpg')) }}" alt="Profile" style="width: 100%; height: 100%; object-fit: cover;" class="user-profile-photo">
                </div>
                <span style="color: #dcddde; font-size: 0.9rem;">Welcome!</span>
            </div>
            <div class="settings-menu-divider"></div>
            <div class="settings-menu-section">
                <div class="settings-menu-category">Account</div>
                <button class="settings-menu-item active" data-settings-page="my-account">My account</button>
                <button class="settings-menu-item" data-settings-page="discord-accounts">Discord accounts</button>
            </div>
            <div class="settings-menu-divider"></div>
            <div class="settings-menu-section">
                <div class="settings-menu-category">Dashboard</div>
                <button class="settings-menu-item" data-settings-page="teams">Teams</button>
                <button class="settings-menu-item" data-settings-page="interval">Interval</button>
                <button class="settings-menu-item" data-settings-page="bridge">Bridge</button>
            </div>
            <div class="settings-menu-divider"></div>
            <div class="settings-menu-section">
                <div class="settings-menu-category">Payment</div>
                <button class="settings-menu-item" data-settings-page="billing">Billing</button>
                <button class="settings-menu-item" data-settings-page="usage">Usage</button>
            </div>
            <div class="settings-menu-divider"></div>
            <div class="settings-menu-section">
                <div class="settings-menu-category">Website</div>
                <button class="settings-menu-item" data-settings-page="appearance">Appearance</button>
                <button class="settings-menu-item" data-settings-page="date-format">Date format</button>
            </div>
            <div class="settings-menu-divider"></div>
            <button class="settings-logout-btn" onclick="event.stopPropagation(); window.location.href='{{ url_for('logout') }}';">Logout</button>
        </div>
        <!-- Settings Content -->
        <div class="settings-content">
            <div class="settings-content-header">
                <span class="settings-content-title" id="settings-content-title">My account</span>
                <button class="settings-close-btn" onclick="closeSettingsPopup()">&times;</button>
            </div>
            <div class="settings-content-divider"></div>
            <div class="settings-content-body" id="settings-content-body">
                <!-- Interval Page -->
                <div class="settings-page" id="settings-page-interval" style="display: none;">
                    <div class="settings-subheader">Interval</div>
                    <div class="settings-text">Change the rate at which messages send in Discord, recommended to be kept at 2 seconds.</div>

                    <div class="interval-slider-container">
                        <div class="interval-slider-track">
                            <div class="interval-slider-fill" id="interval-slider-fill"></div>
                            <div class="interval-slider-tick" style="left: 0%;"></div>
                            <div class="interval-slider-tick" style="left: 25%;"></div>
                            <div class="interval-slider-tick" style="left: 50%;"></div>
                            <div class="interval-slider-tick" style="left: 75%;"></div>
                            <div class="interval-slider-tick" style="left: 100%;"></div>
                            <div class="interval-slider-thumb" id="interval-slider-thumb"></div>
                        </div>
                        <div class="interval-slider-labels">
                            <span data-value="0" class="disabled-delay-option" style="opacity: 0.5; pointer-events: none; cursor: default;">No delay</span>
                            <span data-value="1000">1 second</span>
                            <span data-value="2000">2 seconds</span>
                            <span data-value="5000">5 seconds</span>
                            <span data-value="10000">10 seconds</span>
                        </div>
                    </div>
                </div>

                <!-- Date Format Page -->
                <div class="settings-page" id="settings-page-date-format" style="display: none;">
                    <div class="settings-subheader">Date format</div>
                    <div class="settings-text">Change the websites formatting of dates to match your prefference.</div>

                    <div class="time-format-options">
                        <label class="time-format-option">
                            <input type="radio" name="date-format" value="mm/dd/yy" checked>
                            <span>mm/dd/yy</span>
                        </label>
                        <label class="time-format-option">
                            <input type="radio" name="date-format" value="dd/mm/yy">
                            <span>dd/mm/yy</span>
                        </label>
                        <label class="time-format-option">
                            <input type="radio" name="date-format" value="yy/mm/dd">
                            <span>yy/mm/dd</span>
                        </label>
                    </div>
                </div>

                <!-- Usage Page -->
                <div class="settings-page" id="settings-page-usage" style="display: none;">
                    <!-- Personal Usage Section -->
                    <div class="settings-subheader">Personal usage</div>
                    <div class="settings-text">Track your plans usage use, across all panels.</div>

                    <div class="usage-stats-container" id="personal-usage-stats">
                        <div class="usage-stat-row">
                            <span class="usage-stat-label">Allowance{% if plan_status and plan_status.has_plan and plan_status.usage_type == 'allowance' %} (per {% if plan_status.allowance_period == 'weekly' %}week{% elif plan_status.allowance_period == 'monthly' %}month{% elif plan_status.allowance_period == 'daily' %}day{% endif %}){% elif plan_status and plan_status.has_plan and plan_status.usage_type == 'amount' %} (total){% endif %}</span>
                            <span class="usage-stat-value">{% if plan_status and plan_status.is_unlimited %}inf{% elif plan_status and plan_status.has_plan %}{{ plan_status.message_limit }}{% endif %}</span>
                        </div>
                        <div class="usage-stat-row">
                            <span class="usage-stat-label">Advertisements sent (current cycle)</span>
                            <span class="usage-stat-value">{% if plan_status and plan_status.has_plan %}{{ plan_status.messages_sent }}{% endif %}</span>
                        </div>
                        <div class="usage-stat-row" style="flex-direction: column; align-items: stretch;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                <span class="usage-stat-label">Usage percentage</span>
                                <span class="usage-stat-value">{% if plan_status and plan_status.is_unlimited %}0%{% elif plan_status and plan_status.has_plan and plan_status.message_limit > 0 %}{{ ((plan_status.messages_sent / plan_status.message_limit) * 100)|round(0)|int }}%{% endif %}</span>
                            </div>
                            <div class="usage-progress-bar">
                                <div class="usage-progress-fill" style="width: {% if plan_status and plan_status.is_unlimited %}0{% elif plan_status and plan_status.has_plan and plan_status.message_limit > 0 %}{{ ((plan_status.messages_sent / plan_status.message_limit) * 100)|round(0)|int }}{% else %}0{% endif %}%;"></div>
                            </div>
                        </div>
                        <div class="usage-stat-row">
                            <span class="usage-stat-label">Limit resets in</span>
                            <span class="usage-stat-value" id="personal-reset-countdown" data-reset-time="{% if plan_status and plan_status.has_plan and plan_status.usage_type == 'allowance' and plan_status.next_reset %}{{ plan_status.next_reset }}{% endif %}">{% if plan_status and plan_status.has_plan and plan_status.usage_type == 'allowance' and plan_status.next_reset %}Calculating...{% endif %}</span>
                        </div>
                    </div>

                    <!-- Team Usage Section -->
                    <div class="settings-subheader" style="margin-top: 2rem;">Team usage</div>
                    <div class="settings-text">Track your team plans usage use, across all members on the team panel.</div>

                    <div class="usage-stats-container" id="team-usage-stats">
                        <div class="usage-stat-row">
                            <span class="usage-stat-label">Allowance{% if business_plan_status and business_plan_status.usage_type == 'allowance' %} (per {% if business_plan_status.allowance_period == 'weekly' %}week{% elif business_plan_status.allowance_period == 'monthly' %}month{% elif business_plan_status.allowance_period == 'daily' %}day{% endif %}){% elif business_plan_status and business_plan_status.usage_type == 'amount' %} (total){% endif %}</span>
                            <span class="usage-stat-value">{% if business_plan_status and business_plan_status.is_unlimited %}inf{% elif business_plan_status %}{{ business_plan_status.message_limit }}{% endif %}</span>
                        </div>
                        <div class="usage-stat-row">
                            <span class="usage-stat-label">Advertisements sent (current cycle)</span>
                            <span class="usage-stat-value">{% if business_plan_status %}{{ business_plan_status.messages_sent }}{% endif %}</span>
                        </div>
                        <div class="usage-stat-row" style="flex-direction: column; align-items: stretch;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                <span class="usage-stat-label">Usage percentage</span>
                                <span class="usage-stat-value">{% if business_plan_status and business_plan_status.is_unlimited %}0%{% elif business_plan_status and business_plan_status.message_limit > 0 %}{{ ((business_plan_status.messages_sent / business_plan_status.message_limit) * 100)|round(0)|int }}%{% endif %}</span>
                            </div>
                            <div class="usage-progress-bar">
                                <div class="usage-progress-fill" style="width: {% if business_plan_status and business_plan_status.is_unlimited %}0{% elif business_plan_status and business_plan_status.message_limit > 0 %}{{ ((business_plan_status.messages_sent / business_plan_status.message_limit) * 100)|round(0)|int }}{% else %}0{% endif %}%;"></div>
                            </div>
                        </div>
                        <div class="usage-stat-row">
                            <span class="usage-stat-label">Limit resets in</span>
                            <span class="usage-stat-value" id="team-reset-countdown" data-reset-time="{% if business_plan_status and business_plan_status.usage_type == 'allowance' and business_plan_status.next_reset %}{{ business_plan_status.next_reset }}{% endif %}">{% if business_plan_status and business_plan_status.usage_type == 'allowance' and business_plan_status.next_reset %}Calculating...{% endif %}</span>
                        </div>
                    </div>
                </div>

                <!-- Teams Page -->
                <div class="settings-page" id="settings-page-teams" style="display: none; position: relative;">
                    <!-- Loading overlay - shows in center until everything loads -->
                    <div id="teams-loading" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; z-index: 10;">
                        <div class="loading-dots"><span class="dot"></span><span class="dot"></span><span class="dot"></span></div>
                    </div>

                    <!-- Content - hidden until loaded -->
                    <div id="teams-content" style="opacity: 0; pointer-events: none;">
                        <!-- Team Invites Section -->
                        <div class="settings-subheader">Team invites</div>
                        <div class="settings-text">Accept or deny team join requests.</div>

                        <div class="team-invitations-box" id="team-invitations-box">
                            <div id="team-invitations-list">
                            </div>
                        </div>

                        <!-- Manage Teams Section -->
                        <div class="settings-subheader" style="margin-top: 2rem;">Manage teams</div>
                        <div class="settings-text">Manage what teams your appart of.</div>

                        <div class="team-current-box" id="team-current-box">
                            <div class="team-current-profile">
                                <div class="team-current-avatar" id="team-current-avatar"></div>
                                <div class="team-current-info">
                                    <span class="team-current-id" id="team-current-id">None</span>
                                    <div class="team-owner-crown" id="team-owner-crown" style="display: none;" title="Team owner">
                                        <img src="{{ url_for('static', filename='OwnerDiscordCrown.png') }}" alt="Owner">
                                    </div>
                                </div>
                                <button class="team-leave-btn" id="team-leave-btn" disabled>Leave</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- My Account Page -->
                <div class="settings-page" id="settings-page-my-account" style="display: flex;">
                    <div class="settings-subheader">Account</div>
                    <div class="settings-text">Review and edit account information.</div>

                    <div class="account-box">
                        <div class="account-profile-photo-container">
                            <div class="account-profile-photo" id="account-profile-photo" title="Change profile photo">
                                <img src="{{ url_for('static', filename='profile_photos/' ~ (user_data.profile_photo if user_data and user_data.profile_photo else 'Light_Blue.jpg')) }}" alt="Profile" class="user-profile-photo">
                            </div>
                        </div>
                        <div class="account-info-rows">
                            <div class="account-info-row">
                                <span class="account-info-label">Adzsend ID</span>
                                <div class="account-info-value-container">
                                    <span class="account-info-value" id="account-adzsend-id">{{ user.adzsend_id if user and user.adzsend_id else 'Not set' }}</span>
                                </div>
                            </div>
                            <div class="account-info-row">
                                <span class="account-info-label">Email</span>
                                <div class="account-info-value-container">
                                    <span class="account-info-value" id="account-email">{{ user.email if user and user.email else 'Not set' }}</span>
                                    <button class="account-edit-btn" id="account-edit-email">Edit</button>
                                </div>
                            </div>
                            <div class="account-info-row">
                                <span class="account-info-label">Signup date (<span id="signup-date-format">{{ user_data.date_format if user_data and user_data.date_format else 'mm/dd/yy' }}</span>)</span>
                                <div class="account-info-value-container">
                                    <span class="account-info-value" id="account-signup-date">{{ user.signup_date if user and user.signup_date else 'Not set' }}</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Standing Section -->
                    <div class="settings-subheader" style="margin-top: 2rem;">Standing</div>
                    <div class="settings-text">Thanks for upholding the Adzsend <a href="/terms" class="navbar-auth-link">Terms of Service</a> and <a href="/guidelines" class="navbar-auth-link">Community Guidelines</a>. If you break the rules, it will show up here.</div>

                    <div class="standing-bar">
                        <div class="standing-step {% if db_user and db_user.banned %}{% elif db_user and db_user.flagged %}{% else %}active{% endif %}">
                            <div class="standing-circle">
                                {% if db_user and not db_user.banned and not db_user.flagged %}
                                <img src="{{ url_for('static', filename='tick.png') }}" alt="All good" class="standing-icon">
                                {% endif %}
                            </div>
                            <span class="standing-label">All&nbsp;good!</span>
                        </div>
                        <div class="standing-line"></div>
                        <div class="standing-step {% if db_user and db_user.flagged and not db_user.banned %}active{% endif %}">
                            <div class="standing-circle">
                                {% if db_user and db_user.flagged and not db_user.banned %}
                                <img src="{{ url_for('static', filename='flag.png') }}" alt="Flagged" class="standing-icon">
                                {% endif %}
                            </div>
                            <span class="standing-label">Flagged</span>
                        </div>
                        <div class="standing-line"></div>
                        <div class="standing-step {% if db_user and db_user.banned %}active{% endif %}">
                            <div class="standing-circle">
                                {% if db_user and db_user.banned %}
                                <img src="{{ url_for('static', filename='x.png') }}" alt="Suspended" class="standing-icon">
                                {% endif %}
                            </div>
                            <span class="standing-label">Suspended</span>
                        </div>
                    </div>

                    <!-- Delete Account Section -->
                    <div class="settings-subheader" style="margin-top: 2rem;">Delete account</div>
                    <div class="settings-text">Delete your Adzsend account, erase all data and purchases on your account. Irreversable.</div>

                    <button class="delete-account-btn" onclick="openDeleteAccountPopup()">Delete account</button>
                </div>

                <!-- Discord Accounts Page -->
                <div class="settings-page" id="settings-page-discord-accounts" style="display: none; position: relative;">
                    <!-- Loading overlay - shows in center until everything loads -->
                    <div id="discord-accounts-loading" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; z-index: 10;">
                        <div class="loading-dots"><span class="dot"></span><span class="dot"></span><span class="dot"></span></div>
                    </div>

                    <!-- Content - hidden until loaded -->
                    <div id="discord-accounts-content" style="opacity: 0; pointer-events: none;">
                        <div class="settings-subheader">Linked Discord accounts</div>
                        <div class="settings-text">Manage linked Discord accounts to send messages via them in the panel.</div>

                        <!-- Search Bar -->
                        <div style="margin-top: 1rem; margin-bottom: 0.5rem;">
                            <input type="text" class="search-input" placeholder="Search" id="discord-accounts-search-input" style="width: 100%;">
                        </div>
                        <div class="settings-text" style="margin-bottom: 1rem;">We recommend using alternate Discord accounts, build an account history before using.</div>

                        <!-- List View Container -->
                        <div id="discord-accounts-list-view" style="display: block;">
                        </div>
                    </div>
                </div>

                <!-- Bridge Page -->
                <div class="settings-page" id="settings-page-bridge" style="display: none;">
                    <!-- Secret Key Section -->
                    <div class="settings-subheader">Secret key</div>
                    <div class="settings-text">Your secret key is used to authenticate Adzsend Bridge with your account. Keep it private.</div>

                    <div class="bridge-key-container">
                        <div class="bridge-key-box">
                            <input type="password" class="bridge-key-input" id="bridge-secret-key" readonly value="Loading...">
                        </div>
                        <div class="bridge-key-text-actions">
                            <button class="bridge-key-text-btn" id="bridge-copy-key">Copy</button>
                            <button class="bridge-key-text-btn" id="bridge-toggle-key">Show</button>
                            <button class="bridge-key-text-btn" id="bridge-regenerate-key">Regenerate</button>
                        </div>
                    </div>

                    <!-- Bridge Status Section -->
                    <div class="settings-subheader" style="margin-top: 2rem;">Bridge status</div>
                    <div class="settings-text">Current connection status of your <a href="/bridge" class="bridge-link">Adzsend Bridge</a>.</div>

                    <div class="bridge-status-container">
                        <div class="bridge-status-indicator">
                            <span class="bridge-status-dot" id="bridge-status-dot"></span>
                            <span class="bridge-status-text" id="bridge-status-text">Offline</span>
                        </div>
                    </div>
                </div>

                <!-- Appearance Page -->
                <div class="settings-page" id="settings-page-appearance" style="display: none;">
                    <div class="settings-subheader">Coming soon...</div>
                    <div class="settings-text">Coming soon...</div>
                </div>

                <!-- Billing Page -->
                <div class="settings-page" id="settings-page-billing" style="display: none;">
                    <!-- Plan Information Section -->
                    <div class="settings-subheader">Plan information</div>
                    <div class="settings-text-with-action">
                        <span>View billing information about your plan.</span>
                        <button class="billing-adjust-plan-btn" id="billing-adjust-plan-btn">Adjust plan</button>
                    </div>

                    <div class="usage-stats-container" id="billing-plan-info">
                        <div class="usage-stat-row">
                            <span class="usage-stat-label">Current plan</span>
                            <span class="usage-stat-value">{% if plan_status and plan_status.has_plan %}{{ plan_status.plan_name }}{% elif plan_status %}Free{% endif %}</span>
                        </div>
                        <div class="usage-stat-row">
                            <span class="usage-stat-label">Billing period</span>
                            <span class="usage-stat-value">{% if plan_status and plan_status.has_plan and plan_status.plan_type == 'subscription' and plan_status.plan_id != 'plan_free' %}{{ plan_status.billing_period|capitalize }}{% endif %}</span>
                        </div>
                        <div class="usage-stat-row">
                            <span class="usage-stat-label">Plan started <span class="date-format-label" data-label-template="(%FORMAT%)">{% if plan_status %}({{ plan_status.date_format or 'mm/dd/yy' }}){% endif %}</span></span>
                            <span class="usage-stat-value">{% if plan_status and plan_status.has_plan and plan_status.plan_id != 'plan_free' %}{{ plan_status.started_at|format_date }}{% endif %}</span>
                        </div>
                        <div class="usage-stat-row">
                            <span class="usage-stat-label">Next billing date <span class="date-format-label" data-label-template="(%FORMAT%)">{% if plan_status %}({{ plan_status.date_format or 'mm/dd/yy' }}){% endif %}</span></span>
                            <span class="usage-stat-value">{% if plan_status and plan_status.has_plan and plan_status.expires_at and plan_status.plan_id != 'plan_free' %}{{ plan_status.expires_at|format_date }}{% endif %}</span>
                        </div>
                    </div>

                    <!-- Invoices Section -->
                    <div class="settings-subheader" style="margin-top: 2rem;">Invoices</div>
                    <div class="settings-text">View your accounts billing/payment history.</div>

                    <div class="billing-invoices-box" id="billing-invoices-box">
                        <!-- Column Headers -->
                        <div class="billing-invoices-header">
                            <span class="billing-invoice-col-date">Date <span class="date-format-label" data-label-template="(%FORMAT%)">(mm/dd/yy)</span></span>
                            <span class="billing-invoice-col-total">Total</span>
                            <span class="billing-invoice-col-actions">Actions</span>
                        </div>
                        <!-- Invoices List -->
                        <div id="billing-invoices-list">
                            {% if purchase_history and purchase_history|length > 0 %}
                                {% for invoice in purchase_history %}
                                <div class="billing-invoice-item">
                                    <span class="billing-invoice-col-date billing-invoice-date" data-date="{{ invoice.start_date }}"></span>
                                    <span class="billing-invoice-col-total">${{ invoice.price }}</span>
                                    <span class="billing-invoice-col-actions">
                                        <button class="billing-invoice-view-btn" data-invoice-id="{{ invoice.id }}">View</button>
                                    </span>
                                </div>
                                {% endfor %}
                            {% else %}
                                <div class="billing-no-invoices">No invoices</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Profile Photo Picker now uses custom popup system -->

<style>
    /* Font declarations for settings popup */
    @font-face {
        font-family: 'gg sans Bold';
        src: url('/static/fonts/gg sans Bold.ttf') format('truetype');
        font-style: normal;
    }

    /* Settings Popup Styles */
    .settings-popup-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        z-index: 2000;
        justify-content: center;
        align-items: center;
    }

    .settings-popup-overlay.show {
        display: flex;
    }

    .settings-popup {
        height: 90vh;
        width: calc(90vh + 200px);
        max-width: 95vw;
        max-height: 95vh;
        background: #121215;
        border-radius: 8px;
        border: 1px solid #222225;
        display: flex;
        overflow: hidden;
    }

    .settings-side-menu {
        width: 200px;
        background: #1A1A1E;
        border-right: 1px solid #222225;
        display: flex;
        flex-direction: column;
        padding: 1rem;
        gap: 0.5rem;
        flex-shrink: 0;
    }

    .settings-profile-section {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 0.5rem 0;
    }

    .settings-menu-section {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }

    .settings-menu-category {
        color: #81828A;
        font-size: 0.7rem;
        font-family: 'gg sans Semibold', sans-serif;
        letter-spacing: 0.5px;
        padding: 0.25rem 0.75rem;
        margin-top: 0.25rem;
    }

    .settings-menu-item {
        display: flex;
        align-items: center;
        padding: 0.375rem 0.75rem;
        border-radius: 6px;
        color: #dcddde;
        font-size: 0.9rem;
        font-family: 'gg sans Medium', sans-serif;
        cursor: pointer;
        background: transparent;
        border: none;
        width: 100%;
        text-align: left;
    }


    .settings-menu-item.active {
        background: linear-gradient(to bottom, #15d8bc, #006e59);
        color: #121215;
    }

    .settings-menu-divider {
        height: 1px;
        background: #222225;
        margin: 0.5rem 0;
    }

    .settings-logout-btn {
        display: flex;
        align-items: center;
        padding: 0.375rem 0.75rem;
        border-radius: 6px;
        color: #991a35;
        font-size: 0.9rem;
        font-family: 'gg sans Medium', sans-serif;
        cursor: pointer;
        background: transparent;
        border: none;
        width: 100%;
        text-align: left;
    }

    .settings-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        min-width: 0;
        background: #121215;
    }

    .settings-content-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.45rem 0.9rem;
    }

    .settings-content-title {
        color: #dcddde;
        font-size: 0.792rem;
        font-family: 'gg sans Bold', sans-serif !important;
    }

    .settings-close-btn {
        background: transparent;
        border: 1px solid transparent;
        color: #81828A;
        font-size: 1.5rem;
        cursor: pointer;
        padding: 0.25rem;
        line-height: 1;
        border-radius: 4px;
        transition: all 0.2s ease;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .settings-close-btn:hover {
        background: #1A1A1E;
        border-color: #222225;
        color: white;
    }


    .settings-content-divider {
        height: 1px;
        background: #222225;
        margin: 0;
    }

    .settings-content-body {
        flex: 1;
        padding: 80px 140px 40px 140px;
        overflow-y: auto;
        background: #121215;
        display: flex;
        justify-content: center;
    }

    /* Settings Page Content Styles */
    .settings-page {
        display: flex;
        flex-direction: column;
        width: 100%;
        max-width: 800px;
    }

    .settings-subheader {
        color: #dcddde;
        font-size: 0.85rem;
        font-family: 'gg sans Semibold', sans-serif;
        margin-bottom: 0.5rem;
    }

    .settings-text {
        color: #81828A;
        font-size: 0.8925rem;
        font-family: 'gg sans Medium', sans-serif;
        margin-bottom: 1.5rem;
    }

    /* Interval Slider Styles */
    .interval-slider-container {
        width: 100%;
        padding: 0 0.5rem;
    }

    .interval-slider-track {
        position: relative;
        width: 100%;
        height: 4px;
        background: #222225;
        border-radius: 2px;
        cursor: pointer;
    }

    .interval-slider-fill {
        position: absolute;
        left: 0;
        top: 0;
        height: 100%;
        background: linear-gradient(to right, #15d8bc, #006e59);
        border-radius: 2px;
        pointer-events: none;
    }

    .interval-slider-thumb {
        position: absolute;
        top: 50%;
        transform: translate(-50%, -50%);
        width: 14px;
        height: 14px;
        background: #dcddde;
        border-radius: 50%;
        cursor: grab;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    .interval-slider-thumb:active {
        cursor: grabbing;
    }

    .interval-slider-tick {
        position: absolute;
        top: 50%;
        transform: translate(-50%, -50%);
        width: 2px;
        height: 12px;
        background: #dcddde;
        pointer-events: none;
    }

    .interval-slider-labels {
        display: flex;
        justify-content: space-between;
        margin-top: 1rem;
        user-select: none;
        position: relative;
        height: 1.5rem;
    }

    .interval-slider-labels span {
        color: #dcddde;
        font-size: 0.8925rem;
        font-family: 'gg sans Medium', sans-serif;
        cursor: pointer;
        text-align: center;
        position: absolute;
        transform: translateX(-50%);
        white-space: nowrap;
    }

    .interval-slider-labels span:nth-child(1) {
        left: 0%;
    }

    .interval-slider-labels span:nth-child(2) {
        left: 25%;
    }

    .interval-slider-labels span:nth-child(3) {
        left: 50%;
    }

    .interval-slider-labels span:nth-child(4) {
        left: 75%;
    }

    .interval-slider-labels span:nth-child(5) {
        left: 100%;
    }

    /* Time Format Radio Button Styles */
    .time-format-options {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .time-format-option {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        cursor: pointer;
    }

    .time-format-option input[type="radio"] {
        appearance: none;
        -webkit-appearance: none;
        width: 18px;
        height: 18px;
        border: 2px solid #15d8bc;
        border-radius: 50%;
        background: transparent;
        cursor: pointer;
        position: relative;
        flex-shrink: 0;
    }

    .time-format-option input[type="radio"]:checked {
        background: #15d8bc;
        border-color: #15d8bc;
    }

    .time-format-option input[type="radio"]:checked::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 6px;
        height: 6px;
        background: #fff;
        border-radius: 50%;
    }

    .time-format-option span {
        color: #dcddde;
        font-size: 0.8925rem;
        font-family: 'gg sans Medium', sans-serif;
    }

    /* Usage Stats Styles */
    .usage-stats-container {
        display: flex;
        flex-direction: column;
    }

    .usage-stat-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem 0;
        border-bottom: 1px solid #282930;
    }

    .usage-stat-row:last-child {
        border-bottom: none;
    }

    .usage-stat-label {
        color: #81828A;
        font-size: 0.8925rem;
        font-family: 'gg sans Medium', sans-serif;
    }

    .usage-stat-value {
        color: #dcddde;
        font-size: 0.8925rem;
        font-family: 'gg sans Semibold', sans-serif;
    }

    .usage-progress-bar {
        width: 100%;
        height: 8px;
        background: #282930;
        border-radius: 4px;
        overflow: hidden;
    }

    .usage-progress-fill {
        height: 100%;
        background: linear-gradient(to right, #15d8bc, #006e59);
        border-radius: 4px;
        transition: width 0.3s ease;
    }

    /* Teams Page Styles */
    .team-invitations-box {
        background: #1A1A1E;
        border: 1px solid #222225;
        border-radius: 8px;
        padding: 0.75rem;
        max-height: 300px;
        overflow-y: auto;
    }

    .team-no-invitations {
        color: #81828A;
        font-size: 0.8925rem;
        font-family: 'gg sans Medium', sans-serif;
        text-align: center;
        padding: 1rem;
    }

    .team-invitation-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem;
        border-radius: 6px;
        background: #121215;
        border: 1px solid #222225;
        margin-bottom: 0.5rem;
    }

    .team-invitation-item:last-child {
        margin-bottom: 0;
    }

    .team-invitation-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        overflow: hidden;
        flex-shrink: 0;
    }

    .team-invitation-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .team-invitation-id {
        flex: 1;
        color: #dcddde;
        font-size: 0.8925rem;
        font-family: 'gg sans Medium', sans-serif;
    }

    .team-invitation-actions {
        display: flex;
        gap: 0.5rem;
    }

    .team-invitation-accept,
    .team-invitation-deny {
        width: 32px;
        height: 32px;
        background: transparent;
        border: 1px solid transparent;
        border-radius: 4px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
    }

    .team-invitation-accept img {
        width: 16px;
        height: 16px;
        filter: brightness(0) saturate(100%) invert(55%) sepia(5%) saturate(368%) hue-rotate(195deg) brightness(93%) contrast(89%);
        transition: filter 0.2s ease;
        pointer-events: none;
    }

    .team-invitation-deny img {
        width: 16px;
        height: 16px;
        filter: brightness(0) saturate(100%) invert(55%) sepia(5%) saturate(368%) hue-rotate(195deg) brightness(93%) contrast(89%);
        transition: filter 0.2s ease;
        pointer-events: none;
    }

    .team-invitation-accept:hover,
    .team-invitation-deny:hover {
        background: #1A1A1E;
        border-color: #222225;
    }

    .team-invitation-accept:hover img,
    .team-invitation-deny:hover img {
        filter: brightness(0) saturate(100%) invert(100%);
    }

    .team-current-box {
        border: 1px solid #222225;
        border-radius: 8px;
        padding: 0.75rem;
    }

    .team-current-profile {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .team-current-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: #1A1A1E;
        overflow: hidden;
        flex-shrink: 0;
    }

    .team-current-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .team-current-info {
        flex: 1;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .team-current-id {
        color: #dcddde;
        font-size: 0.8925rem;
        font-family: 'gg sans Medium', sans-serif;
    }

    .team-leave-btn {
        background: transparent;
        border: none;
        color: #991a35;
        padding: 0.5rem 1rem;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.85rem;
        font-weight: 500;
        transition: color 0.2s ease;
        flex-shrink: 0;
    }

    .team-leave-btn:hover:not(:disabled) {
        color: #7a1529;
    }

    .team-leave-btn:disabled {
        color: #991a35;
        cursor: not-allowed;
        opacity: 0.5;
    }

    .team-owner-crown {
        display: none;
        align-items: center;
        justify-content: center;
    }

    .team-owner-crown img {
        width: 18px;
        height: 18px;
    }

    /* Billing Page Styles */
    .settings-text-with-action {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
    }

    .settings-text-with-action span {
        color: #81828A;
        font-size: 0.8925rem;
        font-family: 'gg sans Medium', sans-serif;
    }

    .billing-adjust-plan-btn {
        background: transparent;
        border: none;
        color: #15d8bc;
        padding: 0;
        cursor: pointer;
        font-size: 0.85rem;
        font-family: 'gg sans Medium', sans-serif;
        transition: color 0.2s ease;
        flex-shrink: 0;
    }

    .billing-adjust-plan-btn:hover {
        color: #10b89e;
    }

    .billing-invoices-box {
        background: #1A1A1E;
        border: 1px solid #222225;
        border-radius: 8px;
        max-height: 300px;
        overflow-y: auto;
    }

    .billing-invoices-header {
        display: flex;
        padding: 0.75rem;
        border-bottom: 1px solid #282930;
        color: #81828A;
        font-size: 0.8rem;
        font-family: 'gg sans Medium', sans-serif;
    }

    .billing-invoice-col-date {
        flex: 1.5;
    }

    .billing-invoice-col-total {
        flex: 1;
    }

    .billing-invoice-col-actions {
        flex: 0.8;
        text-align: right;
    }

    .billing-invoice-item {
        display: flex;
        align-items: center;
        padding: 0.75rem;
        border-bottom: 1px solid #282930;
        color: #dcddde;
        font-size: 0.8925rem;
        font-family: 'gg sans Medium', sans-serif;
    }

    .billing-invoice-item:last-child {
        border-bottom: none;
    }

    .billing-no-invoices {
        color: #81828A;
        font-size: 0.8925rem;
        font-family: 'gg sans Medium', sans-serif;
        text-align: center;
        padding: 1rem;
    }

    .billing-invoice-view-btn {
        background: transparent;
        border: none;
        color: #15d8bc;
        padding: 0.5rem 1rem;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.85rem;
        font-weight: 500;
        transition: color 0.2s ease;
    }

    .billing-invoice-view-btn:hover {
        color: #10b89e;
    }

    /* My Account Page Styles */
    .account-box {
        background: #1A1A1E;
        border: 1px solid #222225;
        border-radius: 8px;
        padding: 0.75rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        aspect-ratio: 1 / 0.475;
    }

    .account-profile-photo-container {
        margin-bottom: 0.75rem;
    }

    .account-profile-photo {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        cursor: pointer;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: opacity 0.2s ease;
    }

    .account-profile-photo:hover {
        opacity: 0.7;
    }

    .account-profile-photo img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .account-info-rows {
        width: 100%;
        display: flex;
        flex-direction: column;
    }

    .account-info-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.375rem 0;
        border-bottom: 1px solid #282930;
    }

    .account-info-row:last-child {
        border-bottom: none;
    }

    .account-info-label {
        color: #81828A;
        font-size: 0.8925rem;
        font-family: 'gg sans Medium', sans-serif;
    }

    .account-info-value-container {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .account-info-value {
        color: #dcddde;
        font-size: 0.8925rem;
        font-family: 'gg sans Semibold', sans-serif;
    }

    .account-copy-btn {
        width: 16px;
        height: 16px;
        cursor: pointer;
        filter: brightness(0) saturate(100%) invert(55%) sepia(5%) saturate(368%) hue-rotate(195deg) brightness(93%) contrast(89%);
        transition: opacity 0.2s ease;
    }

    .account-copy-btn:hover {
        opacity: 0.7;
    }

    .account-edit-btn {
        background: transparent;
        border: none;
        color: #15d8bc;
        padding: 0;
        cursor: pointer;
        font-size: 0.85rem;
        font-family: 'gg sans Medium', sans-serif;
        transition: color 0.2s ease;
    }

    .account-edit-btn:hover {
        color: #10b89e;
    }

    /* Standing Bar Styles */
    .standing-bar {
        display: flex;
        align-items: flex-start;
        justify-content: center;
        margin-top: 0;
        padding: 0;
        gap: 0;
        width: 100%;
        min-height: 80px;
        position: relative;
    }

    .standing-step {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0;
        flex: 0 0 auto;
        position: relative;
    }

    .standing-circle {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background: #1A1A1E;
        border: 2px solid #1A1A1E;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        flex-shrink: 0;
    }

    .standing-step.active .standing-circle {
        background: #15d8bc;
        border-color: #15d8bc;
    }

    .standing-step:nth-child(3).active .standing-circle {
        background: #ffa500;
        border-color: #ffa500;
    }

    .standing-step:nth-child(5).active .standing-circle {
        background: #991a35;
        border-color: #991a35;
    }

    .standing-icon {
        width: 14px;
        height: 14px;
        filter: brightness(0) saturate(100%) invert(7%) sepia(8%) saturate(1188%) hue-rotate(186deg) brightness(95%) contrast(93%);
    }

    /* Make tick icon bigger (24px * 0.8 = 19.2px) */
    .standing-icon[alt="All good"] {
        width: 19px;
        height: 19px;
    }

    .standing-label {
        font-size: 0.75rem;
        color: #dcddde;
        text-align: center;
        font-family: 'gg sans Medium', sans-serif;
        white-space: nowrap;
        line-height: 1.2;
        position: absolute;
        top: 32px;
    }

    .standing-line {
        flex: 1;
        height: 3px;
        background: #1A1A1E;
        margin-top: 10.5px;
        min-width: 40px;
    }

    /* Profile Photo Picker Popup */
    .profile-picker-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        z-index: 3000;
        justify-content: center;
        align-items: center;
    }

    .profile-picker-overlay.show {
        display: flex;
    }

    .profile-picker-popup {
        background: #1A1A1E;
        border: 1px solid #222225;
        border-radius: 8px;
        width: 320px;
        max-height: 80vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }

    .profile-picker-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem;
        border-bottom: 1px solid #222225;
    }

    .profile-picker-title {
        color: #dcddde;
        font-size: 0.9rem;
        font-family: 'gg sans Semibold', sans-serif;
    }

    .profile-picker-close {
        background: transparent;
        border: none;
        color: #81828A;
        font-size: 1.5rem;
        cursor: pointer;
        padding: 0;
        line-height: 1;
    }

    .profile-picker-close:hover {
        color: #dcddde;
    }

    .profile-picker-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 0.75rem;
        padding: 1rem;
        overflow-y: auto;
    }

    .profile-picker-item {
        width: 100%;
        aspect-ratio: 1;
        border-radius: 50%;
        cursor: pointer;
        overflow: hidden;
        transition: opacity 0.2s ease;
    }

    .profile-picker-item:hover {
        opacity: 0.7;
    }

    .profile-picker-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    /* Bridge Page Styles */
    .bridge-key-container {
        margin-bottom: 1rem;
    }

    .bridge-key-box {
        display: flex;
        align-items: center;
        background: #1A1A1E;
        border: 1px solid #222225;
        border-radius: 6px;
        padding: 0.75rem 1rem;
    }

    .bridge-key-input {
        flex: 1;
        background: transparent;
        border: none;
        color: #dcddde;
        font-family: monospace;
        font-size: 0.85rem;
        letter-spacing: 0.1em;
        outline: none;
    }

    .bridge-key-input::placeholder {
        color: #81828A;
    }

    .bridge-key-text-actions {
        display: flex;
        gap: 0.75rem;
        margin-top: 0.75rem;
    }

    .bridge-key-text-btn {
        background: transparent;
        border: none;
        color: #15d8bc;
        font-family: 'gg sans Medium', sans-serif;
        font-size: 0.85rem;
        cursor: pointer;
        padding: 0;
        transition: color 0.2s ease;
    }

    .bridge-key-text-btn:hover {
        color: #10b89e;
    }

    .bridge-link {
        color: #15d8bc;
        text-decoration: none;
    }

    .bridge-link:hover {
        text-decoration: underline;
    }

    .bridge-status-container {
        margin-bottom: 1rem;
    }

    .bridge-status-indicator {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .bridge-status-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: #81828A;
    }

    .bridge-status-dot.online {
        background: #15d8bc;
    }

    .bridge-status-text {
        color: #81828A;
        font-family: 'gg sans Medium', sans-serif;
        font-size: 0.8925rem;
    }

    .bridge-status-text.online {
        color: #15d8bc;
    }
</style>

<script>
    // Open settings popup
    async function openSettings() {
        document.getElementById('settings-popup-overlay').classList.add('show');

        // Fetch fresh account status
        try {
            const response = await fetch('/api/user/status');
            const data = await response.json();
            if (data.success) {
                // Update standing bar based on fresh data
                const steps = document.querySelectorAll('.standing-step');
                if (steps && steps.length >= 3) {
                    steps.forEach(step => step.classList.remove('active'));
                    if (data.banned) {
                        steps[2].classList.add('active');
                    } else if (data.flagged) {
                        steps[1].classList.add('active');
                    } else {
                        steps[0].classList.add('active');
                    }
                }
            }
        } catch (error) {
            console.error('Error fetching account status:', error);
        }
    }

    // Close settings popup
    function closeSettingsPopup() {
        document.getElementById('settings-popup-overlay').classList.remove('show');
        // Stop bridge status polling when popup closes
        if (typeof stopBridgeStatusPolling === 'function') {
            stopBridgeStatusPolling();
        }
    }

    // Settings popup - click overlay to close
    document.getElementById('settings-popup-overlay').addEventListener('click', function(e) {
        if (e.target === this) {
            closeSettingsPopup();
        }
    });

    // Settings menu navigation
    document.querySelectorAll('.settings-menu-item').forEach(item => {
        item.addEventListener('click', function() {
            // Update active state
            document.querySelectorAll('.settings-menu-item').forEach(i => i.classList.remove('active'));
            this.classList.add('active');

            // Update header title to match button text
            document.getElementById('settings-content-title').textContent = this.textContent;

            // Show the corresponding page
            const pageName = this.getAttribute('data-settings-page');
            document.querySelectorAll('.settings-page').forEach(page => {
                page.style.display = 'none';
            });
            const targetPage = document.getElementById('settings-page-' + pageName);
            if (targetPage) {
                targetPage.style.display = 'flex';
            }
        });
    });

    // Function to navigate to a specific settings page programmatically
    function navigateToSettingsPage(pageName) {
        // Find and click the corresponding menu item
        const menuItem = document.querySelector(`.settings-menu-item[data-settings-page="${pageName}"]`);
        if (menuItem) {
            menuItem.click();
        }
    }

    // Interval Slider functionality
    (function() {
        const sliderTrack = document.querySelector('.interval-slider-track');
        const sliderThumb = document.getElementById('interval-slider-thumb');
        const sliderFill = document.getElementById('interval-slider-fill');
        const labels = document.querySelectorAll('.interval-slider-labels span[data-value]');

        if (!sliderTrack || !sliderThumb || !sliderFill) return;

        // Delay values and their positions (0%, 25%, 50%, 75%, 100%)
        const delayStops = [
            { value: 0, percent: 0 },
            { value: 1000, percent: 25 },
            { value: 2000, percent: 50 },
            { value: 5000, percent: 75 },
            { value: 10000, percent: 100 }
        ];

        let currentDelay = 2000; // Default

        // Load saved delay from server
        function loadSavedDelay() {
            // Try to get from window.userMessageDelay if available (set by the page)
            let savedDelay = typeof window.userMessageDelay !== 'undefined' ? window.userMessageDelay : 2000;
            // Prevent setting to 0 (no delay is disabled)
            if (savedDelay === 0) savedDelay = 2000;
            setSliderToValue(savedDelay);
        }

        function getPercentForValue(value) {
            const stop = delayStops.find(s => s.value === value);
            return stop ? stop.percent : 50; // Default to 2 seconds position
        }

        function getValueForPercent(percent) {
            // Find nearest stop (excluding 0 - no delay)
            let nearest = delayStops[1]; // Start from 1000 (1 second)
            let minDist = Math.abs(percent - nearest.percent);

            for (let i = 1; i < delayStops.length; i++) {
                const stop = delayStops[i];
                const dist = Math.abs(percent - stop.percent);
                if (dist < minDist) {
                    minDist = dist;
                    nearest = stop;
                }
            }
            return nearest;
        }

        function setSliderToValue(value) {
            currentDelay = value;
            const percent = getPercentForValue(value);
            sliderThumb.style.left = percent + '%';
            sliderFill.style.width = percent + '%';
        }

        function setSliderToPercent(percent) {
            percent = Math.max(0, Math.min(100, percent));
            const nearest = getValueForPercent(percent);
            setSliderToValue(nearest.value);
            return nearest.value;
        }

        function saveDelay(value) {
            currentDelay = value;
            // Update global variable for immediate effect
            if (typeof window !== 'undefined') {
                window.userMessageDelay = value;
            }

            // Save to database
            fetch('/api/save-user-data', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message_delay: value
                })
            })
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    console.error('Failed to save delay setting:', data.error);
                }
            })
            .catch(error => {
                console.error('Error saving delay setting:', error);
            });
        }

        // Mouse/touch drag handling
        let isDragging = false;

        function startDrag(e) {
            isDragging = true;
            e.preventDefault();
        }

        function doDrag(e) {
            if (!isDragging) return;

            const rect = sliderTrack.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const percent = ((clientX - rect.left) / rect.width) * 100;
            setSliderToPercent(percent);
        }

        function endDrag(e) {
            if (!isDragging) return;
            isDragging = false;

            const rect = sliderTrack.getBoundingClientRect();
            const clientX = e.changedTouches ? e.changedTouches[0].clientX : e.clientX;
            const percent = ((clientX - rect.left) / rect.width) * 100;
            const value = setSliderToPercent(percent);
            saveDelay(value);
        }

        sliderThumb.addEventListener('mousedown', startDrag);
        sliderThumb.addEventListener('touchstart', startDrag);
        document.addEventListener('mousemove', doDrag);
        document.addEventListener('touchmove', doDrag);
        document.addEventListener('mouseup', endDrag);
        document.addEventListener('touchend', endDrag);

        // Click on track to jump to position
        sliderTrack.addEventListener('click', function(e) {
            if (e.target === sliderThumb) return;
            const rect = sliderTrack.getBoundingClientRect();
            const percent = ((e.clientX - rect.left) / rect.width) * 100;
            const value = setSliderToPercent(percent);
            saveDelay(value);
        });

        // Click on labels to set value
        labels.forEach(label => {
            label.addEventListener('click', function() {
                const value = parseInt(this.getAttribute('data-value'));
                setSliderToValue(value);
                saveDelay(value);
            });
        });

        // Initialize slider position
        loadSavedDelay();
    })();

    // Time Format functionality
    (function() {
        const dateFormatRadios = document.querySelectorAll('input[name="date-format"]');
        if (!dateFormatRadios.length) return;

        // Load saved date format
        function loadSavedDateFormat() {
            const savedFormat = typeof window.userDateFormat !== 'undefined' ? window.userDateFormat : 'mm/dd/yy';
            dateFormatRadios.forEach(radio => {
                radio.checked = radio.value === savedFormat;
            });
        }

        // Update all date format labels on page
        function updateAllDateFormatLabels(format) {
            // Update all elements with date-format-label class
            document.querySelectorAll('.date-format-label').forEach(el => {
                const template = el.getAttribute('data-label-template');
                if (template) {
                    el.textContent = template.replace('%FORMAT%', format);
                } else {
                    el.textContent = format;
                }
            });

            // Update signup date format label
            const signupDateFormat = document.getElementById('signup-date-format');
            if (signupDateFormat) {
                signupDateFormat.textContent = format;
            }
        }

        // Save date format to database and update global variable
        function saveDateFormat(format) {
            // Update global variable for immediate effect
            window.userDateFormat = format;

            // Update all date format labels immediately
            updateAllDateFormatLabels(format);

            // Dispatch event to notify other parts of the page (for test.html analytics, etc)
            window.dispatchEvent(new CustomEvent('dateFormatChanged', { detail: { format: format } }));

            // Save to database
            fetch('/api/save-user-data', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-Token': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    date_format: format
                })
            })
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    console.error('Failed to save date format:', data.error);
                }
            })
            .catch(error => {
                console.error('Error saving date format:', error);
            });
        }

        // Add event listeners to radio buttons
        dateFormatRadios.forEach(radio => {
            radio.addEventListener('change', function() {
                saveDateFormat(this.value);
            });
        });

        // Initialize radio button selection and update all labels on page load
        loadSavedDateFormat();
        updateAllDateFormatLabels(window.userDateFormat || 'mm/dd/yy');
    })();

    // Usage countdown functionality
    (function() {
        function updateCountdown(elementId) {
            const element = document.getElementById(elementId);
            if (!element) return;

            const resetTime = element.getAttribute('data-reset-time');
            if (!resetTime) return;

            const resetDate = new Date(resetTime);
            const now = new Date();
            const diff = resetDate - now;

            if (diff <= 0) {
                element.textContent = 'Resetting...';
                return;
            }

            const weeks = Math.floor(diff / (1000 * 60 * 60 * 24 * 7));
            const days = Math.floor((diff % (1000 * 60 * 60 * 24 * 7)) / (1000 * 60 * 60 * 24));
            const totalDays = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);

            let timeStr = '';

            if (totalDays >= 7) {
                // Above 7 days: show weeks and days only
                timeStr = weeks + 'w ' + days + 'd';
            } else if (totalDays >= 1) {
                // Above 1 day: show days and hours only
                timeStr = totalDays + 'd ' + hours + 'h';
            } else {
                // Under 1 day: show hours, minutes, seconds
                if (hours > 0) timeStr += hours + 'h ';
                if (minutes > 0 || hours > 0) timeStr += minutes + 'm ';
                timeStr += seconds + 's';
            }

            element.textContent = timeStr;
        }

        // Update countdowns every second
        function updateAllCountdowns() {
            updateCountdown('personal-reset-countdown');
            updateCountdown('team-reset-countdown');
        }

        // Initial update and set interval
        updateAllCountdowns();
        setInterval(updateAllCountdowns, 1000);
    })();

    // Teams functionality
    (function() {
        let acceptedInvitation = false;
        let invitationsLoaded = false;
        let currentTeamLoaded = false;

        function checkAndShowContent() {
            if (invitationsLoaded && currentTeamLoaded) {
                const loadingEl = document.getElementById('teams-loading');
                const contentEl = document.getElementById('teams-content');
                if (loadingEl) loadingEl.style.display = 'none';
                if (contentEl) {
                    contentEl.style.opacity = '1';
                    contentEl.style.pointerEvents = 'auto';
                }
            }
        }

        function loadTeamInvitations() {
            const invitationsList = document.getElementById('team-invitations-list');
            fetch('/api/team/invitations')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        if (data.invitations && data.invitations.length > 0) {
                            invitationsList.innerHTML = '';

                            data.invitations.forEach(invitation => {
                                const item = document.createElement('div');
                                item.className = 'team-invitation-item';

                                const ownerPhoto = invitation.owner_profile_photo || 'Light_Blue.jpg';
                                item.innerHTML = `
                                    <div class="team-invitation-avatar">
                                        <img src="/static/profile_photos/${ownerPhoto}" alt="Profile">
                                    </div>
                                    <span class="team-invitation-id">${invitation.owner_adzsend_id || 'No ID'}</span>
                                    <div class="team-invitation-actions">
                                        <button class="team-invitation-accept" data-id="${invitation.id}">
                                            <img src="{{ url_for('static', filename='tick.png') }}" alt="Accept">
                                        </button>
                                        <button class="team-invitation-deny" data-id="${invitation.id}">
                                            <img src="{{ url_for('static', filename='x.png') }}" alt="Deny">
                                        </button>
                                    </div>
                                `;

                                // Accept button click handler
                                const acceptBtn = item.querySelector('.team-invitation-accept');
                                acceptBtn.addEventListener('click', async () => {
                                    const confirmed = await customConfirm('Joining team', 'Are you sure you would like to join this team?', 'Join');
                                    if (confirmed) {
                                        await acceptInvitation(invitation.id);
                                    }
                                });

                                // Deny button click handler
                                const denyBtn = item.querySelector('.team-invitation-deny');
                                denyBtn.addEventListener('click', async () => {
                                    const confirmed = await customConfirm('Deny invitation', 'Are you sure you would like to deny this team invitation?', 'Deny');
                                    if (confirmed) {
                                        await denyInvitation(invitation.id);
                                    }
                                });

                                invitationsList.appendChild(item);
                            });
                        } else {
                            invitationsList.innerHTML = '<div class="team-no-invitations">No invitations</div>';
                        }
                        invitationsLoaded = true;
                        checkAndShowContent();
                    }
                })
                .catch(error => {
                    console.error('Error loading invitations:', error);
                    invitationsLoaded = true;
                    checkAndShowContent();
                });
        }

        async function acceptInvitation(memberId) {
            // Prevent double-clicks
            const operationId = `accept_invitation_${memberId}`;
            if (AsyncButton.isProcessing(operationId)) return;

            AsyncButton.startOperation(operationId);
            try {
                const response = await fetch(`/api/team/invitation/accept/${memberId}`, {
                    method: 'POST',
                    headers: { 'X-CSRF-Token': '{{ csrf_token }}' }
                });
                const data = await response.json();
                if (data.success) {
                    acceptedInvitation = true;
                    loadTeamInvitations();
                    loadCurrentTeam();
                } else {
                    await customAlert('Error', 'Something went wrong, please try again.');
                }
            } catch (error) {
                console.error('[Teams] Accept error:', error);
                await customAlert('Error', 'Something went wrong, please try again.');
            } finally {
                AsyncButton.endOperation(operationId);
            }
        }

        async function denyInvitation(memberId) {
            // Prevent double-clicks
            const operationId = `deny_invitation_${memberId}`;
            if (AsyncButton.isProcessing(operationId)) return;

            AsyncButton.startOperation(operationId);
            try {
                const response = await fetch(`/api/team/invitation/deny/${memberId}`, {
                    method: 'POST',
                    headers: { 'X-CSRF-Token': '{{ csrf_token }}' }
                });
                const data = await response.json();
                if (data.success) {
                    loadTeamInvitations();
                } else {
                    await customAlert('Error', 'Error: ' + data.error);
                }
            } catch (error) {
                await customAlert('Error', 'Error denying invitation: ' + error);
            } finally {
                AsyncButton.endOperation(operationId);
            }
        }

        function loadCurrentTeam() {
            const avatarEl = document.getElementById('team-current-avatar');
            const idEl = document.getElementById('team-current-id');

            fetch('/api/team/current')
                .then(response => response.json())
                .then(data => {
                    const leaveBtn = document.getElementById('team-leave-btn');
                    const crownEl = document.getElementById('team-owner-crown');
                    const invitationsList = document.getElementById('team-invitations-list');

                    if (data.success && data.is_owner) {
                        // User is a business plan owner - show crown instead of leave button
                        const owner = data.owner_info;
                        const ownerPhoto = owner.profile_photo || 'Light_Blue.jpg';
                        avatarEl.innerHTML = `<img src="/static/profile_photos/${ownerPhoto}" alt="Profile">`;
                        idEl.textContent = owner.adzsend_id || 'No ID';
                        leaveBtn.style.display = 'none';
                        crownEl.style.display = 'flex';

                        // Owner can't join other teams
                        if (invitationsList) {
                            invitationsList.innerHTML = '<div class="team-no-invitations">Cant join other teams as team owner.</div>';
                        }
                    } else if (data.success && data.in_team) {
                        // User is in a team - show the team owner's info with crown
                        const team = data.team;
                        const teamOwnerPhoto = team.owner_profile_photo || 'Light_Blue.jpg';
                        acceptedInvitation = true;
                        avatarEl.innerHTML = `<img src="/static/profile_photos/${teamOwnerPhoto}" alt="Profile">`;
                        idEl.textContent = team.owner_adzsend_id || 'No ID';
                        leaveBtn.style.display = 'block';
                        leaveBtn.disabled = false;
                        leaveBtn.textContent = 'Leave';
                        crownEl.style.display = 'flex';  // Show crown next to team owner's ID
                    } else {
                        // Not in any team
                        acceptedInvitation = false;
                        avatarEl.innerHTML = '';
                        idEl.textContent = 'None';
                        leaveBtn.style.display = 'block';
                        leaveBtn.disabled = true;
                        leaveBtn.textContent = 'Leave';
                        crownEl.style.display = 'none';
                    }
                    currentTeamLoaded = true;
                    checkAndShowContent();
                })
                .catch(error => {
                    console.error('Error loading current team:', error);
                    document.getElementById('team-current-id').textContent = 'None';
                    document.getElementById('team-leave-btn').disabled = true;
                    document.getElementById('team-owner-crown').style.display = 'none';
                    currentTeamLoaded = true;
                    checkAndShowContent();
                });
        }

        async function handleLeaveTeam() {
            // Prevent double-clicks
            if (AsyncButton.isProcessing('leave_team')) return;

            const leaveBtn = document.getElementById('team-leave-btn');

            const confirmed = await customConfirm('Leave team', 'Are you sure you would like to leave your team?', 'Leave');
            if (!confirmed) return;

            AsyncButton.startOperation('leave_team');
            leaveBtn.textContent = 'Leaving...';
            leaveBtn.disabled = true;

            try {
                const response = await fetch('/api/team/leave', {
                    method: 'POST',
                    headers: { 'X-CSRF-Token': '{{ csrf_token }}' }
                });
                const data = await response.json();
                if (data.success) {
                    acceptedInvitation = false;
                    loadCurrentTeam();
                    loadTeamInvitations();
                } else {
                    await customAlert('Error', 'Something went wrong, please try again.');
                    leaveBtn.textContent = 'Leave';
                    leaveBtn.disabled = false;
                }
            } catch (error) {
                await customAlert('Error', 'Something went wrong, please try again.');
                leaveBtn.textContent = 'Leave';
                leaveBtn.disabled = false;
            } finally {
                AsyncButton.endOperation('leave_team');
            }
        }

        // Attach leave button handler
        const leaveBtn = document.getElementById('team-leave-btn');
        if (leaveBtn) {
            leaveBtn.addEventListener('click', handleLeaveTeam);
        }

        // Load teams data on page load
        loadTeamInvitations();
        loadCurrentTeam();
    })();

    // Billing functionality
    (function() {
        // Format date according to user preference
        function formatInvoiceDate(dateValue) {
            if (!dateValue) return '';

            let date;
            // Handle Unix timestamp (Stripe uses seconds)
            if (typeof dateValue === 'number') {
                date = new Date(dateValue * 1000);
            } else {
                // Handle ISO string or other date formats
                date = new Date(dateValue);
            }

            if (isNaN(date.getTime())) return '';

            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = String(date.getFullYear()).slice(-2);

            const format = window.userDateFormat || 'mm/dd/yy';
            switch (format) {
                case 'dd/mm/yy':
                    return `${day}/${month}/${year}`;
                case 'yy/mm/dd':
                    return `${year}/${month}/${day}`;
                case 'mm/dd/yy':
                default:
                    return `${month}/${day}/${year}`;
            }
        }

        // Update all invoice dates on the page
        function updateInvoiceDates() {
            document.querySelectorAll('.billing-invoice-date').forEach(el => {
                const dateValue = el.getAttribute('data-date');
                if (dateValue) {
                    el.textContent = formatInvoiceDate(dateValue);
                }
            });
        }

        // Initial update
        updateInvoiceDates();

        // Listen for date format changes
        window.addEventListener('dateFormatChanged', updateInvoiceDates);

        // Invoice view button handlers (placeholder for Stripe integration)
        document.querySelectorAll('.billing-invoice-view-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                // TODO: Open Stripe invoice after integration
            });
        });

        // Adjust plan button handler (placeholder for Stripe customer portal)
        const adjustPlanBtn = document.getElementById('billing-adjust-plan-btn');
        if (adjustPlanBtn) {
            adjustPlanBtn.addEventListener('click', function() {
                // TODO: Redirect to Stripe customer portal after integration
            });
        }
    })();

    // My Account functionality
    document.addEventListener('DOMContentLoaded', function() {
        // Preset profile photos
        const profilePhotos = [
            'Dark_Green.jpg',
            'Dark_Purple.jpg',
            'Dark_Rose.jpg',
            'Light_Blue.jpg',
            'Light_Green.jpg',
            'Light_Orange.jpg',
            'Light_Pink.jpg',
            'Light_Yellow.jpg'
        ];

        let currentProfilePhoto = '{{ user_data.profile_photo if user_data and user_data.profile_photo else "Light_Blue.jpg" }}';

        // Format signup date according to user preference
        const signupDateEl = document.getElementById('account-signup-date');
        if (signupDateEl && signupDateEl.textContent !== 'Not set') {
            const dateStr = signupDateEl.textContent;
            const date = new Date(dateStr);
            if (!isNaN(date.getTime())) {
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = String(date.getFullYear()).slice(-2);

                const format = '{{ user_data.date_format if user_data and user_data.date_format else "mm/dd/yy" }}';
                let formattedDate;
                switch (format) {
                    case 'dd/mm/yy':
                        formattedDate = `${day}/${month}/${year}`;
                        break;
                    case 'yy/mm/dd':
                        formattedDate = `${year}/${month}/${day}`;
                        break;
                    case 'mm/dd/yy':
                    default:
                        formattedDate = `${month}/${day}/${year}`;
                        break;
                }
                signupDateEl.textContent = formattedDate;
            }
        }

        // Copy Adzsend ID to clipboard
        const copyBtn = document.getElementById('account-copy-adzsend');
        if (copyBtn) {
            copyBtn.addEventListener('click', async function() {
                const adzsendId = document.getElementById('account-adzsend-id').textContent;
                if (adzsendId && adzsendId !== 'Not set') {
                    try {
                        await navigator.clipboard.writeText(adzsendId);
                        // Brief visual feedback
                        this.style.opacity = '1';
                        setTimeout(() => { this.style.opacity = '0.6'; }, 200);
                    } catch (err) {
                        console.error('Failed to copy:', err);
                    }
                }
            });
        }

        // Edit email button - redirect to settings verification flow
        const editEmailBtn = document.getElementById('account-edit-email');
        if (editEmailBtn) {
            editEmailBtn.addEventListener('click', function() {
                window.location.href = '/settings#change-email';
            });
        }

        // Profile photo picker using custom popup
        const profilePhotoEl = document.getElementById('account-profile-photo');

        // Open profile picker
        if (profilePhotoEl) {
            profilePhotoEl.addEventListener('click', function() {
                showProfilePhotoPicker();
            });
        }

        // Show profile photo picker popup
        function showProfilePhotoPicker() {
            // Build grid HTML - centered with margin-top to avoid X button
            let gridHTML = '<div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.75rem; margin: 0.75rem auto; max-width: fit-content;">';

            profilePhotos.forEach(photo => {
                gridHTML += `
                    <div class="profile-picker-item" data-photo="${photo}" style="
                        width: 80px;
                        height: 80px;
                        border-radius: 50%;
                        overflow: hidden;
                        cursor: pointer;
                    ">
                        <img src="/static/profile_photos/${photo}" alt="${photo}" style="width: 100%; height: 100%; object-fit: cover;">
                    </div>
                `;
            });

            gridHTML += '</div>';

            // Show popup using custom system (no title, no text, no button)
            customAlert('', '', { contentHtml: gridHTML, hideButton: true, allowHtml: true });

            // Style the content box to match scrollable content areas
            setTimeout(() => {
                const contentEl = document.getElementById('custom-popup-content');
                if (contentEl) {
                    contentEl.style.background = '#121215';
                    contentEl.style.border = '1px solid #222225';
                    contentEl.style.borderRadius = '6px';
                    contentEl.style.padding = '0';
                    contentEl.style.marginTop = '2.5rem';
                    contentEl.style.marginBottom = '0';
                }
            }, 0);

            // Add click handlers after popup is shown
            setTimeout(() => {
                document.querySelectorAll('.profile-picker-item').forEach(item => {
                    item.addEventListener('click', function() {
                        const photo = this.dataset.photo;
                        selectProfilePhoto(photo);
                    });
                });
            }, 100);
        }

        // Select and save profile photo
        async function selectProfilePhoto(photo) {
            // Prevent double-clicks
            if (AsyncButton.isProcessing('select_profile_photo')) return;

            AsyncButton.startOperation('select_profile_photo');
            try {
                const response = await fetch('/api/save-user-data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({
                        profile_photo: photo
                    })
                });

                const data = await response.json();

                if (data.success) {
                    currentProfilePhoto = photo;
                    const newPhotoUrl = `/static/profile_photos/${photo}`;

                    // Update ALL user profile photos
                    document.querySelectorAll('.user-profile-photo').forEach(img => {
                        img.src = newPhotoUrl;
                    });

                    // Close the popup
                    const overlay = document.getElementById('custom-popup-overlay');
                    if (overlay) overlay.classList.remove('active');
                } else {
                    console.error('Failed to save profile photo:', data.error);
                }
            } catch (error) {
                console.error('Error saving profile photo:', error);
            } finally {
                AsyncButton.endOperation('select_profile_photo');
            }
        }
    });

    // =============================================================================
    // DISCORD ACCOUNTS PAGE INITIALIZATION
    // =============================================================================

    // Initialize Discord accounts page when it's shown
    const discordAccountsBtn = document.querySelector('[data-settings-page="discord-accounts"]');
    if (discordAccountsBtn) {
        discordAccountsBtn.addEventListener('click', () => {
            // Initialize if not already done
            if (typeof initDiscordAccountsPage === 'function') {
                initDiscordAccountsPage();
            }
        });
    }

    // =============================================================================
    // BRIDGE PAGE FUNCTIONALITY
    // =============================================================================

    (function() {
        let bridgeSecretKey = null;
        let isKeyVisible = false;
        let bridgeInitialized = false;

        // Initialize bridge page when it's shown
        const bridgeBtn = document.querySelector('[data-settings-page="bridge"]');
        if (bridgeBtn) {
            bridgeBtn.addEventListener('click', () => {
                if (!bridgeInitialized) {
                    initBridgePage();
                    bridgeInitialized = true;
                }
                // Always refresh status when viewing page
                loadBridgeStatus();
            });
        }

        let bridgeStatusInterval = null;

        function initBridgePage() {
            // Load secret key
            loadBridgeSecretKey();

            // Set up event listeners
            const copyBtn = document.getElementById('bridge-copy-key');
            const toggleBtn = document.getElementById('bridge-toggle-key');
            const regenerateBtn = document.getElementById('bridge-regenerate-key');

            if (copyBtn) {
                copyBtn.addEventListener('click', copySecretKey);
            }

            if (toggleBtn) {
                toggleBtn.addEventListener('click', toggleKeyVisibility);
            }

            if (regenerateBtn) {
                regenerateBtn.addEventListener('click', regenerateSecretKey);
            }

            // Start polling for bridge status (every 5 seconds - minimal overhead)
            startBridgeStatusPolling();
        }

        function startBridgeStatusPolling() {
            // Clear any existing interval
            stopBridgeStatusPolling();
            // Poll every 5 seconds
            bridgeStatusInterval = setInterval(loadBridgeStatus, 5000);
        }

        function stopBridgeStatusPolling() {
            if (bridgeStatusInterval) {
                clearInterval(bridgeStatusInterval);
                bridgeStatusInterval = null;
            }
        }

        async function loadBridgeSecretKey() {
            const keyInput = document.getElementById('bridge-secret-key');
            if (!keyInput) return;

            try {
                const response = await fetch('/api/bridge/secret-key');
                const data = await response.json();

                if (data.success) {
                    bridgeSecretKey = data.secret_key;
                    // Show masked version by default (dots for each character)
                    keyInput.value = maskKey(bridgeSecretKey);
                    keyInput.type = 'text';
                    isKeyVisible = false;
                } else {
                    keyInput.value = 'Error loading key';
                    console.error('Failed to load secret key:', data.error);
                }
            } catch (error) {
                keyInput.value = 'Error loading key';
                console.error('Error loading bridge secret key:', error);
            }
        }

        async function loadBridgeStatus() {
            const statusDot = document.getElementById('bridge-status-dot');
            const statusText = document.getElementById('bridge-status-text');

            if (!statusDot || !statusText) return;

            try {
                const response = await fetch('/api/bridge/status');
                const data = await response.json();

                if (data.success) {
                    if (data.is_online) {
                        statusDot.classList.add('online');
                        statusText.classList.add('online');
                        statusText.textContent = 'Connected';
                    } else {
                        statusDot.classList.remove('online');
                        statusText.classList.remove('online');
                        statusText.textContent = 'Offline';
                    }
                }
            } catch (error) {
                console.error('Error loading bridge status:', error);
            }
        }

        function maskKey(key) {
            if (!key) return '';
            // Show one dot per character for proper masking
            return '\u2022'.repeat(key.length);
        }

        async function copySecretKey() {
            if (!bridgeSecretKey) return;

            try {
                await navigator.clipboard.writeText(bridgeSecretKey);
                alert('Copied to clipboard');
            } catch (error) {
                console.error('Failed to copy secret key:', error);
                alert('Failed to copy to clipboard');
            }
        }

        function toggleKeyVisibility() {
            const keyInput = document.getElementById('bridge-secret-key');
            const toggleBtn = document.getElementById('bridge-toggle-key');

            if (!keyInput || !bridgeSecretKey) return;

            isKeyVisible = !isKeyVisible;

            if (isKeyVisible) {
                keyInput.value = bridgeSecretKey;
                keyInput.type = 'text';
                if (toggleBtn) toggleBtn.textContent = 'Hide';
            } else {
                keyInput.value = maskKey(bridgeSecretKey);
                keyInput.type = 'text';  // Keep as text to show the dots properly
                if (toggleBtn) toggleBtn.textContent = 'Show';
            }
        }

        async function regenerateSecretKey() {
            // Prevent double-clicks
            if (AsyncButton.isProcessing('regenerate_secret_key')) return;

            const confirmed = await customConfirm(
                'Regenerate secret key',
                'Are you sure you want to regenerate your secret key? You will need to enter your new secret key in the Bridge to use.',
                'Regenerate'
            );

            if (!confirmed) return;

            AsyncButton.startOperation('regenerate_secret_key');

            const regenerateBtn = document.getElementById('bridge-regenerate-key');
            const keyInput = document.getElementById('bridge-secret-key');

            if (regenerateBtn) regenerateBtn.disabled = true;
            if (keyInput) keyInput.value = 'Regenerating...';

            try {
                const response = await fetch('/api/bridge/regenerate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': '{{ csrf_token }}'
                    }
                });

                const data = await response.json();

                if (data.success) {
                    bridgeSecretKey = data.secret_key;
                    keyInput.value = isKeyVisible ? bridgeSecretKey : maskKey(bridgeSecretKey);

                    // Refresh status (will show offline since key changed)
                    setTimeout(loadBridgeStatus, 1000);
                } else {
                    await customAlert('Error', data.error || 'Failed to regenerate secret key');
                    keyInput.value = isKeyVisible ? bridgeSecretKey : maskKey(bridgeSecretKey);
                }
            } catch (error) {
                console.error('Error regenerating secret key:', error);
                await customAlert('Error', 'Failed to regenerate secret key');
                if (bridgeSecretKey) {
                    keyInput.value = isKeyVisible ? bridgeSecretKey : maskKey(bridgeSecretKey);
                }
            } finally {
                if (regenerateBtn) regenerateBtn.disabled = false;
                AsyncButton.endOperation('regenerate_secret_key');
            }
        }
    })();
</script>

<!-- Discord Accounts Management Script -->
<script src="{{ url_for('static', filename='discord_accounts.js') }}"></script>

<!-- Delete Account Confirmation Popup -->
<div class="custom-popup-overlay" id="delete-account-popup">
    <div class="custom-popup">
        <button class="custom-popup-close" onclick="closeDeleteAccountPopup()">&times;</button>
        <h2 class="custom-popup-title">Are you sure?</h2>
        <p class="custom-popup-text">This action is irreversable, you wont have access to any paid services anymore.</p>
        <button class="custom-popup-btn" id="confirm-delete-account-btn" onclick="deleteAccount()">Delete account</button>
    </div>
</div>

<script>
function openDeleteAccountPopup() {
    document.getElementById('delete-account-popup').classList.add('active');
}

function closeDeleteAccountPopup() {
    document.getElementById('delete-account-popup').classList.remove('active');
}

async function deleteAccount() {
    // Prevent double-clicks
    if (AsyncButton.isProcessing('delete_account')) return;

    AsyncButton.startOperation('delete_account');
    const btn = document.getElementById('confirm-delete-account-btn');
    btn.disabled = true;
    btn.textContent = 'Deleting...';

    try {
        const response = await fetch('/api/delete-account', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': window.csrfToken
            }
        });
        const data = await response.json();
        if (data.success) {
            // Account deleted, redirect to home
            window.location.href = '/';
        } else {
            await customAlert('Error', data.error || 'Failed to delete account');
            btn.disabled = false;
            btn.textContent = 'Delete account';
        }
    } catch (error) {
        console.error('Error:', error);
        await customAlert('Error', 'An error occurred while deleting your account');
        btn.disabled = false;
        btn.textContent = 'Delete account';
    } finally {
        AsyncButton.endOperation('delete_account');
    }
}
</script>
