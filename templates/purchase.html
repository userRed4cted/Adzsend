<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ site_config.page_titles.purchase }}</title>

    <!-- SEO Meta Tags -->
    <meta name="description" content="{{ get_page_description('purchase') }}">

    <!-- Open Graph / Facebook -->
    {% set embed = get_page_embed('purchase') %}
    <meta property="og:type" content="website">
    <meta property="og:title" content="{{ embed.title }}">
    <meta property="og:description" content="{{ embed.description }}">
    {% if embed.image %}
    <meta property="og:image" content="{{ url_for('static', filename=embed.image, _external=True) }}">
    {% endif %}
    <meta name="theme-color" content="{{ embed.color }}">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="{{ embed.title }}">
    <meta name="twitter:description" content="{{ embed.description }}">
    {% if embed.image %}
    <meta name="twitter:image" content="{{ url_for('static', filename=embed.image, _external=True) }}">
    {% endif %}

    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='responsive.css') }}">
    {% include 'partials/config_styles.html' %}
    {% if session.get('user') %}
    <script src="{{ url_for('static', filename='tab_enforcement.js') }}"></script>
    {% endif %}
    <script src="{{ url_for('static', filename='custom_popup.js') }}"></script>
    {% include 'partials/base_scripts.html' %}
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #121215;
            color: #ffffff;
            font-family: 'gg sans';
            overflow: hidden;
            height: 100vh;
        }

        .page-wrapper {
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        .page-scroll-container {
            flex: 1;
            overflow-y: auto;
            padding-top: 60px;
        }

        /* ==================== RESPONSIVE ==================== */
        /* Mobile */
        @media (max-width: 900px) {
            .purchase-container {
                padding: 1.5rem;
                height: auto;
                min-height: auto;
                overflow: visible;
            }

            .purchase-section {
                flex: none;
            }

            .plans-grid {
                grid-template-columns: 1fr;
                gap: 2rem;
                flex: none;
            }

            .plan-card {
                padding: 2rem;
                min-height: auto;
            }

            .plan-name {
                font-size: 1.25rem;
            }

            .price {
                font-size: 2.75rem;
            }

            .billing-toggle {
                gap: 0.75rem;
            }

            .billing-label {
                font-size: 0.9rem;
            }

            .feature span {
                font-size: 0.9rem;
            }
        }

        /* Small mobile */
        @media (max-width: 600px) {
            .purchase-container {
                padding: 1.25rem;
            }

            .plans-grid {
                gap: 1.5rem;
            }

            .plan-card {
                padding: 1.5rem;
            }

            .plan-name {
                font-size: 1.1rem;
            }

            .price {
                font-size: 2.5rem;
            }

            .billing-label {
                font-size: 0.85rem;
            }

            .feature span {
                font-size: 0.85rem;
            }

            .purchase-btn {
                padding: 0.65rem 1.25rem;
                font-size: 0.9rem;
            }

            .view-switch-btn {
                font-size: 0.8rem;
            }
        }
    </style>
</head>
<body>
    <div class="page-wrapper">
        {% include 'navbar.html' %}

        <div class="page-scroll-container">
            <div class="purchase-container">
                <!-- View Switch Button -->
                <div class="purchase-view-switch">
                    <button class="view-switch-btn" id="viewSwitchBtn" onclick="togglePurchaseView()">View team plans</button>
                </div>

                <!-- Subscriptions Section -->
                <div class="purchase-section" id="subscriptions-section">
                    <div class="billing-toggle">
                        <span class="billing-label">Monthly</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="billingToggle">
                            <span class="toggle-slider"></span>
                        </label>
                        <span class="billing-label">Yearly</span>
                    </div>

                    <div class="plans-grid">
                        {% for plan_id, plan in subscription_plans.items() %}
                        <div class="plan-card" data-plan-id="{{ plan_id }}">
                            <div class="plan-header">
                                <h3 class="plan-name">{{ plan.name }}</h3>
                                <div class="plan-price-section">
                                    {% if plan.price_monthly is defined %}
                                    <div class="price-row monthly-price">
                                        <span class="price">${{ "%.2f"|format(plan.price_monthly) if plan.price_monthly % 1 != 0 else "%.0f"|format(plan.price_monthly) }}</span>
                                    </div>
                                    <div class="price-row yearly-price" style="display: none;">
                                        <span class="price">${{ "%.2f"|format(plan.price_yearly) if plan.price_yearly % 1 != 0 else "%.0f"|format(plan.price_yearly) }}</span>
                                    </div>
                                    <span class="period monthly-period">PER MONTH</span>
                                    <span class="period yearly-period" style="display: none;">PER YEAR</span>
                                    <div class="yearly-savings" style="display: none; {% if plan.savings_color %}color: {{ plan.savings_color }};{% endif %}">
                                        {{ plan.savings_text }}
                                    </div>
                                    {% else %}
                                    <div class="price-row">
                                        <span class="price">$0</span>
                                    </div>
                                    <span class="period">FREE</span>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="plan-features">
                                {% for feature in plan.features %}
                                <div class="feature">
                                    <img src="{{ url_for('static', filename='tick.png') }}" alt="✓" class="check-icon" width="20" height="20">
                                    <span>{{ feature }}</span>
                                </div>
                                {% endfor %}
                            </div>
                            <button class="purchase-btn" data-plan-type="subscription" data-plan-id="{{ plan_id }}"
                                {% if not session.get('user') %}disabled style="opacity: 0.5; cursor: not-allowed;"{% endif %}
                                {% if plan_status and plan_status.has_plan and plan_status.plan_id != 'plan_free' %}data-is-adjust="true"{% endif %}>
                                {% if not session.get('user') %}
                                    Must be logged in
                                {% elif plan_status and plan_status.has_plan %}
                                    {% if plan_status.plan_id == plan_id and plan_status.plan_type == 'subscription' %}
                                        Current Plan
                                    {% elif plan_status.plan_id != 'plan_free' %}
                                        Adjust Plan
                                    {% else %}
                                        {{ plan.button_text }}
                                    {% endif %}
                                {% else %}
                                    {{ plan.button_text }}
                                {% endif %}
                            </button>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Business Section -->
                <div class="purchase-section" id="business-section" style="display: none;">
                    <div class="billing-toggle">
                        <span class="billing-label">Monthly</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="businessBillingToggle">
                            <span class="toggle-slider"></span>
                        </label>
                        <span class="billing-label">Yearly</span>
                    </div>

                    <div class="plans-grid">
                        {% for plan_id, plan in business_plans.items() %}
                        <div class="plan-card" data-plan-id="{{ plan_id }}">
                            <div class="plan-header">
                                <h3 class="plan-name">{{ plan.name }}</h3>
                                <div class="plan-price-section">
                                    {% if plan.price_monthly is defined %}
                                    <div class="price-row business-monthly-price">
                                        <span class="price">${{ "%.2f"|format(plan.price_monthly) if plan.price_monthly % 1 != 0 else "%.0f"|format(plan.price_monthly) }}</span>
                                    </div>
                                    <div class="price-row business-yearly-price" style="display: none;">
                                        <span class="price">${{ "%.2f"|format(plan.price_yearly) if plan.price_yearly % 1 != 0 else "%.0f"|format(plan.price_yearly) }}</span>
                                    </div>
                                    <span class="period business-monthly-period">PER MONTH</span>
                                    <span class="period business-yearly-period" style="display: none;">PER YEAR</span>
                                    <div class="yearly-savings business-yearly-savings" style="display: none; {% if plan.savings_color %}color: {{ plan.savings_color }};{% endif %}">
                                        {{ plan.savings_text }}
                                    </div>
                                    {% else %}
                                    <div class="price-row">
                                        <span class="price">Contact Us</span>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="plan-features">
                                {% for feature in plan.features %}
                                <div class="feature">
                                    <img src="{{ url_for('static', filename='tick.png') }}" alt="✓" class="check-icon" width="20" height="20">
                                    <span>{{ feature }}</span>
                                </div>
                                {% endfor %}
                            </div>
                            <button class="purchase-btn" data-plan-type="business" data-plan-id="{{ plan_id }}"
                                {% if not session.get('user') %}disabled style="opacity: 0.5; cursor: not-allowed;"{% endif %}
                                {% if plan_status and plan_status.has_plan and plan_status.plan_id != 'plan_free' %}data-is-adjust="true"{% endif %}>
                                {% if not session.get('user') %}
                                    Must be logged in
                                {% elif plan_status and plan_status.has_plan %}
                                    {% if plan_status.plan_id == plan_id and plan_status.plan_type == 'business' %}
                                        Current Plan
                                    {% elif plan_status.plan_id != 'plan_free' %}
                                        Adjust Plan
                                    {% else %}
                                        {{ plan.button_text }}
                                    {% endif %}
                                {% else %}
                                    {{ plan.button_text }}
                                {% endif %}
                            </button>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            {% include 'partials/footer.html' %}
        </div>
    </div>

    <script>
        // View toggle (Subscriptions vs Business/Teams) with fade effect and rate limiting
        const subscriptionsSection = document.getElementById('subscriptions-section');
        const businessSection = document.getElementById('business-section');
        const viewSwitchBtn = document.getElementById('viewSwitchBtn');
        const billingToggle = document.getElementById('billingToggle');
        const businessBillingToggle = document.getElementById('businessBillingToggle');
        let isModeToggling = false;

        // Helper function to check if element is visible
        function isVisible(el) {
            if (!el) return false;
            const style = window.getComputedStyle(el);
            return style.display !== 'none';
        }

        // Toggle between personal and team plans
        window.togglePurchaseView = function() {
            // Rate limiting - prevent spam clicking during animation
            if (isModeToggling) {
                return;
            }

            // Determine which section is currently visible
            let currentSection = null;
            let newSection = null;
            let newView = '';

            if (isVisible(subscriptionsSection)) {
                currentSection = subscriptionsSection;
                newSection = businessSection;
                newView = 'business';
                viewSwitchBtn.textContent = 'View personal plans';
            } else {
                currentSection = businessSection;
                newSection = subscriptionsSection;
                newView = 'subscriptions';
                viewSwitchBtn.textContent = 'View team plans';
            }

            // Skip if new section doesn't exist
            if (!newSection) return;

            // Sync billing toggles before switching
            if (billingToggle && businessBillingToggle) {
                if (newView === 'business') {
                    // Switching to business, sync business toggle to match personal
                    businessBillingToggle.checked = billingToggle.checked;
                } else {
                    // Switching to personal, sync personal toggle to match business
                    billingToggle.checked = businessBillingToggle.checked;
                }
            }

            // Lock the toggle during animation
            isModeToggling = true;

            // Fade out current section
            if (currentSection) {
                currentSection.classList.add('fade-out');
            }

            // After fade out, switch sections and fade in
            setTimeout(() => {
                if (currentSection) {
                    currentSection.style.display = 'none';
                    currentSection.classList.remove('fade-out');
                }

                newSection.style.display = 'block';
                newSection.classList.add('fade-in');

                // Update pricing display based on toggle state
                if (newView === 'business') {
                    const isYearly = businessBillingToggle.checked;
                    const businessMonthlyPrices = document.querySelectorAll('.business-monthly-price');
                    const businessYearlyPrices = document.querySelectorAll('.business-yearly-price');
                    const businessMonthlyPeriods = document.querySelectorAll('.business-monthly-period');
                    const businessYearlyPeriods = document.querySelectorAll('.business-yearly-period');
                    const businessYearlySavings = document.querySelectorAll('.business-yearly-savings');

                    businessMonthlyPrices.forEach(el => el.style.display = isYearly ? 'none' : 'flex');
                    businessYearlyPrices.forEach(el => el.style.display = isYearly ? 'flex' : 'none');
                    businessMonthlyPeriods.forEach(el => el.style.display = isYearly ? 'none' : 'inline');
                    businessYearlyPeriods.forEach(el => el.style.display = isYearly ? 'inline' : 'none');
                    businessYearlySavings.forEach(el => el.style.display = isYearly ? 'block' : 'none');
                } else {
                    const isYearly = billingToggle.checked;
                    const monthlyPrices = document.querySelectorAll('#subscriptions-section .monthly-price');
                    const yearlyPrices = document.querySelectorAll('#subscriptions-section .yearly-price');
                    const monthlyPeriods = document.querySelectorAll('#subscriptions-section .monthly-period');
                    const yearlyPeriods = document.querySelectorAll('#subscriptions-section .yearly-period');
                    const yearlySavings = document.querySelectorAll('#subscriptions-section .yearly-savings');

                    monthlyPrices.forEach(el => el.style.display = isYearly ? 'none' : 'flex');
                    yearlyPrices.forEach(el => el.style.display = isYearly ? 'flex' : 'none');
                    monthlyPeriods.forEach(el => el.style.display = isYearly ? 'none' : 'inline');
                    yearlyPeriods.forEach(el => el.style.display = isYearly ? 'inline' : 'none');
                    yearlySavings.forEach(el => el.style.display = isYearly ? 'block' : 'none');
                }

                // Remove fade-in class after animation and unlock toggle
                setTimeout(() => {
                    newSection.classList.remove('fade-in');
                    isModeToggling = false;  // Unlock after animation completes
                }, 300);
            }, 300);
        };

        // Billing toggle (Monthly/Yearly) with fade effect on entire cards and rate limiting
        const subscriptionCards = document.querySelectorAll('#subscriptions-section .plan-card');
        const monthlyPrices = document.querySelectorAll('#subscriptions-section .monthly-price');
        const yearlyPrices = document.querySelectorAll('#subscriptions-section .yearly-price');
        const monthlyPeriods = document.querySelectorAll('#subscriptions-section .monthly-period');
        const yearlyPeriods = document.querySelectorAll('#subscriptions-section .yearly-period');
        const yearlySavings = document.querySelectorAll('#subscriptions-section .yearly-savings');
        let isToggling = false;  // Rate limiting flag

        if (billingToggle) {
            billingToggle.addEventListener('change', (e) => {
                // Rate limiting - prevent spam clicking
                if (isToggling) {
                    e.preventDefault();
                    billingToggle.checked = !billingToggle.checked;  // Revert the change
                    return;
                }

                isToggling = true;  // Lock the toggle
                const isYearly = billingToggle.checked;

                // Sync business billing toggle
                if (businessBillingToggle) {
                    businessBillingToggle.checked = isYearly;
                }

                // Fade out all subscription plan cards
                subscriptionCards.forEach(card => card.classList.add('fade-out'));

                // After fade out, switch display and fade in
                setTimeout(() => {
                    monthlyPrices.forEach(el => {
                        el.style.display = isYearly ? 'none' : 'flex';
                    });

                    yearlyPrices.forEach(el => {
                        el.style.display = isYearly ? 'flex' : 'none';
                    });

                    monthlyPeriods.forEach(el => {
                        el.style.display = isYearly ? 'none' : 'inline';
                    });

                    yearlyPeriods.forEach(el => {
                        el.style.display = isYearly ? 'inline' : 'none';
                    });

                    yearlySavings.forEach(el => {
                        el.style.display = isYearly ? 'block' : 'none';
                    });

                    // Fade in cards
                    subscriptionCards.forEach(card => {
                        card.classList.remove('fade-out');
                        card.classList.add('fade-in');
                    });

                    // Remove fade-in class after animation and unlock toggle
                    setTimeout(() => {
                        subscriptionCards.forEach(card => card.classList.remove('fade-in'));
                        isToggling = false;  // Unlock the toggle after animation completes
                    }, 300);
                }, 300);
            });
        }

        // Business Billing toggle (Monthly/Yearly) with fade effect on entire cards and rate limiting
        const businessCards = document.querySelectorAll('#business-section .plan-card');
        const businessMonthlyPrices = document.querySelectorAll('.business-monthly-price');
        const businessYearlyPrices = document.querySelectorAll('.business-yearly-price');
        const businessMonthlyPeriods = document.querySelectorAll('.business-monthly-period');
        const businessYearlyPeriods = document.querySelectorAll('.business-yearly-period');
        const businessYearlySavings = document.querySelectorAll('.business-yearly-savings');
        let isBusinessToggling = false;  // Rate limiting flag

        if (businessBillingToggle) {
            businessBillingToggle.addEventListener('change', (e) => {
                // Rate limiting - prevent spam clicking
                if (isBusinessToggling) {
                    e.preventDefault();
                    businessBillingToggle.checked = !businessBillingToggle.checked;  // Revert the change
                    return;
                }

                isBusinessToggling = true;  // Lock the toggle
                const isYearly = businessBillingToggle.checked;

                // Sync personal billing toggle
                if (billingToggle) {
                    billingToggle.checked = isYearly;
                }

                // Fade out all business plan cards
                businessCards.forEach(card => card.classList.add('fade-out'));

                // After fade out, switch display and fade in
                setTimeout(() => {
                    businessMonthlyPrices.forEach(el => {
                        el.style.display = isYearly ? 'none' : 'flex';
                    });

                    businessYearlyPrices.forEach(el => {
                        el.style.display = isYearly ? 'flex' : 'none';
                    });

                    businessMonthlyPeriods.forEach(el => {
                        el.style.display = isYearly ? 'none' : 'inline';
                    });

                    businessYearlyPeriods.forEach(el => {
                        el.style.display = isYearly ? 'inline' : 'none';
                    });

                    businessYearlySavings.forEach(el => {
                        el.style.display = isYearly ? 'block' : 'none';
                    });

                    // Fade in cards
                    businessCards.forEach(card => {
                        card.classList.remove('fade-out');
                        card.classList.add('fade-in');
                    });

                    // Remove fade-in class after animation and unlock toggle
                    setTimeout(() => {
                        businessCards.forEach(card => card.classList.remove('fade-in'));
                        isBusinessToggling = false;  // Unlock the toggle after animation completes
                    }, 300);
                }, 300);
            });
        }

        // Check if user is logged in
        const isUserLoggedIn = {{ 'true' if session.get('user') else 'false' }};
        const csrfToken = '{{ csrf_token }}';

        // Disable "Current Plan" and "Must be logged in" buttons
        const purchaseButtons = document.querySelectorAll('.purchase-btn');
        purchaseButtons.forEach(btn => {
            const text = btn.textContent.trim();
            if (text === 'Current Plan' || text === 'Must be logged in') {
                btn.disabled = true;
                btn.style.opacity = '0.5';
                btn.style.cursor = 'not-allowed';
            }
        });

        // Purchase button handlers - Stripe checkout integration
        purchaseButtons.forEach(btn => {
            btn.addEventListener('click', async () => {
                // Skip if button is disabled
                if (btn.disabled) {
                    return;
                }

                // If this is an "Adjust Plan" button, open settings popup with billing page
                if (btn.dataset.isAdjust === 'true') {
                    openSettings();
                    navigateToSettingsPage('billing');
                    return;
                }

                // Get plan details
                const planType = btn.dataset.planType;
                const planId = btn.dataset.planId;

                // Determine billing period based on which section is visible
                let billingPeriod = 'monthly';
                if (planType === 'subscription') {
                    billingPeriod = document.getElementById('billingToggle').checked ? 'yearly' : 'monthly';
                } else if (planType === 'business') {
                    billingPeriod = document.getElementById('businessBillingToggle').checked ? 'yearly' : 'monthly';
                }

                // Show loading state
                const originalText = btn.textContent;
                btn.disabled = true;
                btn.innerHTML = '<div class="loading-dots dark"><span class="dot"></span><span class="dot"></span><span class="dot"></span></div>';

                try {
                    const response = await fetch('/api/set-plan', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRF-Token': csrfToken
                        },
                        body: JSON.stringify({
                            plan_type: planType,
                            plan_id: planId,
                            billing_period: billingPeriod
                        })
                    });

                    const data = await response.json();

                    if (data.success && data.checkout_url) {
                        // Redirect to Stripe checkout
                        window.location.href = data.checkout_url;
                    } else {
                        await customAlert('Error', data.error || 'Failed to start checkout');
                        btn.disabled = false;
                        btn.textContent = originalText;
                    }
                } catch (error) {
                    console.error('Checkout error:', error);
                    await customAlert('Error', 'Failed to start checkout. Please try again.');
                    btn.disabled = false;
                    btn.textContent = originalText;
                }
            });
        });


    </script>

    {% include 'partials/settings_popup.html' %}
</body>
</html>
