<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ site_config.page_titles.purchase }}</title>

    <!-- SEO Meta Tags -->
    <meta name="description" content="{{ get_page_description('purchase') }}">

    <!-- Open Graph / Facebook -->
    {% set embed = get_page_embed('purchase') %}
    <meta property="og:type" content="website">
    <meta property="og:title" content="{{ embed.title }}">
    <meta property="og:description" content="{{ embed.description }}">
    {% if embed.image %}
    <meta property="og:image" content="{{ url_for('static', filename=embed.image, _external=True) }}">
    {% endif %}
    <meta name="theme-color" content="{{ embed.color }}">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="{{ embed.title }}">
    <meta name="twitter:description" content="{{ embed.description }}">
    {% if embed.image %}
    <meta name="twitter:image" content="{{ url_for('static', filename=embed.image, _external=True) }}">
    {% endif %}

    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='responsive.css') }}">
    {% include 'partials/config_styles.html' %}
    {% if session.get('user') %}
    <script src="{{ url_for('static', filename='tab_enforcement.js') }}"></script>
    {% endif %}
    <script>
        window.DB_VERSION = {{ db_version }};
        window.DB_WIPE_MESSAGE = "{{ db_wipe_message }}";
    </script>
    <script src="{{ url_for('static', filename='db_wipe_notice.js') }}"></script>
    <script src="{{ url_for('static', filename='custom_modals.js') }}"></script>
    <style>
        html, body {
            overflow: hidden;
            height: 100%;
        }
        .panel {
            height: 100%;
            overflow: hidden;
        }
    </style>
</head>
<body>
    <div class="panel">
        <nav class="navbar">
            <div class="navbar-content">
                <div class="navbar-left">
                    <div class="menu-icon" id="menu-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="3" y1="12" x2="21" y2="12"></line>
                            <line x1="3" y1="6" x2="21" y2="6"></line>
                            <line x1="3" y1="18" x2="21" y2="18"></line>
                        </svg>
                    </div>
                    <div class="navbar-text">
                        <h1 class="navbar-title">Ad <span class="gradient-z">Z</span> send</h1>
                        <p class="navbar-subtitle">Choose your plan and start marketing</p>
                    </div>
                </div>
                <div class="nav-right">
                    {% if not session.get('user') %}
                        <div class="auth-buttons">
                            <a href="{{ url_for('login_page') }}" class="auth-btn login-btn">Login</a>
                            <a href="{{ url_for('signup_page') }}" class="auth-btn signup-btn">Sign Up</a>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Dropdown Menu -->
            <div class="dropdown-menu" id="dropdown-menu">
                <a href="{{ url_for('home') }}" class="dropdown-item">Home</a>
                <a href="{{ url_for('purchase') }}" class="dropdown-item">Purchase</a>
                {% if session.get('user') %}
                    {% if not (plan_status and plan_status.plan_id and plan_status.plan_id.startswith('team_plan_')) %}
                        <a href="{{ url_for('panel') }}" class="dropdown-item">Personal Panel</a>
                    {% endif %}
                    {% if has_business %}
                    {% if is_owner %}
                    <a href="{{ url_for('team_management') }}" class="dropdown-item">Team Management</a>
                    {% endif %}
                    <a href="{{ url_for('team_panel') }}" class="dropdown-item">Team Panel</a>
                    {% endif %}
                    <a href="{{ url_for('settings') }}" class="dropdown-item">Settings</a>
                    {% if is_admin_user %}
                    <a href="{{ url_for('admin_panel') }}" class="dropdown-item">Admin</a>
                    {% endif %}
                {% endif %}
                <div class="dropdown-divider"></div>
                <a href="https://discord.gg/KWt6rvCukp" target="_blank" class="dropdown-item discord-item">Discord Server</a>
                {% if session.get('user') %}
                    <a href="{{ url_for('logout') }}" class="dropdown-item logout-item">Logout</a>
                {% endif %}
            </div>
        </nav>

        <div class="panel-container">
            <div class="purchase-container">
                <!-- Mode Toggle -->
                <div class="purchase-mode-toggle">
                    <button class="mode-btn active" data-mode="subscriptions">Subscriptions</button>
                    <!-- One-time purchase temporarily disabled -->
                    <!-- <button class="mode-btn" data-mode="one-time">One Time Purchase</button> -->
                    <button class="mode-btn" data-mode="business">Teams</button>
                </div>

                <!-- Subscriptions Section -->
                <div class="purchase-section" id="subscriptions-section">
                    <div class="billing-toggle">
                        <span class="billing-label">Monthly</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="billingToggle">
                            <span class="toggle-slider"></span>
                        </label>
                        <span class="billing-label">Yearly</span>
                    </div>

                    <div class="plans-grid">
                        {% for plan_id, plan in subscription_plans.items() %}
                        <div class="plan-card" data-plan-id="{{ plan_id }}" data-glow="{{ plan.glow_color }}">
                            <div class="plan-header">
                                <h3 class="plan-name">{{ plan.name }}</h3>
                                <div class="plan-price-section">
                                    {% if plan.price_monthly is defined %}
                                    <div class="price-row monthly-price">
                                        <span class="price">${{ "%.2f"|format(plan.price_monthly) if plan.price_monthly % 1 != 0 else "%.0f"|format(plan.price_monthly) }}</span>
                                    </div>
                                    <div class="price-row yearly-price" style="display: none;">
                                        <span class="price">${{ "%.2f"|format(plan.price_yearly) if plan.price_yearly % 1 != 0 else "%.0f"|format(plan.price_yearly) }}</span>
                                    </div>
                                    <span class="period monthly-period">PER MONTH</span>
                                    <span class="period yearly-period" style="display: none;">PER YEAR</span>
                                    <div class="yearly-savings" style="display: none; {% if plan.savings_color %}color: {{ plan.savings_color }};{% endif %}">
                                        {{ plan.savings_text }}
                                    </div>
                                    {% else %}
                                    <div class="price-row">
                                        <span class="price">$0</span>
                                    </div>
                                    <span class="period">FREE</span>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="plan-features">
                                {% for feature in plan.features %}
                                <div class="feature">
                                    <img src="{{ url_for('static', filename='tick.png') }}" alt="✓" class="check-icon" width="20" height="20">
                                    <span>{{ feature }}</span>
                                </div>
                                {% endfor %}
                            </div>
                            <button class="purchase-btn" data-plan-type="subscription" data-plan-id="{{ plan_id }}"
                                {% if not session.get('user') %}disabled style="opacity: 0.5; cursor: not-allowed;"{% endif %}
                                {% if plan_status and plan_status.has_plan and plan_status.plan_id != 'plan_free' %}data-is-adjust="true"{% endif %}>
                                {% if not session.get('user') %}
                                    Must be logged in
                                {% elif plan_status and plan_status.has_plan %}
                                    {% if plan_status.plan_id == plan_id and plan_status.plan_type == 'subscription' %}
                                        Current Plan
                                    {% elif plan_status.plan_id != 'plan_free' %}
                                        Adjust Plan
                                    {% else %}
                                        {{ plan.button_text }}
                                    {% endif %}
                                {% else %}
                                    {{ plan.button_text }}
                                {% endif %}
                            </button>
                        </div>
                        {% endfor %}
                    </div>
                </div>

{#
                <!-- One-Time Purchase Section - TEMPORARILY DISABLED -->
                <div class="purchase-section" id="one-time-section" style="display: none;">
                    <div class="plans-grid">
                        {% for plan_id, plan in one_time_plans.items() %}
                        <div class="plan-card" data-plan-id="{{ plan_id }}" data-glow="{{ plan.glow_color }}">
                            <div class="plan-header">
                                <h3 class="plan-name">{{ plan.name }}</h3>
                                <div class="plan-price-section">
                                    <div class="price-row">
                                        <span class="price">${{ "%.2f"|format(plan.price) if plan.price % 1 != 0 else "%.0f"|format(plan.price) }}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="plan-features">
                                {% for feature in plan.features %}
                                <div class="feature">
                                    <img src="{{ url_for('static', filename='tick.png') }}" alt="✓" class="check-icon" width="20" height="20">
                                    <span>{{ feature }}</span>
                                </div>
                                {% endfor %}
                            </div>
                            <button class="purchase-btn" data-plan-type="one-time" data-plan-id="{{ plan_id }}"
                                {% if not session.get('user') %}disabled style="opacity: 0.5; cursor: not-allowed;"{% endif %}
                                {% if plan_status and plan_status.has_plan and plan_status.plan_id != 'plan_free' %}data-is-adjust="true"{% endif %}>
                                {% if not session.get('user') %}
                                    Must be logged in
                                {% elif plan_status and plan_status.has_plan %}
                                    {% if plan_status.plan_id == plan_id and plan_status.plan_type == 'one-time' %}
                                        Current Plan
                                    {% elif plan_status.plan_id != 'plan_free' %}
                                        Adjust Plan
                                    {% else %}
                                        {{ plan.button_text }}
                                    {% endif %}
                                {% else %}
                                    {{ plan.button_text }}
                                {% endif %}
                            </button>
                        </div>
                        {% endfor %}
                    </div>
                </div>
#}

                <!-- Business Section -->
                <div class="purchase-section" id="business-section" style="display: none;">
                    <div class="billing-toggle">
                        <span class="billing-label">Monthly</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="businessBillingToggle">
                            <span class="toggle-slider"></span>
                        </label>
                        <span class="billing-label">Yearly</span>
                    </div>

                    <div class="plans-grid">
                        {% for plan_id, plan in business_plans.items() %}
                        <div class="plan-card" data-plan-id="{{ plan_id }}" data-glow="{{ plan.glow_color }}">
                            <div class="plan-header">
                                <h3 class="plan-name">{{ plan.name }}</h3>
                                <div class="plan-price-section">
                                    {% if plan.price_monthly is defined %}
                                    <div class="price-row business-monthly-price">
                                        <span class="price">${{ "%.2f"|format(plan.price_monthly) if plan.price_monthly % 1 != 0 else "%.0f"|format(plan.price_monthly) }}</span>
                                    </div>
                                    <div class="price-row business-yearly-price" style="display: none;">
                                        <span class="price">${{ "%.2f"|format(plan.price_yearly) if plan.price_yearly % 1 != 0 else "%.0f"|format(plan.price_yearly) }}</span>
                                    </div>
                                    <span class="period business-monthly-period">PER MONTH</span>
                                    <span class="period business-yearly-period" style="display: none;">PER YEAR</span>
                                    <div class="yearly-savings business-yearly-savings" style="display: none; {% if plan.savings_color %}color: {{ plan.savings_color }};{% endif %}">
                                        {{ plan.savings_text }}
                                    </div>
                                    {% else %}
                                    <div class="price-row">
                                        <span class="price">Contact Us</span>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="plan-features">
                                {% for feature in plan.features %}
                                <div class="feature">
                                    <img src="{{ url_for('static', filename='tick.png') }}" alt="✓" class="check-icon" width="20" height="20">
                                    <span>{{ feature }}</span>
                                </div>
                                {% endfor %}
                            </div>
                            <button class="purchase-btn" data-plan-type="business" data-plan-id="{{ plan_id }}"
                                {% if not session.get('user') %}disabled style="opacity: 0.5; cursor: not-allowed;"{% endif %}
                                {% if plan_status and plan_status.has_plan and plan_status.plan_id != 'plan_free' %}data-is-adjust="true"{% endif %}>
                                {% if not session.get('user') %}
                                    Must be logged in
                                {% elif plan_status and plan_status.has_plan %}
                                    {% if plan_status.plan_id == plan_id and plan_status.plan_type == 'business' %}
                                        Current Plan
                                    {% elif plan_status.plan_id != 'plan_free' %}
                                        Adjust Plan
                                    {% else %}
                                        {{ plan.button_text }}
                                    {% endif %}
                                {% else %}
                                    {{ plan.button_text }}
                                {% endif %}
                            </button>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Dropdown menu toggle
        const menuIcon = document.getElementById('menu-icon');
        const dropdownMenu = document.getElementById('dropdown-menu');

        if (menuIcon) {
            menuIcon.addEventListener('click', (e) => {
                e.stopPropagation();
                dropdownMenu.classList.toggle('show');
            });
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (dropdownMenu && !dropdownMenu.contains(e.target) && menuIcon && !menuIcon.contains(e.target)) {
                dropdownMenu.classList.remove('show');
            }
        });

        // Mode toggle (Subscriptions vs One-Time vs Business) with fade effect and rate limiting
        const modeButtons = document.querySelectorAll('.mode-btn');
        const subscriptionsSection = document.getElementById('subscriptions-section');
        const oneTimeSection = document.getElementById('one-time-section');
        const businessSection = document.getElementById('business-section');
        let isModeToggling = false;  // Rate limiting flag

        // Helper function to check if element is visible
        function isVisible(el) {
            if (!el) return false;
            const style = window.getComputedStyle(el);
            return style.display !== 'none';
        }

        modeButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                // Rate limiting - prevent spam clicking during animation
                if (isModeToggling) {
                    return;
                }

                const mode = btn.dataset.mode;

                // Update button states
                modeButtons.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');

                // Determine which section is currently visible (using computed style)
                let currentSection = null;
                if (isVisible(subscriptionsSection)) currentSection = subscriptionsSection;
                else if (oneTimeSection && isVisible(oneTimeSection)) currentSection = oneTimeSection;
                else if (isVisible(businessSection)) currentSection = businessSection;

                // Determine which section to show
                let newSection = null;
                if (mode === 'subscriptions') newSection = subscriptionsSection;
                else if (mode === 'one-time') newSection = oneTimeSection;
                else if (mode === 'business') newSection = businessSection;

                // Skip if already on the right section or new section is null
                if (currentSection === newSection || !newSection) return;

                // Lock the toggle during animation
                isModeToggling = true;

                // Fade out current section
                if (currentSection) {
                    currentSection.classList.add('fade-out');
                }

                // After fade out, switch sections and fade in
                setTimeout(() => {
                    if (currentSection) {
                        currentSection.style.display = 'none';
                        currentSection.classList.remove('fade-out');
                    }

                    newSection.style.display = 'block';
                    newSection.classList.add('fade-in');

                    // Remove fade-in class after animation and unlock toggle
                    setTimeout(() => {
                        newSection.classList.remove('fade-in');
                        isModeToggling = false;  // Unlock after animation completes
                    }, 300);
                }, 300);
            });
        });

        // Billing toggle (Monthly/Yearly) with fade effect on entire cards and rate limiting
        const billingToggle = document.getElementById('billingToggle');
        const subscriptionCards = document.querySelectorAll('#subscriptions-section .plan-card');
        const monthlyPrices = document.querySelectorAll('#subscriptions-section .monthly-price');
        const yearlyPrices = document.querySelectorAll('#subscriptions-section .yearly-price');
        const monthlyPeriods = document.querySelectorAll('#subscriptions-section .monthly-period');
        const yearlyPeriods = document.querySelectorAll('#subscriptions-section .yearly-period');
        const yearlySavings = document.querySelectorAll('#subscriptions-section .yearly-savings');
        let isToggling = false;  // Rate limiting flag

        if (billingToggle) {
            billingToggle.addEventListener('change', (e) => {
                // Rate limiting - prevent spam clicking
                if (isToggling) {
                    e.preventDefault();
                    billingToggle.checked = !billingToggle.checked;  // Revert the change
                    return;
                }

                isToggling = true;  // Lock the toggle
                const isYearly = billingToggle.checked;

                // Fade out all subscription plan cards
                subscriptionCards.forEach(card => card.classList.add('fade-out'));

                // After fade out, switch display and fade in
                setTimeout(() => {
                    monthlyPrices.forEach(el => {
                        el.style.display = isYearly ? 'none' : 'flex';
                    });

                    yearlyPrices.forEach(el => {
                        el.style.display = isYearly ? 'flex' : 'none';
                    });

                    monthlyPeriods.forEach(el => {
                        el.style.display = isYearly ? 'none' : 'inline';
                    });

                    yearlyPeriods.forEach(el => {
                        el.style.display = isYearly ? 'inline' : 'none';
                    });

                    yearlySavings.forEach(el => {
                        el.style.display = isYearly ? 'block' : 'none';
                    });

                    // Fade in cards
                    subscriptionCards.forEach(card => {
                        card.classList.remove('fade-out');
                        card.classList.add('fade-in');
                    });

                    // Remove fade-in class after animation and unlock toggle
                    setTimeout(() => {
                        subscriptionCards.forEach(card => card.classList.remove('fade-in'));
                        isToggling = false;  // Unlock the toggle after animation completes
                    }, 300);
                }, 300);
            });
        }

        // Business Billing toggle (Monthly/Yearly) with fade effect on entire cards and rate limiting
        const businessBillingToggle = document.getElementById('businessBillingToggle');
        const businessCards = document.querySelectorAll('#business-section .plan-card');
        const businessMonthlyPrices = document.querySelectorAll('.business-monthly-price');
        const businessYearlyPrices = document.querySelectorAll('.business-yearly-price');
        const businessMonthlyPeriods = document.querySelectorAll('.business-monthly-period');
        const businessYearlyPeriods = document.querySelectorAll('.business-yearly-period');
        const businessYearlySavings = document.querySelectorAll('.business-yearly-savings');
        let isBusinessToggling = false;  // Rate limiting flag

        if (businessBillingToggle) {
            businessBillingToggle.addEventListener('change', (e) => {
                // Rate limiting - prevent spam clicking
                if (isBusinessToggling) {
                    e.preventDefault();
                    businessBillingToggle.checked = !businessBillingToggle.checked;  // Revert the change
                    return;
                }

                isBusinessToggling = true;  // Lock the toggle
                const isYearly = businessBillingToggle.checked;

                // Fade out all business plan cards
                businessCards.forEach(card => card.classList.add('fade-out'));

                // After fade out, switch display and fade in
                setTimeout(() => {
                    businessMonthlyPrices.forEach(el => {
                        el.style.display = isYearly ? 'none' : 'flex';
                    });

                    businessYearlyPrices.forEach(el => {
                        el.style.display = isYearly ? 'flex' : 'none';
                    });

                    businessMonthlyPeriods.forEach(el => {
                        el.style.display = isYearly ? 'none' : 'inline';
                    });

                    businessYearlyPeriods.forEach(el => {
                        el.style.display = isYearly ? 'inline' : 'none';
                    });

                    businessYearlySavings.forEach(el => {
                        el.style.display = isYearly ? 'block' : 'none';
                    });

                    // Fade in cards
                    businessCards.forEach(card => {
                        card.classList.remove('fade-out');
                        card.classList.add('fade-in');
                    });

                    // Remove fade-in class after animation and unlock toggle
                    setTimeout(() => {
                        businessCards.forEach(card => card.classList.remove('fade-in'));
                        isBusinessToggling = false;  // Unlock the toggle after animation completes
                    }, 300);
                }, 300);
            });
        }

        // Plan card glow effect - always on
        const planCards = document.querySelectorAll('.plan-card');
        planCards.forEach(card => {
            const glowColor = card.dataset.glow;
            // Set initial glow
            card.style.boxShadow = `0 0 30px ${glowColor}`;

            // Enhance glow on hover
            card.addEventListener('mouseenter', () => {
                card.style.boxShadow = `0 0 50px ${glowColor}`;
            });
            card.addEventListener('mouseleave', () => {
                card.style.boxShadow = `0 0 30px ${glowColor}`;
            });
        });

        // Check if user is logged in
        const isUserLoggedIn = {{ 'true' if session.get('user') else 'false' }};

        // Disable "Current Plan" and "Must be logged in" buttons
        const purchaseButtons = document.querySelectorAll('.purchase-btn');
        purchaseButtons.forEach(btn => {
            const text = btn.textContent.trim();
            if (text === 'Current Plan' || text === 'Must be logged in') {
                btn.disabled = true;
                btn.style.opacity = '0.5';
                btn.style.cursor = 'not-allowed';
            }
        });

        // Purchase button handlers
        purchaseButtons.forEach(btn => {
            btn.addEventListener('click', async () => {
                // Skip if button is disabled
                if (btn.disabled) {
                    return;
                }

                // If this is an "Adjust Plan" button, redirect to settings
                if (btn.dataset.isAdjust === 'true') {
                    window.location.href = '/settings';
                    return;
                }

                const planType = btn.dataset.planType;
                const planId = btn.dataset.planId;

                // Determine which billing toggle to use based on plan type
                let isYearly = false;
                if (planType === 'subscription') {
                    isYearly = billingToggle && billingToggle.checked;
                } else if (planType === 'business') {
                    isYearly = businessBillingToggle && businessBillingToggle.checked;
                }

                // Get plan name from the card
                const planCard = btn.closest('.plan-card');
                const planName = planCard.querySelector('.plan-name').textContent;
                const billingInfo = (planType === 'subscription' || planType === 'business')
                    ? (isYearly ? ' (Yearly)' : ' (Monthly)')
                    : '';

                // Show confirmation dialog
                const confirmMessage = `Are you sure you want to activate the ${planName}${billingInfo} plan?\n\nThis will replace any existing plan on your account.\nYour allowance will be reset and updated to match the new plan.`;

                const confirmed = await showConfirm(confirmMessage, 'Activate Plan', { confirmText: 'Activate' });
                if (!confirmed) {
                    return; // User cancelled
                }

                // For testing: just set the plan on the account
                try {
                    const response = await fetch('/api/set-plan', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRF-Token': '{{ csrf_token }}'
                        },
                        body: JSON.stringify({
                            plan_type: planType,
                            plan_id: planId,
                            billing_period: isYearly ? 'yearly' : 'monthly'
                        })
                    });
                    const data = await response.json();
                    if (data.success) {
                        await showAlert(`${planName}${billingInfo} plan activated successfully!`, 'Success');
                        window.location.href = data.redirect_url || '/panel';
                    } else {
                        await showAlert('Error: ' + (data.error || 'Unknown error'), 'Error');
                    }
                } catch (error) {
                    await showAlert('Error activating plan: ' + error, 'Error');
                }
            });
        });

    </script>
</body>
</html>
