<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - Adzsend</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='responsive.css') }}">
    {% include 'partials/config_styles.html' %}
    <script src="{{ url_for('static', filename='tab_enforcement.js') }}"></script>
    <script src="{{ url_for('static', filename='status_polling.js') }}"></script>
    <script>
        window.DB_VERSION = {{ db_version }};
        window.DB_WIPE_MESSAGE = "{{ db_wipe_message }}";
        // Email validation config
        window.BLACKLISTED_EMAIL_DOMAINS = {{ blacklisted_email_domains | tojson }};
        window.ALLOWED_EMAIL_TLDS = {{ allowed_email_tlds | tojson }};
    </script>
    <script src="{{ url_for('static', filename='db_wipe_notice.js') }}"></script>
    <script src="{{ url_for('static', filename='custom_modals.js') }}"></script>
    <style>
        /* Custom radio button styling with #15d8bc accent */
        input[type="radio"] {
            appearance: none;
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border: 2px solid #15d8bc;
            border-radius: 50%;
            background: transparent;
            cursor: pointer;
            position: relative;
        }
        input[type="radio"]:checked {
            background: #15d8bc;
            border-color: #15d8bc;
        }
        input[type="radio"]:checked::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 6px;
            height: 6px;
            background: #fff;
            border-radius: 50%;
        }
        input[type="radio"]:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="panel">
        <nav class="navbar">
            <div class="navbar-content">
                <div class="navbar-left">
                    <div class="menu-icon" id="menu-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="3" y1="12" x2="21" y2="12"></line>
                            <line x1="3" y1="6" x2="21" y2="6"></line>
                            <line x1="3" y1="18" x2="21" y2="18"></line>
                        </svg>
                    </div>
                    <div class="navbar-text">
                        <h1 class="navbar-title">Ad <span class="gradient-z">Z</span> send</h1>
                        <p class="navbar-subtitle">Manage your account settings and preferences</p>
                    </div>
                </div>
                {% if user %}
                <div class="nav-right">
                    <div style="display: flex; flex-direction: row; align-items: center; gap: 12px; background: #1A1A1E; padding: 8px 12px; border-radius: 8px; box-shadow: none;">
                        <div style="width: 32px; height: 32px; border-radius: 50%; background: #ff3333; flex-shrink: 0;"></div>
                        <span style="color: #dcddde; font-size: 0.9rem;">Welcome!</span>
                        <img src="{{ url_for('static', filename='gear.png') }}" alt="Settings" title="Settings" style="width: 20px; height: 20px; cursor: pointer; filter: brightness(0) saturate(100%) invert(55%) sepia(5%) saturate(368%) hue-rotate(202deg) brightness(92%) contrast(87%);" onclick="window.location.href='{{ url_for('settings') }}'">
                    </div>
                </div>
                {% else %}
                <div class="nav-right"></div>
                {% endif %}
            </div>

            <!-- Dropdown Menu -->
            <div class="dropdown-menu" id="dropdown-menu">
                <a href="{{ url_for('home') }}" class="dropdown-item">Home</a>
                <a href="{{ url_for('purchase') }}" class="dropdown-item">Purchase</a>
                {% if not (plan_status and plan_status.plan_id and plan_status.plan_id.startswith('team_plan_')) %}
                    <a href="{{ url_for('panel') }}" class="dropdown-item">Personal Panel</a>
                {% endif %}
                {% if has_business %}
                {% if is_owner %}
                <a href="{{ url_for('team_management') }}" class="dropdown-item">Team Management</a>
                {% endif %}
                <a href="{{ url_for('team_panel') }}" class="dropdown-item">Team Panel</a>
                {% endif %}
                <a href="{{ url_for('settings') }}" class="dropdown-item">Settings</a>
                {% if is_admin_user %}
                <a href="{{ url_for('admin_panel') }}" class="dropdown-item">Admin</a>
                {% endif %}
                <div class="dropdown-divider"></div>
                <a href="https://discord.gg/KWt6rvCukp" target="_blank" class="dropdown-item discord-item">Discord Server</a>
                <a href="{{ url_for('logout') }}" class="dropdown-item logout-item">Logout</a>
            </div>
        </nav>

        <div class="panel-container">
            <div class="settings-container">
                <div class="support-notice">For account or general support join our Discord server, found in the drop down menu</div>
                <div class="settings-panels">
                    <!-- Display Panel -->
                    <div class="settings-panel">
                        <div class="settings-panel-header">Display</div>
                        <div class="settings-panel-content" style="display: flex; flex-direction: column; gap: 1.5rem;">
                            <!-- Theme Mode -->
                            <div class="setting-group">
                                <div class="setting-label">Theme</div>
                                <div class="setting-description">Choose your preferred color theme</div>
                                <div style="display: flex; gap: 1.5rem; margin-top: 0.75rem;">
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                        <input type="radio" name="theme-mode" value="dark" checked>
                                        <span style="color: #dcddde; font-weight: 500;">Dark</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: not-allowed; opacity: 0.5;">
                                        <input type="radio" name="theme-mode" value="light" disabled>
                                        <span style="color: #dcddde; font-weight: 500;">Light</span>
                                        <span style="font-size: 0.75rem; color: #81828A;">(Coming soon)</span>
                                    </label>
                                </div>
                            </div>

                            <!-- Glass Effect Toggle -->
                            <div class="setting-group">
                                <div class="setting-label">Glass effect</div>
                                <div class="setting-description">Enable translucent glass like elements</div>
                                <div style="margin-top: 0.75rem;">
                                    <label class="toggle-switch-container" style="display: flex; align-items: center; gap: 0.75rem; cursor: not-allowed; opacity: 0.5;">
                                        <div class="toggle-switch" style="position: relative; width: 44px; height: 24px;">
                                            <input type="checkbox" id="glass-effect-toggle" disabled style="opacity: 0; width: 0; height: 0;">
                                            <span class="toggle-slider-display" style="position: absolute; cursor: not-allowed; top: 0; left: 0; right: 0; bottom: 0; background-color: #2a2a2d; border-radius: 24px; transition: 0.3s;"></span>
                                            <span class="toggle-knob" style="position: absolute; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: #81828A; border-radius: 50%; transition: 0.3s;"></span>
                                        </div>
                                        <span style="color: #dcddde; font-weight: 500;">Enable glass effect</span>
                                        <span style="font-size: 0.75rem; color: #81828A;">(Coming soon)</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Discord Account Panel -->
                    <div class="settings-panel">
                        <div class="settings-panel-header">Discord</div>
                        <div class="settings-panel-content" style="display: flex; flex-direction: column; gap: 1.5rem; flex: 1;">
                            {% if discord_oauth_info and discord_oauth_info.is_fully_linked %}
                            <!-- Accounts scroll frame (when linked) -->
                            <div style="display: flex; flex-direction: column; gap: 0.75rem; max-height: 300px; overflow-y: auto;">
                                <!-- Linked Discord Account -->
                                <div style="background: #212227; border-radius: 8px; padding: 1rem; display: flex; align-items: center; gap: 1rem;">
                                    <div style="width: 48px; height: 48px; border-radius: 50%; overflow: visible; flex-shrink: 0; position: relative;">
                                        {% if discord_oauth_info.oauth_avatar %}
                                            <img src="https://cdn.discordapp.com/avatars/{{ discord_oauth_info.oauth_discord_id }}/{{ discord_oauth_info.oauth_avatar }}.png"
                                                 alt="Discord Avatar" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">
                                        {% else %}
                                            <div style="width: 100%; height: 100%; background: linear-gradient(135deg, #5865f2 0%, #15d8bc 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 1.2rem; border-radius: 50%;">
                                                {{ discord_oauth_info.oauth_username[0].upper() if discord_oauth_info.oauth_username else '?' }}
                                            </div>
                                        {% endif %}
                                        {% if discord_oauth_info.oauth_avatar_decoration %}
                                            <img src="https://cdn.discordapp.com/avatar-decoration-presets/{{ discord_oauth_info.oauth_avatar_decoration }}.png?size=160&passthrough=true"
                                                 alt="" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 120%; height: 120%; pointer-events: none; z-index: 1;">
                                        {% endif %}
                                    </div>
                                    <div style="flex: 1; min-width: 0;">
                                        <div style="color: #dcddde; font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">{{ discord_oauth_info.oauth_username or 'Unknown User' }}</div>
                                        <div style="color: #81828A; font-size: 0.85rem;">ID: {{ discord_oauth_info.oauth_discord_id }}</div>
                                    </div>
                                    <button id="discord-unlink-btn" style="padding: 0.5rem 1rem; border-radius: 6px; font-weight: 500; font-size: 0.8rem; white-space: nowrap; display: flex; align-items: center; gap: 0.4rem; background: linear-gradient(to bottom, #991a35, #3b0b15); border: none; color: #121215; cursor: pointer; transition: all 0.2s;">
                                        <img src="{{ url_for('static', filename='link.png') }}" alt="" style="width: 14px; height: 14px; filter: brightness(0);">
                                        Unlink
                                    </button>
                                </div>

                                <!-- Add another Discord account -->
                                <div style="display: flex; align-items: center; gap: 1rem; padding: 1rem; background: #1e1f22; border-radius: 8px; opacity: 0.6; cursor: not-allowed;">
                                    <div style="width: 48px; height: 48px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; color: #81828A; font-size: 1.5rem; font-weight: 300;">
                                        +
                                    </div>
                                    <div style="flex: 1; min-width: 0;">
                                        <div style="color: #81828A; font-size: 0.9rem;">Add another Discord account</div>
                                        <div style="color: #15d8bc; font-size: 0.85rem;">$3</div>
                                    </div>
                                </div>
                            </div>
                            {% else %}
                            <!-- Not linked yet - show linking flow -->
                            <div id="discord-account-frame" style="background: #212227; border-radius: 8px; padding: 1rem; display: flex; align-items: center; gap: 1rem;">
                                {% if discord_oauth_info and discord_oauth_info.has_oauth %}
                                    <!-- OAuth completed but not fully linked - show Discord user info -->
                                    <div style="width: 48px; height: 48px; border-radius: 50%; overflow: visible; flex-shrink: 0; position: relative;">
                                        {% if discord_oauth_info.oauth_avatar %}
                                            <img src="https://cdn.discordapp.com/avatars/{{ discord_oauth_info.oauth_discord_id }}/{{ discord_oauth_info.oauth_avatar }}.png"
                                                 alt="Discord Avatar" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">
                                        {% else %}
                                            <div style="width: 100%; height: 100%; background: linear-gradient(135deg, #5865f2 0%, #15d8bc 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 1.2rem; border-radius: 50%;">
                                                {{ discord_oauth_info.oauth_username[0].upper() if discord_oauth_info.oauth_username else '?' }}
                                            </div>
                                        {% endif %}
                                        {% if discord_oauth_info.oauth_avatar_decoration %}
                                            <img src="https://cdn.discordapp.com/avatar-decoration-presets/{{ discord_oauth_info.oauth_avatar_decoration }}.png?size=160&passthrough=true"
                                                 alt="" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 120%; height: 120%; pointer-events: none; z-index: 1;">
                                        {% endif %}
                                    </div>
                                    <div style="flex: 1; min-width: 0;">
                                        <div style="color: #dcddde; font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">{{ discord_oauth_info.oauth_username or 'Unknown User' }}</div>
                                        <div style="color: #81828A; font-size: 0.85rem;">ID: {{ discord_oauth_info.oauth_discord_id }}</div>
                                    </div>
                                {% else %}
                                    <!-- No OAuth - show placeholder -->
                                    <div style="width: 48px; height: 48px; border-radius: 50%; overflow: hidden; flex-shrink: 0; background: #2a2b32; display: flex; align-items: center; justify-content: center;">
                                        <img src="{{ url_for('static', filename='DiscordLogo.png') }}" alt="Discord" style="width: 28px; height: 28px; object-fit: contain; opacity: 0.5;">
                                    </div>
                                    <div style="flex: 1;">
                                        <div style="color: #81828A; font-size: 0.9rem;">No Discord account linked</div>
                                    </div>
                                {% endif %}
                            </div>

                            {% if not discord_oauth_info or not discord_oauth_info.has_oauth %}
                            <!-- Alternative account recommendation -->
                            <p style="color: #faa61a; font-size: 0.85rem; margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
                                </svg>
                                We strongly recommend using an alternative account.
                            </p>
                            {% endif %}

                            <!-- Token Input Section (only shown after OAuth but before fully linked) -->
                            {% if discord_oauth_info and discord_oauth_info.has_oauth and not discord_oauth_info.is_fully_linked %}
                            <div id="discord-token-section" style="display: flex; flex-direction: column; gap: 0.75rem;">
                                <label style="color: #dcddde; font-weight: 500; font-size: 0.9rem;">Account token</label>
                                <div style="position: relative;">
                                    <input type="password" id="discord-token-input" placeholder="Enter your Discord token..."
                                           style="width: 100%; padding: 0.75rem 2.5rem 0.75rem 1rem; background: #1a1a1d; border: 1px solid #2a2a2d; border-radius: 8px; color: #fff; font-size: 0.9rem; box-sizing: border-box;">
                                    <button type="button" id="toggle-token-visibility"
                                            style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; padding: 0; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center;">
                                        <img id="eye-icon-view" src="{{ url_for('static', filename='hide.png') }}" alt="Show" style="width: 20px; height: 20px; opacity: 0.6;">
                                        <img id="eye-icon-hide" src="{{ url_for('static', filename='view.png') }}" alt="Hide" style="width: 20px; height: 20px; opacity: 0.6; display: none; position: absolute;">
                                    </button>
                                </div>
                                <p style="color: #81828A; font-size: 0.8rem; margin: 0;">Build an account history first before using the account to send messages using the panel</p>
                                <p id="token-status-label" style="color: #faa61a; font-size: 0.8rem; margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                                    <svg id="token-status-icon" width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
                                    </svg>
                                    <span id="token-status-text">Token must match the Discord account you authorized above</span>
                                </p>

                                <!-- Link Button -->
                                <button id="discord-complete-link-btn" class="submit-btn" disabled
                                        style="width: 100%; padding: 0.75rem 1.5rem; background: linear-gradient(to bottom, #323690, #4F58D8); opacity: 0.5; cursor: not-allowed; border: none; border-radius: 8px; color: #fff; font-weight: 600; transition: all 0.2s ease; margin-top: 0.5rem; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                                    <img src="{{ url_for('static', filename='link.png') }}" alt="" style="width: 18px; height: 18px; filter: brightness(0) invert(1);">
                                    Link
                                </button>
                            </div>
                            {% endif %}

                            <!-- Link account Button - only when not linked at all -->
                            {% if not discord_oauth_info or not discord_oauth_info.has_oauth %}
                            <div style="margin-top: auto;">
                                <button id="discord-oauth-btn" class="discord-btn" style="width: 100%; padding: 0.75rem 1.5rem; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                                    <img src="{{ url_for('static', filename='link.png') }}" alt="" style="width: 18px; height: 18px; filter: brightness(0) invert(1);">
                                    Link account
                                </button>
                            </div>
                            {% endif %}
                            {% endif %}
                        </div>
                    </div>

                    <!-- Teams Panel -->
                    <div class="settings-panel">
                        <div class="settings-panel-header">Teams</div>
                        <div class="settings-panel-content" style="display: flex; flex-direction: column; flex: 1; height: 100%;">
                            <!-- Team Invitations List -->
                            <div id="team-invitations-container" style="flex: 1; overflow-y: auto; max-height: 450px; margin-bottom: 1.5rem;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                    <div style="color: #dcddde; font-weight: 500; font-size: 0.9rem;">Team invitations</div>
                                    <button id="clearAllInvitationsBtn" style="padding: 0.4rem 1rem; font-size: 0.85rem; border: none; border-radius: 6px; font-weight: 500; color: #ffffff; background: linear-gradient(to bottom, #3a3a4d, #2a2a3d); transition: all 0.2s; opacity: 0.5; cursor: not-allowed;" disabled>Clear All</button>
                                </div>
                                <div id="invitations-list" style="display: flex; flex-direction: column; gap: 0.75rem; padding-bottom: 1rem;">
                                    <!-- Invitations will be loaded here -->
                                    <div style="color: #81828A; font-size: 0.9rem; text-align: center; padding: 2rem;">No pending invitations</div>
                                </div>
                            </div>

                            <!-- Current Team Status -->
                            <div id="current-team-container" style="margin-top: auto; padding-top: 1rem; padding-bottom: 2rem; border-top: 1px solid rgba(255, 255, 255, 0.1);">
                                <div style="color: #dcddde; font-weight: 500; font-size: 0.9rem; margin-bottom: 0.75rem;">Current team</div>
                                <div id="current-team-content">
                                    <!-- Will be populated by JavaScript - either "Not in any team" or team owner card -->
                                    <div id="no-team-status" style="color: #81828A; font-size: 0.85rem;">Not in any team</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Usage Panel -->
                    <div class="settings-panel">
                        <div class="settings-panel-header">Usage</div>

                        <!-- Personal/Business Toggle -->
                        {% set is_business_plan = plan_status.has_plan and plan_status.plan_id and plan_status.plan_id.startswith('team_plan_') %}
                        <div style="display: flex; gap: 1.5rem; padding: 0.5rem 1rem; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: {% if not plan_status.has_plan or is_business_plan %}not-allowed{% else %}pointer{% endif %}; opacity: {% if not plan_status.has_plan or is_business_plan %}0.5{% else %}1{% endif %};">
                                <input type="radio" name="usage-view" value="personal" {% if not is_business_plan %}checked{% endif %} {% if not plan_status.has_plan or is_business_plan %}disabled{% endif %} style="cursor: {% if not plan_status.has_plan or is_business_plan %}not-allowed{% else %}pointer{% endif %};">
                                <span style="color: #dcddde; font-weight: 500;">Personal</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: {% if not has_business %}not-allowed{% else %}pointer{% endif %}; opacity: {% if not has_business %}0.5{% else %}1{% endif %};">
                                <input type="radio" name="usage-view" value="business" {% if is_business_plan %}checked{% endif %} {% if not has_business %}disabled{% endif %} style="cursor: {% if not has_business %}not-allowed{% else %}pointer{% endif %};">
                                <span style="color: #dcddde; font-weight: 500;">Team</span>
                            </label>
                        </div>

                        <div class="settings-panel-content" id="personal-usage" {% if has_business %}style="display: block;"{% endif %}>
                            <div style="display: flex; flex-direction: column; gap: 1rem; padding-top: 1rem;">
                                <div class="usage-stat">
                                    <div class="usage-label">
                                        Allowance
                                        {% if plan_status.has_plan and plan_status.usage_type == 'allowance' %}
                                            (per {% if plan_status.allowance_period == 'weekly' %}week{% elif plan_status.allowance_period == 'monthly' %}month{% elif plan_status.allowance_period == 'daily' %}day{% endif %})
                                        {% elif plan_status.has_plan and plan_status.usage_type == 'amount' %}
                                            (total)
                                        {% endif %}
                                    </div>
                                    <div class="usage-value">
                                        {% if plan_status.is_unlimited %}
                                            inf
                                        {% elif plan_status.has_plan %}
                                            {{ plan_status.message_limit }}
                                        {% else %}
                                            0
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="usage-stat">
                                    <div class="usage-label">Advertisements sent (current cycle)</div>
                                    <div class="usage-value">
                                        {% if plan_status.has_plan %}
                                            {{ plan_status.messages_sent }}
                                        {% else %}
                                            0
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="usage-stat">
                                    <div class="usage-label">Usage percentage</div>
                                    <div class="usage-value">
                                        {% if plan_status.is_unlimited %}
                                            0%
                                        {% elif plan_status.has_plan and plan_status.message_limit > 0 %}
                                            {{ ((plan_status.messages_sent / plan_status.message_limit) * 100)|round(0)|int }}%
                                        {% else %}
                                            0%
                                        {% endif %}
                                    </div>
                                    <div class="usage-progress-bar" style="margin-top: 0.5rem;">
                                        <div class="usage-progress-fill" style="width: {% if plan_status.is_unlimited %}0{% elif plan_status.has_plan and plan_status.message_limit > 0 %}{{ ((plan_status.messages_sent / plan_status.message_limit) * 100)|round(0)|int }}{% else %}0{% endif %}%;"></div>
                                    </div>
                                </div>
                                {% if plan_status.has_plan and plan_status.usage_type == 'allowance' and plan_status.next_reset %}
                                <div class="usage-stat">
                                    <div class="usage-label">Limit resets in</div>
                                    <div class="usage-value" id="resetCountdown" data-reset-time="{{ plan_status.next_reset }}">Calculating...</div>
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Business Usage Section -->
                        {% if has_business and business_plan_status %}
                        <div class="settings-panel-content" id="business-usage" style="display: none;">
                            <div style="display: flex; flex-direction: column; gap: 1rem; padding-top: 1rem;">
                                <div class="usage-stat">
                                    <div class="usage-label">
                                        Allowance
                                        {% if business_plan_status.usage_type == 'allowance' %}
                                            (per {% if business_plan_status.allowance_period == 'weekly' %}week{% elif business_plan_status.allowance_period == 'monthly' %}month{% elif business_plan_status.allowance_period == 'daily' %}day{% endif %})
                                        {% elif business_plan_status.usage_type == 'amount' %}
                                            (total)
                                        {% endif %}
                                    </div>
                                    <div class="usage-value">
                                        {% if business_plan_status.is_unlimited %}
                                            inf
                                        {% else %}
                                            {{ business_plan_status.message_limit }}
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="usage-stat">
                                    <div class="usage-label">Advertisements sent (current cycle)</div>
                                    <div class="usage-value">{{ business_plan_status.messages_sent }}</div>
                                </div>
                                <div class="usage-stat">
                                    <div class="usage-label">Usage percentage</div>
                                    <div class="usage-value">
                                        {% if business_plan_status.is_unlimited %}
                                            0%
                                        {% elif business_plan_status.message_limit > 0 %}
                                            {{ ((business_plan_status.messages_sent / business_plan_status.message_limit) * 100)|round(0)|int }}%
                                        {% else %}
                                            0%
                                        {% endif %}
                                    </div>
                                    <div class="usage-progress-bar" style="margin-top: 0.5rem;">
                                        <div class="usage-progress-fill" style="width: {% if business_plan_status.is_unlimited %}0{% elif business_plan_status.message_limit > 0 %}{{ ((business_plan_status.messages_sent / business_plan_status.message_limit) * 100)|round(0)|int }}{% else %}0{% endif %}%;"></div>
                                    </div>
                                </div>
                                {% if business_plan_status.usage_type == 'allowance' and business_plan_status.next_reset %}
                                <div class="usage-stat">
                                    <div class="usage-label">Limit resets in</div>
                                    <div class="usage-value" id="businessResetCountdown" data-reset-time="{{ business_plan_status.next_reset }}">Calculating...</div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Billing Panel -->
                    <div class="settings-panel">
                        <div class="settings-panel-header">Billing</div>

                        <!-- Plan information / Invoices Toggle -->
                        <div style="display: flex; gap: 1.5rem; padding: 0.5rem 1rem; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="radio" name="billing-view" value="plan-info" checked style="cursor: pointer;">
                                <span style="color: #dcddde; font-weight: 500;">Plan information</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="radio" name="billing-view" value="invoices" style="cursor: pointer;">
                                <span style="color: #dcddde; font-weight: 500;">Invoices</span>
                            </label>
                        </div>

                        <div class="settings-panel-content" style="display: flex; flex-direction: column; flex: 1;">
                            <!-- Plan information Section -->
                            <div id="billing-plan-info" style="display: flex; flex-direction: column; flex: 1; padding-top: 1rem; justify-content: space-between;">
                                <div style="display: flex; flex-direction: column; gap: 1rem;">
                                    {% if plan_status.has_plan %}
                                        <!-- Status at top -->
                                        <div class="usage-stat">
                                            <div class="usage-label">Status</div>
                                            <div class="usage-value" style="color: #15d8bc;">Active</div>
                                        </div>

                                        <!-- Current plan -->
                                        <div class="usage-stat">
                                            <div class="usage-label">Current plan</div>
                                            <div class="usage-value">{{ plan_status.plan_name }}</div>
                                        </div>

                                        <!-- Billing period (only for paid subscriptions, not free plan) -->
                                        {% if plan_status.plan_type == 'subscription' and plan_status.plan_id != 'plan_free' %}
                                            <div class="usage-stat">
                                                <div class="usage-label">Billing period</div>
                                                <div class="usage-value">{{ plan_status.billing_period|capitalize }}</div>
                                            </div>
                                        {% endif %}

                                        <!-- Plan started (only for paid plans) -->
                                        {% if plan_status.plan_id != 'plan_free' %}
                                        <div class="usage-stat">
                                            <div class="usage-label">Plan started (mm/dd/yy)</div>
                                            <div class="usage-value">{{ plan_status.started_at|format_date }}</div>
                                        </div>
                                        {% endif %}

                                        <!-- Next Billing Date or Plan Expires (not for free plan) -->
                                        {% if plan_status.expires_at and plan_status.plan_id != 'plan_free' %}
                                            <div class="usage-stat">
                                                <div class="usage-label">{% if plan_status.plan_type in ['subscription', 'business'] %}Next billing date (mm/dd/yy){% else %}Plan expires (mm/dd/yy){% endif %}</div>
                                                <div class="usage-value">{{ plan_status.expires_at|format_date }}</div>
                                            </div>
                                        {% endif %}
                                    {% else %}
                                        <!-- Status -->
                                        <div class="usage-stat">
                                            <div class="usage-label">Status</div>
                                            <div class="usage-value" style="color: #15d8bc;">Active</div>
                                        </div>

                                        <!-- Current plan -->
                                        <div class="usage-stat">
                                            <div class="usage-label">Current plan</div>
                                            <div class="usage-value" style="color: #ffffff;">Free</div>
                                        </div>
                                    {% endif %}
                                </div>

                                <button class="adjust-plan-btn" id="adjustPlanBtn" onclick="showAdjustPlanDialog()">
                                    Adjust Plan
                                </button>
                            </div>

                            <!-- Invoices Section -->
                            <div id="billing-invoices" style="display: none; flex: 1; flex-direction: column; padding-top: 1rem;">
                                <!-- Column Headers -->
                                <div style="display: flex; padding: 0.75rem 0; border-bottom: 1px solid rgba(255,255,255,0.1); color: #81828A; font-size: 0.85rem; font-weight: 500;">
                                    <div style="flex: 1.5;">Date (mm/dd/yy)</div>
                                    <div style="flex: 1;">Total</div>
                                    <div style="flex: 1;">Status</div>
                                    <div style="flex: 0.8; text-align: right;">Actions</div>
                                </div>
                                <!-- Invoices List -->
                                <div id="invoices-list" style="flex: 1; overflow-y: auto; max-height: 280px;">
                                    {% if purchase_history and purchase_history|length > 0 %}
                                        {% for invoice in purchase_history %}
                                        <div style="display: flex; padding: 0.75rem 0; border-bottom: 1px solid rgba(255,255,255,0.05); align-items: center;">
                                            <div style="flex: 1.5; color: #dcddde; font-size: 0.9rem;">{{ invoice.start_date[5:7] }}/{{ invoice.start_date[8:10] }}/{{ invoice.start_date[2:4] }}</div>
                                            <div style="flex: 1; color: #dcddde; font-size: 0.9rem;">${{ invoice.price }}</div>
                                            <div style="flex: 1;">
                                                <span style="background: rgba(21, 216, 188, 0.2); color: #15d8bc; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem; font-weight: 500;">Paid</span>
                                            </div>
                                            <div style="flex: 0.8; text-align: right;">
                                                <button class="invoice-view-btn" data-invoice-id="{{ invoice.id }}" style="padding: 0.4rem 0.8rem; background: linear-gradient(to bottom, #15d8bc, #006e59); border: none; border-radius: 6px; color: #121215; font-size: 0.8rem; font-weight: 500; cursor: pointer; transition: all 0.2s ease;">View</button>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    {% else %}
                                        <div style="color: #81828A; text-align: center; padding: 2rem;">No purchase history</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- General Settings Panel -->
                    <div class="settings-panel">
                        <div class="settings-panel-header">General</div>
                        <div class="settings-panel-content" style="display: flex; flex-direction: column; flex: 1;">
                            <div class="setting-group">
                                <div class="setting-label">Message send delay</div>
                                <div class="setting-description">Delay between each message send (improves users discord performance)</div>
                                <div class="delay-options">
                                    <label class="delay-option">
                                        <input type="radio" name="messageDelay" value="0" class="delay-radio" {% if not plan_status.has_plan %}disabled{% endif %}>
                                        <span class="delay-option-label">No Delay</span>
                                    </label>
                                    <label class="delay-option">
                                        <input type="radio" name="messageDelay" value="1000" class="delay-radio" checked {% if not plan_status.has_plan %}disabled{% endif %}>
                                        <span class="delay-option-label">1 Second</span>
                                    </label>
                                    <label class="delay-option">
                                        <input type="radio" name="messageDelay" value="2000" class="delay-radio" {% if not plan_status.has_plan %}disabled{% endif %}>
                                        <span class="delay-option-label">2 Seconds</span>
                                    </label>
                                    <label class="delay-option">
                                        <input type="radio" name="messageDelay" value="5000" class="delay-radio" {% if not plan_status.has_plan %}disabled{% endif %}>
                                        <span class="delay-option-label">5 Seconds</span>
                                    </label>
                                </div>
                            </div>

                            <!-- Account Section -->
                            <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid rgba(255, 255, 255, 0.1); display: flex; flex-direction: column; gap: 1rem;">
                                <div class="setting-group">
                                    <div class="usage-label">Account email</div>
                                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                                        <div style="flex: 1; position: relative; display: flex; align-items: center;">
                                            <input type="email" id="emailInput" value="{{ user_email }}" readonly style="width: 100%; padding: 0.6rem 2.5rem 0.6rem 0.75rem; background: #212227; border: none; border-radius: 6px; color: #717688; font-size: 0.9rem; outline: none;">
                                            <img src="{{ url_for('static', filename='tick.png') }}" id="saveEmailTick" alt="Save" style="position: absolute; right: 0.75rem; width: 18px; height: 18px; cursor: pointer; opacity: 0.3; pointer-events: none; filter: brightness(0.5) opacity(0.7); transition: opacity 0.2s ease;">
                                        </div>
                                        <button type="button" id="editEmailBtn" style="padding: 0.6rem 1rem; background: transparent; border: none; color: #15d8bc; font-weight: 500; cursor: pointer; font-size: 0.9rem;">Edit</button>
                                    </div>
                                </div>

                                <!-- Adzsend ID Section -->
                                <div class="setting-group">
                                    <div class="usage-label">Adzsend user ID</div>
                                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                                        <div style="flex: 1; position: relative; display: flex; align-items: center;">
                                            <input type="text" id="adzsendIdInput" value="{{ adzsend_id or 'Loading...' }}" readonly style="width: 100%; padding: 0.6rem 2.5rem 0.6rem 0.75rem; background: #212227; border: none; border-radius: 6px; color: #717688; font-size: 0.9rem; outline: none; cursor: default;">
                                            <img src="{{ url_for('static', filename='copy.png') }}" id="copyAdzsendIdBtn" alt="Copy" style="position: absolute; right: 0.75rem; width: 18px; height: 18px; cursor: pointer; opacity: 0.6; filter: brightness(0.5) opacity(0.7);" onclick="copyAdzsendId()">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="setting-group" style="margin-top: auto;">
                                <button class="delete-account-btn" id="deleteAccountBtn">Delete account</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Adjust Plan Dialog Modal -->
    <div id="adjust-plan-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.8); z-index: 10000; align-items: center; justify-content: center;">
        <div style="background: #191A1F; border-radius: 12px; padding: 1.5rem; max-width: 400px; width: 90%; text-align: center; display: flex; flex-direction: column; gap: 1rem;">
            <h2 style="color: #dcddde; margin: 0; font-size: 1.25rem;">Adjust Plan</h2>
            <p style="color: #81828A; margin: 0; font-size: 0.9rem;">Plan adjustment feature coming soon. This will allow you to upgrade, downgrade, or modify your current subscription.</p>
            <button class="grey-btn" onclick="closeAdjustPlanDialog()" style="padding: 0.75rem 1.5rem; width: 100%;">
                OK
            </button>
        </div>
    </div>


    <script>
        // Adjust Plan Dialog functions
        function showAdjustPlanDialog() {
            document.getElementById('adjust-plan-modal').style.display = 'flex';
        }

        function closeAdjustPlanDialog() {
            document.getElementById('adjust-plan-modal').style.display = 'none';
        }

        // Close modal when clicking outside
        document.getElementById('adjust-plan-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeAdjustPlanDialog();
            }
        });

        // Copy Adzsend ID function
        async function copyAdzsendId() {
            const adzsendIdInput = document.getElementById('adzsendIdInput');
            try {
                await navigator.clipboard.writeText(adzsendIdInput.value);
                alert('Copied to clipboard');
            } catch (err) {
                alert('Failed to copy to clipboard');
            }
        }

        // Email editing functionality
        const emailInput = document.getElementById('emailInput');
        const editEmailBtn = document.getElementById('editEmailBtn');
        const saveEmailTick = document.getElementById('saveEmailTick');
        const originalEmail = emailInput.value;
        let isEditing = false;
        let canSaveEmail = false;

        editEmailBtn.addEventListener('click', () => {
            if (isEditing) {
                // Cancel editing
                isEditing = false;
                emailInput.value = originalEmail;
                emailInput.readOnly = true;
                emailInput.style.color = '#717688';
                editEmailBtn.textContent = 'Edit';
                saveEmailTick.style.opacity = '0.3';
                saveEmailTick.style.pointerEvents = 'none';
                canSaveEmail = false;
            } else {
                // Start editing
                isEditing = true;
                emailInput.readOnly = false;
                emailInput.style.color = '#dcddde';
                emailInput.focus();
                editEmailBtn.textContent = 'Cancel';
            }
        });

        // Email validation helper function
        function validateEmail(email) {
            const emailLower = email.toLowerCase();

            // Basic format check
            if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(emailLower)) {
                return { valid: false, error: 'Invalid email format' };
            }

            // Check against blacklisted domains
            for (const blacklisted of window.BLACKLISTED_EMAIL_DOMAINS) {
                if (emailLower.endsWith(blacklisted)) {
                    return { valid: false, error: `Domain ${blacklisted} is not allowed` };
                }
            }

            // Check if email ends with an allowed TLD
            if (window.ALLOWED_EMAIL_TLDS && window.ALLOWED_EMAIL_TLDS.length > 0) {
                const isAllowed = window.ALLOWED_EMAIL_TLDS.some(tld => emailLower.endsWith(tld));
                if (!isAllowed) {
                    return { valid: false, error: 'Email domain is not supported' };
                }
            }

            return { valid: true, error: null };
        }

        emailInput.addEventListener('input', () => {
            const newEmail = emailInput.value.trim();
            const validation = validateEmail(newEmail);
            const hasChanged = newEmail !== originalEmail && newEmail !== '';

            if (isEditing && validation.valid && hasChanged) {
                saveEmailTick.style.opacity = '1';
                saveEmailTick.style.pointerEvents = 'auto';
                canSaveEmail = true;
            } else {
                saveEmailTick.style.opacity = '0.3';
                saveEmailTick.style.pointerEvents = 'none';
                canSaveEmail = false;
            }
        });

        saveEmailTick.addEventListener('click', async () => {
            if (!canSaveEmail) return;

            const newEmail = emailInput.value.trim();
            canSaveEmail = false;
            saveEmailTick.style.opacity = '0.5';
            saveEmailTick.style.pointerEvents = 'none';

            try {
                const response = await fetch('/api/change-email', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({ new_email: newEmail })
                });

                const data = await response.json();

                if (data.success) {
                    // Redirect to verification page
                    window.location.href = data.redirect_url;
                } else {
                    await showAlert('Error: ' + (data.error || 'Failed to initiate email change'), 'Error');
                    saveEmailTick.style.opacity = '1';
                    saveEmailTick.style.pointerEvents = 'auto';
                    canSaveEmail = true;
                }
            } catch (error) {
                console.error('Email change error:', error);
                await showAlert('Error changing email. Please try again.', 'Error');
                saveEmailTick.style.opacity = '1';
                saveEmailTick.style.pointerEvents = 'auto';
                canSaveEmail = true;
            }
        });

        // Dropdown menu toggle
        const menuIcon = document.getElementById('menu-icon');
        const dropdownMenu = document.getElementById('dropdown-menu');

        if (menuIcon) {
            menuIcon.addEventListener('click', (e) => {
                e.stopPropagation();
                dropdownMenu.classList.toggle('show');
            });
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (dropdownMenu && !dropdownMenu.contains(e.target) && menuIcon && !menuIcon.contains(e.target)) {
                dropdownMenu.classList.remove('show');
            }
        });

        // Personal/Business usage toggle
        const usageViewRadios = document.querySelectorAll('input[name="usage-view"]');
        const personalUsage = document.getElementById('personal-usage');
        const businessUsage = document.getElementById('business-usage');

        usageViewRadios.forEach(radio => {
            radio.addEventListener('change', (e) => {
                if (e.target.value === 'personal') {
                    if (personalUsage) personalUsage.style.display = 'block';
                    if (businessUsage) businessUsage.style.display = 'none';
                } else if (e.target.value === 'business') {
                    if (personalUsage) personalUsage.style.display = 'none';
                    if (businessUsage) businessUsage.style.display = 'block';
                }
            });
        });

        // Load and save message delay setting
        document.addEventListener('DOMContentLoaded', () => {
            const delayRadios = document.querySelectorAll('.delay-radio');

            // Load saved delay setting from server (default to 1000ms)
            const savedDelay = '{{ user_data.message_delay }}' || '1000';

            // Set the correct radio button as checked
            delayRadios.forEach(radio => {
                if (radio.value === savedDelay) {
                    radio.checked = true;
                }

                // Add change listener to save to database when user selects a new option
                radio.addEventListener('change', () => {
                    if (radio.checked) {
                        // Save to database
                        fetch('/api/save-user-data', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRF-Token': '{{ csrf_token }}'
                            },
                            body: JSON.stringify({
                                message_delay: parseInt(radio.value)
                            })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (!data.success) {
                                console.error('Failed to save delay setting:', data.error);
                            }
                        })
                        .catch(error => {
                            console.error('Error saving delay setting:', error);
                        });
                    }
                });
            });

            // Format time difference to show days/weeks when appropriate
            function formatTimeDiff(diff) {
                if (diff <= 0) return 'Resetting...';

                const weeks = Math.floor(diff / (1000 * 60 * 60 * 24 * 7));
                const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));

                // Show weeks and days if 7+ days
                if (weeks >= 1) {
                    const remainingDays = days % 7;
                    if (remainingDays > 0) {
                        return `${weeks}w ${remainingDays}d`;
                    }
                    return `${weeks} week${weeks > 1 ? 's' : ''}`;
                }

                // Show days and hours if 1+ days
                if (days >= 1) {
                    if (hours > 0) {
                        return `${days}d ${hours}h`;
                    }
                    return `${days} day${days > 1 ? 's' : ''}`;
                }

                // Show hours and minutes
                return `${hours}h ${minutes}m`;
            }

            // Countdown timer functionality for personal usage
            const countdownElement = document.getElementById('resetCountdown');
            if (countdownElement) {
                const resetTime = countdownElement.getAttribute('data-reset-time');

                function updateCountdown() {
                    const now = new Date();
                    const reset = new Date(resetTime);
                    const diff = reset - now;

                    countdownElement.textContent = formatTimeDiff(diff);
                }

                // Update immediately and then every minute
                updateCountdown();
                setInterval(updateCountdown, 60000);
            }

            // Countdown timer functionality for business usage
            const businessCountdownElement = document.getElementById('businessResetCountdown');
            if (businessCountdownElement) {
                const resetTime = businessCountdownElement.getAttribute('data-reset-time');

                function updateBusinessCountdown() {
                    const now = new Date();
                    const reset = new Date(resetTime);
                    const diff = reset - now;

                    businessCountdownElement.textContent = formatTimeDiff(diff);
                }

                // Update immediately and then every minute
                updateBusinessCountdown();
                setInterval(updateBusinessCountdown, 60000);
            }

            // Delete account functionality
            const deleteAccountBtn = document.getElementById('deleteAccountBtn');

            if (deleteAccountBtn) {
                deleteAccountBtn.addEventListener('click', async () => {
                    // Show confirmation popup
                    const confirmation = await showConfirm('Account and related data will be erased, this action is irreversible. Any active plan will be terminated without refund.', 'Delete account', { danger: true, confirmText: 'Delete account' });

                    if (confirmation) {
                        deleteAccountBtn.textContent = 'Deleting...';
                        deleteAccountBtn.disabled = true;

                        try {
                            const response = await fetch('/api/delete-account', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRF-Token': '{{ csrf_token }}'
                                }
                            });
                            const data = await response.json();
                            if (data.success) {
                                localStorage.clear();
                                await showAlert('Your account has been successfully deleted.', 'Account Deleted');
                                window.location.href = '/home';
                            } else {
                                await showAlert('Error deleting account: ' + (data.error || 'Unknown error'), 'Error');
                                deleteAccountBtn.disabled = false;
                                deleteAccountBtn.textContent = 'Delete account';
                            }
                        } catch (error) {
                            await showAlert('Error deleting account: ' + error, 'Error');
                            deleteAccountBtn.disabled = false;
                            deleteAccountBtn.textContent = 'Delete account';
                        }
                    }
                });
            }
        });

        // Cancel plan functionality with persistent confirmation
        const cancelPlanBtn = document.getElementById('cancelPlanBtn');
        let cancelPlanConfirmed = false;

        if (cancelPlanBtn) {
            {% if plan_status.has_plan %}
                const originalCancelText = cancelPlanBtn.textContent;
                const originalCancelStyle = cancelPlanBtn.style.cssText;
                const planType = '{{ plan_status.plan_type }}';
                const expiresAt = '{{ plan_status.expires_at[:10] if plan_status.expires_at else "" }}';

                cancelPlanBtn.addEventListener('click', async () => {
                    if (!cancelPlanConfirmed) {
                        // First click - show confirmation
                        let message = 'Are you sure you want to cancel your plan? Current plan will remain active until ';
                        if (planType === 'subscription') {
                            message += expiresAt;
                        } else {
                            message += expiresAt;
                        }

                        const confirmation = await showConfirm(message, 'Cancel Plan', { danger: true, confirmText: 'Cancel Plan' });

                        if (confirmation) {
                            cancelPlanConfirmed = true;
                            cancelPlanBtn.textContent = 'Confirm Cancel';
                            cancelPlanBtn.style.background = 'linear-gradient(to bottom, #7a152b, #2d0810)';
                            cancelPlanBtn.style.border = '2px solid #991a35';
                        }
                    } else {
                        // Second click - execute cancellation
                        cancelPlanBtn.textContent = 'Cancelling...';
                        cancelPlanBtn.disabled = true;

                        try {
                            const response = await fetch('/api/cancel-plan', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRF-Token': '{{ csrf_token }}'
                                }
                            });
                            const data = await response.json();
                            if (data.success) {
                                await showAlert('Your plan has been successfully cancelled.', 'Plan Cancelled');
                                window.location.reload();
                            } else {
                                await showAlert('Error cancelling plan: ' + (data.error || 'Unknown error'), 'Error');
                                cancelPlanBtn.disabled = false;
                                cancelPlanBtn.textContent = originalCancelText;
                                cancelPlanBtn.style.cssText = originalCancelStyle;
                                cancelPlanConfirmed = false;
                            }
                        } catch (error) {
                            await showAlert('Error cancelling plan: ' + error, 'Error');
                            cancelPlanBtn.disabled = false;
                            cancelPlanBtn.textContent = originalCancelText;
                            cancelPlanBtn.style.cssText = originalCancelStyle;
                            cancelPlanConfirmed = false;
                        }
                    }
                });

                // Reset confirmation state when navigating
                window.addEventListener('beforeunload', () => {
                    cancelPlanConfirmed = false;
                });
            {% endif %}
        }

        // Team invitations functionality
        let acceptedInvitation = false;

        function loadTeamInvitations() {
            fetch('/api/team/invitations')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const invitationsList = document.getElementById('invitations-list');
                        const clearAllBtn = document.getElementById('clearAllInvitationsBtn');

                        if (data.invitations && data.invitations.length > 0) {
                            invitationsList.innerHTML = '';
                            clearAllBtn.disabled = false;
                            clearAllBtn.style.opacity = '1';
                            clearAllBtn.style.cursor = 'pointer';
                            clearAllBtn.style.background = 'linear-gradient(to bottom, #3a3a4d, #2a2a3d)';

                            data.invitations.forEach(invitation => {
                                const invitationCard = document.createElement('div');
                                invitationCard.style.cssText = 'background: #191A1F; border-radius: 8px; padding: 1rem; display: flex; align-items: center; gap: 1rem;';

                                // Avatar - show initials from adzsend_id
                                const avatarDiv = document.createElement('div');
                                const initials = (invitation.owner_adzsend_id || '??').substring(0, 2);
                                avatarDiv.innerHTML = `<div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #15d8bc, #006e59); display: flex; align-items: center; justify-content: center; color: #fff; font-weight: 600; font-size: 0.9rem;">${initials}</div>`;

                                // Info - show adzsend_id only
                                const infoDiv = document.createElement('div');
                                infoDiv.style.cssText = 'flex: 1;';
                                infoDiv.innerHTML = `
                                    <div style="color: #dcddde; font-weight: 500; font-family: monospace;">${invitation.owner_adzsend_id || 'No ID'}</div>
                                    <div style="color: #81828A; font-size: 0.85rem;">Team invitation</div>
                                `;

                                // Actions
                                const actionsDiv = document.createElement('div');
                                actionsDiv.style.cssText = 'display: flex; gap: 0.5rem;';

                                const joinBtn = document.createElement('button');
                                joinBtn.innerHTML = '<img src="/static/tick.png" style="width: 16px; height: 16px; filter: brightness(0.5) opacity(0.7);">';
                                joinBtn.className = 'team-join-btn';
                                joinBtn.style.cssText = 'width: 28px; height: 28px; background: transparent; border: none; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease;';
                                joinBtn.dataset.memberId = invitation.id;
                                joinBtn.dataset.confirmed = 'false';

                                const denyBtn = document.createElement('button');
                                denyBtn.innerHTML = '';
                                denyBtn.className = 'team-deny-btn';
                                denyBtn.style.cssText = 'width: 28px; height: 28px; background: transparent; border: none; border-radius: 4px; color: #991a35; cursor: pointer; font-size: 1rem; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease;';
                                denyBtn.dataset.memberId = invitation.id;

                                if (acceptedInvitation) {
                                    joinBtn.disabled = true;
                                    joinBtn.style.opacity = '0.5';
                                    joinBtn.style.cursor = 'not-allowed';
                                }

                                joinBtn.addEventListener('click', () => {
                                    if (joinBtn.dataset.confirmed === 'false') {
                                        joinBtn.dataset.confirmed = 'true';
                                        joinBtn.innerHTML = '<img src="/static/tick.png" style="width: 14px; height: 14px; filter: brightness(0.5) opacity(0.7);"><img src="/static/tick.png" style="width: 14px; height: 14px; filter: brightness(0.5) opacity(0.7); margin-left: -4px;">';
                                        joinBtn.style.background = 'rgba(21, 216, 188, 0.2)';

                                        // Auto-reset after 3 seconds
                                        setTimeout(() => {
                                            if (joinBtn.dataset.confirmed === 'true') {
                                                joinBtn.dataset.confirmed = 'false';
                                                joinBtn.innerHTML = '<img src="/static/tick.png" style="width: 16px; height: 16px; filter: brightness(0.5) opacity(0.7);">';
                                                joinBtn.style.background = 'transparent';
                                            }
                                        }, 3000);
                                    } else {
                                        acceptInvitation(invitation.id);
                                    }
                                });
                                denyBtn.addEventListener('click', () => denyInvitation(invitation.id));

                                // Hover effect for join button
                                joinBtn.addEventListener('mouseenter', () => {
                                    joinBtn.style.background = 'rgba(21, 216, 188, 0.2)';
                                    joinBtn.style.transform = 'scale(1.1)';
                                });
                                joinBtn.addEventListener('mouseleave', () => {
                                    if (joinBtn.dataset.confirmed === 'false') {
                                        joinBtn.style.background = 'transparent';
                                    }
                                    joinBtn.style.transform = 'scale(1)';
                                });

                                // Hover effect for deny button
                                denyBtn.addEventListener('mouseenter', () => {
                                    denyBtn.style.background = 'rgba(231, 76, 60, 0.2)';
                                    denyBtn.style.transform = 'scale(1.1)';
                                });
                                denyBtn.addEventListener('mouseleave', () => {
                                    denyBtn.style.background = 'transparent';
                                    denyBtn.style.transform = 'scale(1)';
                                });

                                actionsDiv.appendChild(joinBtn);
                                actionsDiv.appendChild(denyBtn);

                                invitationCard.appendChild(avatarDiv);
                                invitationCard.appendChild(infoDiv);
                                invitationCard.appendChild(actionsDiv);

                                invitationsList.appendChild(invitationCard);
                            });
                        } else {
                            invitationsList.innerHTML = '<div style="color: #81828A; font-size: 0.9rem; text-align: center; padding: 2rem;">No pending invitations</div>';
                            clearAllBtn.disabled = true;
                            clearAllBtn.style.opacity = '0.5';
                            clearAllBtn.style.cursor = 'not-allowed';
                        }
                    }
                })
                .catch(error => console.error('Error loading invitations:', error));
        }

        async function acceptInvitation(memberId) {
            try {
                const response = await fetch(`/api/team/invitation/accept/${memberId}`, { method: 'POST', headers: { 'X-CSRF-Token': '{{ csrf_token }}' } });
                const data = await response.json();
                if (data.success) {
                    acceptedInvitation = true;
                    await showAlert('Team invitation accepted!', 'Success');
                    loadTeamInvitations();
                    loadCurrentTeam();
                } else {
                    await showAlert('Error: ' + data.error, 'Error');
                }
            } catch (error) {
                await showAlert('Error accepting invitation: ' + error, 'Error');
            }
        }

        async function denyInvitation(memberId) {
            try {
                const response = await fetch(`/api/team/invitation/deny/${memberId}`, { method: 'POST', headers: { 'X-CSRF-Token': '{{ csrf_token }}' } });
                const data = await response.json();
                if (data.success) {
                    loadTeamInvitations();
                } else {
                    await showAlert('Error: ' + data.error, 'Error');
                }
            } catch (error) {
                await showAlert('Error denying invitation: ' + error, 'Error');
            }
        }

        function loadCurrentTeam() {
            fetch('/api/team/current')
                .then(response => response.json())
                .then(data => {
                    const currentTeamContent = document.getElementById('current-team-content');
                    const invitationsList = document.getElementById('invitations-list');

                    if (data.success && data.is_owner) {
                        // User is a business plan owner - show their own team card (like members see)
                        const owner = data.owner_info;

                        // Update invitations list to show owner can't join other teams
                        if (invitationsList) {
                            invitationsList.innerHTML = '<div style="color: #81828A; font-size: 0.9rem; text-align: center; padding: 2rem;">Team owner, can\'t join other teams</div>';
                        }
                        // Disable clear all button
                        const clearAllBtn = document.getElementById('clearAllInvitationsBtn');
                        if (clearAllBtn) {
                            clearAllBtn.disabled = true;
                            clearAllBtn.style.opacity = '0.5';
                            clearAllBtn.style.cursor = 'not-allowed';
                        }

                        // Show owner's own team card (like members see, but without leave button)
                        const ownerInitials = (owner.adzsend_id || '??').substring(0, 2);
                        const avatarHtml = `<div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #15d8bc, #006e59); display: flex; align-items: center; justify-content: center; color: #fff; font-weight: 600; font-size: 0.9rem;">${ownerInitials}</div>`;

                        currentTeamContent.innerHTML = `
                            <div style="color: #81828A; font-size: 0.85rem; margin-bottom: 0.75rem;">You're the team owner of</div>
                            <div style="background: #191A1F; border-radius: 8px; padding: 1rem; display: flex; align-items: center; gap: 1rem;">
                                <div>${avatarHtml}</div>
                                <div style="flex: 1;">
                                    <div style="color: #dcddde; font-weight: 500; font-family: monospace;">${owner.adzsend_id || 'No ID'}</div>
                                    <div style="color: #81828A; font-size: 0.85rem;">Your team</div>
                                </div>
                                <span style="background: linear-gradient(to bottom, #15d8bc, #006e59); color: #121215; font-size: 0.6rem; padding: 0.15rem 0.4rem; border-radius: 3px; font-weight: 500; line-height: 1.2;">Owner</span>
                            </div>
                        `;
                    } else if (data.success && data.in_team) {
                        const team = data.team;
                        acceptedInvitation = true;

                        // Create team owner card with leave button
                        const teamOwnerInitials = (team.owner_adzsend_id || '??').substring(0, 2);
                        const avatarHtml = `<div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #15d8bc, #006e59); display: flex; align-items: center; justify-content: center; color: #fff; font-weight: 600; font-size: 0.9rem;">${teamOwnerInitials}</div>`;

                        currentTeamContent.innerHTML = `
                            <div style="color: #81828A; font-size: 0.85rem; margin-bottom: 0.75rem;">You're a team member of</div>
                            <div style="background: #191A1F; border-radius: 8px; padding: 1rem; display: flex; align-items: center; gap: 1rem;">
                                <div>${avatarHtml}</div>
                                <div style="flex: 1;">
                                    <div style="color: #dcddde; font-weight: 500; font-family: monospace;">${team.owner_adzsend_id || 'No ID'}</div>
                                    <div style="color: #81828A; font-size: 0.85rem;">Team owner</div>
                                </div>
                                <button id="leaveTeamBtn" class="delete-account-btn" style="padding: 0.5rem 1rem; font-size: 0.85rem;">Leave</button>
                            </div>
                        `;

                        // Attach leave button handler
                        document.getElementById('leaveTeamBtn').addEventListener('click', handleLeaveTeam);
                    } else {
                        acceptedInvitation = false;
                        currentTeamContent.innerHTML = '<div id="no-team-status" style="color: #81828A; font-size: 0.85rem;">Not in any team</div>';
                    }
                })
                .catch(error => {
                    console.error('Error loading current team:', error);
                    document.getElementById('current-team-content').innerHTML = '<div style="color: #81828A; font-size: 0.85rem;">Not in any team</div>';
                });
        }

        async function handleLeaveTeam() {
            const leaveBtn = document.getElementById('leaveTeamBtn');

            const confirmed = await showConfirm('Leave your current team? You will need to accept a new invitation to join another team.', 'Leave Team', { danger: true, confirmText: 'Leave Team' });
            if (!confirmed) return;

            leaveBtn.textContent = 'Leaving...';
            leaveBtn.disabled = true;

            try {
                const response = await fetch('/api/team/leave', { method: 'POST', headers: { 'X-CSRF-Token': '{{ csrf_token }}' } });
                const data = await response.json();
                if (data.success) {
                    await showAlert('Left team successfully', 'Success');
                    acceptedInvitation = false;
                    loadCurrentTeam();
                    loadTeamInvitations();
                } else {
                    await showAlert('Error: ' + data.error, 'Error');
                    leaveBtn.textContent = 'Leave';
                    leaveBtn.disabled = false;
                }
            } catch (error) {
                await showAlert('Error leaving team: ' + error, 'Error');
                leaveBtn.textContent = 'Leave';
                leaveBtn.disabled = false;
            }
        }

        // Clear all invitations
        document.getElementById('clearAllInvitationsBtn').addEventListener('click', async () => {
            const confirmed = await showConfirm('Clear all pending team invitations?', 'Clear Invitations');
            if (confirmed) {
                try {
                    const response = await fetch('/api/team/invitations/clear', { method: 'POST', headers: { 'X-CSRF-Token': '{{ csrf_token }}' } });
                    const data = await response.json();
                    if (data.success) {
                        loadTeamInvitations();
                    } else {
                        await showAlert('Error: ' + data.error, 'Error');
                    }
                } catch (error) {
                    await showAlert('Error clearing invitations: ' + error, 'Error');
                }
            }
        });

        // Load invitations on page load
        loadTeamInvitations();
        loadCurrentTeam();

        // Billing toggle functionality
        const billingViewRadios = document.querySelectorAll('input[name="billing-view"]');
        const billingPlanInfo = document.getElementById('billing-plan-info');
        const billingInvoices = document.getElementById('billing-invoices');

        billingViewRadios.forEach(radio => {
            radio.addEventListener('change', () => {
                const view = radio.value;

                // Toggle sections
                if (view === 'plan-info') {
                    billingPlanInfo.style.display = 'flex';
                    billingInvoices.style.display = 'none';
                } else {
                    billingPlanInfo.style.display = 'none';
                    billingInvoices.style.display = 'flex';
                }
            });
        });

        // Invoice view button handlers
        document.querySelectorAll('.invoice-view-btn').forEach(btn => {
            btn.addEventListener('click', async () => {
                const invoiceId = btn.dataset.invoiceId;
                await showAlert('Coming soon', 'Invoice Details');
            });
        });

        // =====================================================================
        // DISCORD ACCOUNT LINKING
        // =====================================================================

        // Token visibility toggle
        const toggleTokenBtn = document.getElementById('toggle-token-visibility');
        const tokenInput = document.getElementById('discord-token-input');
        const eyeView = document.getElementById('eye-icon-view');
        const eyeHide = document.getElementById('eye-icon-hide');

        if (toggleTokenBtn && tokenInput) {
            toggleTokenBtn.addEventListener('click', () => {
                const isPassword = tokenInput.type === 'password';
                tokenInput.type = isPassword ? 'text' : 'password';
                if (eyeView && eyeHide) {
                    eyeView.style.display = isPassword ? 'none' : 'block';
                    eyeHide.style.display = isPassword ? 'block' : 'none';
                }
            });
        }

        // Discord OAuth button
        const discordOAuthBtn = document.getElementById('discord-oauth-btn');
        if (discordOAuthBtn) {
            discordOAuthBtn.addEventListener('click', async () => {
                discordOAuthBtn.disabled = true;
                discordOAuthBtn.innerHTML = '<div class="loading-spinner" style="width: 18px; height: 18px; border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: #fff; animation: spin 1s linear infinite;"></div> <span>Connecting...</span>';

                try {
                    const response = await fetch('/api/discord/auth-url');
                    const data = await response.json();

                    if (data.success && data.auth_url) {
                        window.location.href = data.auth_url;
                    } else {
                        await showAlert('Error: ' + (data.error || 'Failed to get authorization URL'), 'Error');
                        discordOAuthBtn.disabled = false;
                        discordOAuthBtn.innerHTML = '<img src="{{ url_for('static', filename='link.png') }}" alt="" style="width: 18px; height: 18px; filter: brightness(0) invert(1);"> {% if discord_oauth_info and discord_oauth_info.has_oauth %}Change account{% else %}Link account{% endif %}';
                    }
                } catch (error) {
                    console.error('OAuth error:', error);
                    await showAlert('Error connecting to Discord. Please try again.', 'Error');
                    discordOAuthBtn.disabled = false;
                    discordOAuthBtn.innerHTML = '<img src="{{ url_for('static', filename='link.png') }}" alt="" style="width: 18px; height: 18px; filter: brightness(0) invert(1);"> {% if discord_oauth_info and discord_oauth_info.has_oauth %}Change account{% else %}Link account{% endif %}';
                }
            });
        }

        // Discord Unlink button
        const discordUnlinkBtn = document.getElementById('discord-unlink-btn');
        if (discordUnlinkBtn) {
            discordUnlinkBtn.addEventListener('click', async () => {
                const confirmed = await showConfirm('Are you sure you want to unlink your Discord account? This will remove your token and you will need to link again to use the panel.');
                if (!confirmed) return;

                discordUnlinkBtn.disabled = true;
                discordUnlinkBtn.innerHTML = '<div class="loading-spinner" style="width: 14px; height: 14px; border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: #fff; animation: spin 1s linear infinite;"></div>';

                try {
                    const response = await fetch('/api/discord/unlink', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        }
                    });
                    const data = await response.json();

                    if (data.success) {
                        await showAlert('Discord account unlinked successfully.', 'Success');
                        window.location.reload();
                    } else {
                        await showAlert('Error: ' + (data.error || 'Failed to unlink account'), 'Error');
                        discordUnlinkBtn.disabled = false;
                        discordUnlinkBtn.innerHTML = "<img src=\"{{ url_for('static', filename='link.png') }}\" alt=\"\" style=\"width: 14px; height: 14px; filter: brightness(0) invert(1);\"> Unlink";
                    }
                } catch (error) {
                    console.error('Unlink error:', error);
                    await showAlert('Error unlinking account. Please try again.', 'Error');
                    discordUnlinkBtn.disabled = false;
                    discordUnlinkBtn.innerHTML = "<img src=\"{{ url_for('static', filename='link.png') }}\" alt=\"\" style=\"width: 14px; height: 14px; filter: brightness(0) invert(1);\"> Unlink";
                }
            });
        }

        // Token verification and linking
        const completeLinkBtn = document.getElementById('discord-complete-link-btn');
        const tokenStatusLabel = document.getElementById('token-status-label');
        const tokenStatusText = document.getElementById('token-status-text');
        const tokenStatusIcon = document.getElementById('token-status-icon');
        let tokenVerified = false;

        // Helper to update token status label
        function updateTokenStatus(status, message) {
            if (!tokenStatusLabel || !tokenStatusText) return;

            if (status === 'default') {
                tokenStatusLabel.style.color = '#faa61a';
                tokenStatusText.textContent = 'Token must match the Discord account you authorized above';
                tokenStatusIcon.innerHTML = '<path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>';
            } else if (status === 'verifying') {
                tokenStatusLabel.style.color = '#faa61a';
                tokenStatusText.textContent = 'Verifying token...';
                tokenStatusIcon.innerHTML = '<path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>';
            } else if (status === 'success') {
                tokenStatusLabel.style.color = '#57f287';
                tokenStatusText.textContent = 'Token verified! Click Link to complete.';
                tokenStatusIcon.innerHTML = '<polyline points="20 6 9 17 4 12" fill="none" stroke="currentColor" stroke-width="2"/>';
            } else if (status === 'error') {
                tokenStatusLabel.style.color = '#faa61a';
                tokenStatusText.textContent = message || 'Token must match the Discord account you authorized above';
                tokenStatusIcon.innerHTML = '<path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>';
            }
        }

        if (tokenInput && completeLinkBtn) {
            // Verify token on input change (debounced)
            let verifyTimeout;
            tokenInput.addEventListener('input', () => {
                clearTimeout(verifyTimeout);
                tokenVerified = false;
                completeLinkBtn.disabled = true;
                completeLinkBtn.style.opacity = '0.5';
                completeLinkBtn.style.cursor = 'not-allowed';

                const token = tokenInput.value.trim();

                // Check for quotation marks in token
                if (token.includes('"')) {
                    tokenStatusLabel.style.display = 'flex';
                    tokenStatusText.textContent = 'Remove the quotation marks (")';
                    tokenStatusIcon.style.display = 'block';
                    tokenStatusLabel.style.color = '#faa61a';
                    return;
                }

                if (token.length < 50) {
                    updateTokenStatus('default');
                    return;
                }

                updateTokenStatus('verifying');

                verifyTimeout = setTimeout(async () => {
                    try {
                        const response = await fetch('/api/discord/verify-token', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRF-Token': '{{ csrf_token }}'
                            },
                            body: JSON.stringify({ token: token })
                        });

                        const data = await response.json();

                        if (data.success) {
                            tokenVerified = true;
                            completeLinkBtn.disabled = false;
                            completeLinkBtn.style.opacity = '1';
                            completeLinkBtn.style.cursor = 'pointer';
                            updateTokenStatus('success');
                        } else {
                            tokenVerified = false;
                            updateTokenStatus('error');
                        }
                    } catch (error) {
                        console.error('Token verify error:', error);
                        tokenVerified = false;
                        updateTokenStatus('error');
                    }
                }, 500);
            });

            // Complete linking
            completeLinkBtn.addEventListener('click', async () => {
                if (!tokenVerified) {
                    await showAlert('Please verify your token first.', 'Token Required');
                    return;
                }

                const token = tokenInput.value.trim();
                completeLinkBtn.disabled = true;
                completeLinkBtn.textContent = 'Linking...';

                try {
                    const response = await fetch('/api/discord/link', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRF-Token': '{{ csrf_token }}'
                        },
                        body: JSON.stringify({ token: token })
                    });

                    const data = await response.json();

                    if (data.success) {
                        await showAlert('Discord account linked successfully!', 'Success');
                        window.location.reload();
                    } else {
                        await showAlert('Error: ' + (data.error || 'Failed to link account'), 'Error');
                        completeLinkBtn.disabled = false;
                        completeLinkBtn.textContent = 'Link';
                    }
                } catch (error) {
                    console.error('Link error:', error);
                    await showAlert('Error linking account. Please try again.', 'Error');
                    completeLinkBtn.disabled = false;
                    completeLinkBtn.textContent = 'Link';
                }
            });
        }

        // Check for OAuth success/error messages in URL
        const urlParams = new URLSearchParams(window.location.search);
        const discordSuccess = urlParams.get('discord_success');
        const discordError = urlParams.get('discord_error');

        if (discordSuccess) {
            // Remove query param from URL
            window.history.replaceState({}, document.title, window.location.pathname);
        }

        if (discordError) {
            showAlert('Discord Error: ' + decodeURIComponent(discordError), 'Discord Error');
            window.history.replaceState({}, document.title, window.location.pathname);
        }
    </script>

    {% include 'partials/settings_popup.html' %}
</body>
</html>
