<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ site_config.page_titles.support if site_config and site_config.page_titles else 'Support - Adzsend' }}</title>

    <!-- SEO Meta Tags -->
    <meta name="description" content="{{ get_page_description('support') if get_page_description else 'Get support for Adzsend' }}">

    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='responsive.css') }}">
    {% include 'partials/config_styles.html' %}
    <script src="{{ url_for('static', filename='custom_popup.js') }}"></script>
    {% include 'partials/base_scripts.html' %}
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #121215;
            color: #ffffff;
            font-family: 'gg sans', 'Noto Sans', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            overflow: hidden;
            height: 100vh;
        }

        .page-wrapper {
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        .page-scroll-container {
            flex: 1;
            overflow-y: auto;
            padding-top: 60px;
        }
    </style>
</head>
<body>
    <div class="page-wrapper">
        {% include 'navbar.html' %}

        <div class="page-scroll-container">
            <div class="support-content">
                <!-- Hero Section -->
                <div class="support-hero">
                    <h1 class="support-hero-title">{{ support_hero_title }}</h1>
                </div>

                <!-- Message Checker Section -->
                <div class="message-checker-section">
                    <input type="text"
                           id="message-link-input"
                           class="search-input message-checker-input"
                           placeholder="Discord message link"
                           autocomplete="off">
                    <p id="message-checker-result" class="message-checker-label">Check if a message was sent with Adzsend (no message over 5 days old)</p>
                </div>

                <!-- FAQ Section -->
                <div class="support-faq-section">
                    <h2 class="support-faq-title">{{ support_faq_title }}</h2>

                    <div class="faq-list">
                        {% for faq in faq_items %}
                        <div class="faq-item">
                            <div class="faq-question" onclick="toggleFaq(this)">
                                <span class="faq-question-text">{{ faq.question }}</span>
                                <img src="{{ url_for('static', filename='openorclose.png') }}" alt="Toggle" class="faq-toggle-icon">
                            </div>
                            <div class="faq-answer">
                                <div class="faq-answer-divider"></div>
                                <p>{{ faq.answer }}</p>
                            </div>
                        </div>
                        {% endfor %}
                    </div>

                    <!-- Contact Support -->
                    <div class="support-contact">
                        <p class="support-contact-text">{{ support_contact_text }}</p>
                        <a href="{{ discord_server_url }}" target="_blank" class="discord-btn">
                            <img src="{{ url_for('static', filename='discordlogo.png') }}" alt="Discord" class="discord-btn-icon">
                            Contact support
                        </a>
                    </div>
                </div>

            </div>

            {% include 'partials/footer.html' %}
        </div>
    </div>

    <script>
        function toggleFaq(element) {
            const faqItem = element.parentElement;
            const answer = faqItem.querySelector('.faq-answer');

            // Close all other FAQs
            document.querySelectorAll('.faq-item').forEach(item => {
                if (item !== faqItem && item.classList.contains('active')) {
                    item.classList.remove('active');
                    item.querySelector('.faq-answer').style.maxHeight = '0';
                }
            });

            // Toggle current FAQ
            faqItem.classList.toggle('active');

            if (faqItem.classList.contains('active')) {
                answer.style.maxHeight = answer.scrollHeight + 'px';
            } else {
                answer.style.maxHeight = '0';
            }
        }

        // Message checker functionality
        (function() {
            const input = document.getElementById('message-link-input');
            const result = document.getElementById('message-checker-result');
            const defaultText = 'Check if a message was sent with Adzsend (no message over 5 days old)';

            // Client-side validation pattern
            const discordLinkPattern = /^https?:\/\/(?:(?:ptb|canary)\.)?discord(?:app)?\.com\/channels\/\d+\/\d+\/\d+$/;

            let debounceTimer = null;
            let lastCheckedLink = '';

            async function checkMessage() {
                const link = input.value.trim();

                // Don't re-check the same link
                if (link === lastCheckedLink) return;
                lastCheckedLink = link;

                if (!link) {
                    result.textContent = defaultText;
                    result.className = 'message-checker-label';
                    return;
                }

                // Client-side validation first
                if (!discordLinkPattern.test(link)) {
                    result.textContent = 'Invalid Discord message link';
                    result.className = 'message-checker-label';
                    return;
                }

                try {
                    const response = await fetch('/api/check-message', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message_link: link })
                    });

                    const data = await response.json();

                    // Make sure input hasn't changed during fetch
                    if (input.value.trim() !== link) return;

                    if (data.status === 'found') {
                        result.textContent = 'Message sent using Adzsend';
                        result.className = 'message-checker-label message-checker-found';
                    } else if (data.status === 'invalid') {
                        result.textContent = 'Invalid Discord message link';
                        result.className = 'message-checker-label';
                    } else {
                        result.textContent = "We can't find this message, this either means it was not sent with Adzsend or is over 5 days old";
                        result.className = 'message-checker-label';
                    }
                } catch (error) {
                    result.textContent = 'Error checking message';
                    result.className = 'message-checker-label';
                }
            }

            // Auto-check on input with debounce
            input.addEventListener('input', () => {
                clearTimeout(debounceTimer);
                const link = input.value.trim();

                if (!link) {
                    result.textContent = defaultText;
                    result.className = 'message-checker-label';
                    lastCheckedLink = '';
                    return;
                }

                // Only debounce if it looks like a valid link pattern
                if (discordLinkPattern.test(link)) {
                    debounceTimer = setTimeout(checkMessage, 300);
                } else {
                    result.textContent = 'Invalid Discord message link';
                    result.className = 'message-checker-label';
                }
            });
        })();
    </script>

    {% include 'partials/settings_popup.html' %}
</body>
</html>
