<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ site_config.page_titles.support if site_config and site_config.page_titles else 'Support - Adzsend' }}</title>

    <!-- SEO Meta Tags -->
    <meta name="description" content="{{ get_page_description('support') if get_page_description else 'Get support for Adzsend' }}">

    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='responsive.css') }}">
    {% include 'partials/config_styles.html' %}
    <script src="{{ url_for('static', filename='custom_popup.js') }}"></script>
    {% include 'partials/base_scripts.html' %}
    <style>
        /* ABC Ginto Nord font */
        @font-face {
            font-family: 'ABC Ginto Nord';
            src: url('{{ url_for("static", filename="fonts/ABCGintoNord-Black-Trial.otf") }}') format('opentype');
        }

        body {
            margin: 0;
            padding: 0;
            background-color: #121215;
            color: #ffffff;
            font-family: 'gg sans', 'Noto Sans', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            overflow: hidden;
            height: 100vh;
        }

        .page-wrapper {
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        .page-scroll-container {
            flex: 1;
            overflow-y: auto;
            padding-top: 60px;
            background: #121215;
        }

        /* Gap variable - consistent spacing (same as homepage) */
        :root {
            --section-gap: 240px;
        }

        /* ==================== HERO SECTION ==================== */
        /* Same positioning as homepage */
        .support-hero {
            max-width: 900px;
            margin: 0 auto;
            padding: 30px 30px 0 30px;
            text-align: center;
        }

        .support-hero-title {
            font-size: 48px;
            font-family: 'ABC Ginto Nord', 'gg sans Bold', sans-serif !important;
            color: #ffffff;
            text-align: center;
            line-height: 1.4;
            letter-spacing: -0.5px;
            margin: 0;
            white-space: pre-line;
        }

        /* ==================== MESSAGE CHECKER SECTION ==================== */
        .message-checker-section {
            max-width: 924px;
            margin: var(--section-gap) auto 0 auto;
            padding: 0 30px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .message-checker-section .message-checker-input {
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
        }

        .message-checker-label {
            font-size: 0.875rem;
            color: #72767d;
            text-align: center;
            margin: 12px 0 0 0;
        }

        .message-checker-label.message-checker-found {
            color: #15d8bc;
        }

        /* ==================== FAQ SECTION ==================== */
        .support-faq-section {
            max-width: 924px;
            margin: var(--section-gap) auto 0 auto;
            padding: 0 30px;
            display: flex;
            flex-direction: column;
        }

        .support-faq-title {
            font-size: 1.225rem;
            font-weight: 400;
            color: #ffffff;
            text-align: center;
            margin: 0 0 40px 0;
        }

        /* FAQ List */
        .faq-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            width: 100%;
        }

        /* FAQ Item - pill style with configurable gradient */
        .faq-item {
            border-radius: 24px;
            overflow: hidden;
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: none;
        }

        /* FAQ Question */
        .faq-question {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.25rem 1.75rem;
            cursor: pointer;
            user-select: none;
        }

        .faq-question-text {
            font-size: 1rem;
            font-weight: 500;
            color: #ffffff;
            font-family: 'gg sans Medium', sans-serif;
        }

        .faq-toggle-icon {
            width: 20px;
            height: 20px;
            transition: transform 0.3s ease;
            flex-shrink: 0;
            margin-left: 1rem;
            transform: rotate(-90deg);
        }

        .faq-item.active .faq-toggle-icon {
            transform: rotate(0deg);
        }

        /* FAQ Answer */
        .faq-answer {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .faq-answer p {
            padding: 1.25rem 1.75rem 1.5rem 1.75rem;
            margin: 0;
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.95rem;
            line-height: 1.6;
            font-family: 'gg sans Medium', sans-serif;
        }

        /* ==================== CONTACT SUPPORT SECTION ==================== */
        .support-contact {
            max-width: 924px;
            margin: 1rem auto var(--section-gap) auto;
            padding: 0 30px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.5rem;
            border-top: none !important;
            padding-top: 0 !important;
        }

        .support-contact-text {
            font-size: 1.1rem;
            color: #dcddde;
            text-align: center;
            margin: 0;
            font-family: 'gg sans Medium', sans-serif;
        }

        /* ==================== RESPONSIVE ==================== */
        /* Mobile */
        @media (max-width: 900px) {
            .support-hero {
                padding: 20px 20px 0 20px;
            }

            .support-hero-title {
                font-size: 32px;
            }

            .message-checker-section,
            .support-faq-section,
            .support-contact {
                padding: 0 20px;
            }

            .support-faq-title {
                font-size: 1rem;
                margin-bottom: 30px;
            }

            .faq-item {
                border-radius: 20px;
            }

            .faq-question {
                padding: 1rem 1.25rem;
            }

            .faq-question-text {
                font-size: 0.95rem;
            }

            .faq-answer p {
                padding: 1rem 1.25rem 1.25rem 1.25rem;
                font-size: 0.9rem;
            }

            .support-contact-text {
                font-size: 1rem;
            }

            .message-checker-label {
                font-size: 0.8rem;
            }
        }

        /* Small mobile */
        @media (max-width: 600px) {
            .support-hero-title {
                font-size: 26px;
            }

            .support-faq-title {
                font-size: 0.9rem;
                margin-bottom: 24px;
            }

            .faq-item {
                border-radius: 16px;
            }

            .faq-question {
                padding: 1rem;
            }

            .faq-question-text {
                font-size: 0.9rem;
            }

            .faq-answer p {
                padding: 0.875rem 1rem 1rem 1rem;
                font-size: 0.85rem;
            }

            .support-contact-text {
                font-size: 0.95rem;
            }

            .message-checker-label {
                font-size: 0.75rem;
            }
        }
    </style>
</head>
<body>
    <div class="page-wrapper">
        {% include 'navbar.html' %}

        <div class="page-scroll-container">
            <!-- Hero Section - same position as homepage -->
            <section class="support-hero">
                <h1 class="support-hero-title">{{ support_hero_title }}</h1>
            </section>

            <!-- Message Checker Section -->
            <section class="message-checker-section">
                <input type="text"
                       id="message-link-input"
                       class="search-input message-checker-input"
                       placeholder="Discord message link"
                       autocomplete="off">
                <p id="message-checker-result" class="message-checker-label">Check if a message was sent with Adzsend (no message over 5 days old)</p>
            </section>

            <!-- FAQ Section -->
            <section class="support-faq-section">
                <h2 class="support-faq-title">{{ support_faq_title }}</h2>

                <div class="faq-list">
                    {% for faq in faq_items %}
                    <div class="faq-item" style="background: {% if faq.gradient is defined and faq.gradient %}linear-gradient({{ faq.gradient_rotation | default(135) }}deg, {{ faq.color_start | default('rgba(255, 255, 255, 0.1)') }}, {{ faq.color_end | default('rgba(255, 255, 255, 0.02)') }}){% else %}{{ faq.color_start | default('rgba(255, 255, 255, 0.1)') }}{% endif %};">
                        <div class="faq-question" onclick="toggleFaq(this)">
                            <span class="faq-question-text">{{ faq.question }}</span>
                            <img src="{{ url_for('static', filename='openorclose.png') }}" alt="Toggle" class="faq-toggle-icon">
                        </div>
                        <div class="faq-answer">
                            <p>{{ faq.answer }}</p>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </section>

            <!-- Contact Support -->
            <section class="support-contact">
                <p class="support-contact-text">{{ support_contact_text }}</p>
                <a href="{{ discord_server_url }}" target="_blank" class="discord-btn">
                    <img src="{{ url_for('static', filename='discordlogo.png') }}" alt="Discord" class="discord-btn-icon">
                    Contact support
                </a>
            </section>

            {% include 'partials/footer.html' %}
        </div>
    </div>

    <script>
        function toggleFaq(element) {
            const faqItem = element.parentElement;
            const answer = faqItem.querySelector('.faq-answer');

            // Close all other FAQs
            document.querySelectorAll('.faq-item').forEach(item => {
                if (item !== faqItem && item.classList.contains('active')) {
                    item.classList.remove('active');
                    item.querySelector('.faq-answer').style.maxHeight = '0';
                }
            });

            // Toggle current FAQ
            faqItem.classList.toggle('active');

            if (faqItem.classList.contains('active')) {
                answer.style.maxHeight = answer.scrollHeight + 'px';
            } else {
                answer.style.maxHeight = '0';
            }
        }

        // Message checker functionality
        (function() {
            const input = document.getElementById('message-link-input');
            const result = document.getElementById('message-checker-result');
            const defaultText = 'Check if a message was sent with Adzsend (no message over 5 days old)';

            // Client-side validation pattern
            const discordLinkPattern = /^https?:\/\/(?:(?:ptb|canary)\.)?discord(?:app)?\.com\/channels\/\d+\/\d+\/\d+$/;

            let debounceTimer = null;
            let lastCheckedLink = '';

            // Rate limiting: 5 checks per 10 seconds
            const RATE_LIMIT_MAX = 5;
            const RATE_LIMIT_WINDOW = 10000; // 10 seconds in ms
            let checkTimestamps = [];

            function isRateLimited() {
                const now = Date.now();
                // Remove timestamps older than the window
                checkTimestamps = checkTimestamps.filter(ts => now - ts < RATE_LIMIT_WINDOW);
                return checkTimestamps.length >= RATE_LIMIT_MAX;
            }

            function recordCheck() {
                checkTimestamps.push(Date.now());
            }

            async function checkMessage() {
                const link = input.value.trim();

                // Don't re-check the same link
                if (link === lastCheckedLink) return;

                if (!link) {
                    result.textContent = defaultText;
                    result.className = 'message-checker-label';
                    lastCheckedLink = '';
                    return;
                }

                // Client-side validation first
                if (!discordLinkPattern.test(link)) {
                    result.textContent = 'Invalid Discord message link';
                    result.className = 'message-checker-label';
                    return;
                }

                // Check rate limit before making API call
                if (isRateLimited()) {
                    await customAlert(
                        'Slow down',
                        "You're checking message links too quickly. To copy message links, right click or press and hold the message to bring up the Discord action menu, and press copy message link.",
                        'Enter the chill zone'
                    );
                    return;
                }

                // Record this check for rate limiting
                recordCheck();
                lastCheckedLink = link;

                try {
                    const response = await fetch('/api/check-message', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message_link: link })
                    });

                    const data = await response.json();

                    // Make sure input hasn't changed during fetch
                    if (input.value.trim() !== link) return;

                    if (data.status === 'found') {
                        result.textContent = 'Message sent using Adzsend';
                        result.className = 'message-checker-label message-checker-found';
                    } else if (data.status === 'invalid') {
                        result.textContent = 'Invalid Discord message link';
                        result.className = 'message-checker-label';
                    } else {
                        result.textContent = "We can't find this message, this either means it was not sent with Adzsend or is over 5 days old";
                        result.className = 'message-checker-label';
                    }
                } catch (error) {
                    result.textContent = 'Error checking message';
                    result.className = 'message-checker-label';
                }
            }

            // Auto-check on input with debounce
            input.addEventListener('input', () => {
                clearTimeout(debounceTimer);
                const link = input.value.trim();

                if (!link) {
                    result.textContent = defaultText;
                    result.className = 'message-checker-label';
                    lastCheckedLink = '';
                    return;
                }

                // Only debounce if it looks like a valid link pattern
                if (discordLinkPattern.test(link)) {
                    debounceTimer = setTimeout(checkMessage, 300);
                } else {
                    result.textContent = 'Invalid Discord message link';
                    result.className = 'message-checker-label';
                }
            });
        })();
    </script>

    {% include 'partials/settings_popup.html' %}
</body>
</html>
