<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team Management - Adzsend</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='responsive.css') }}">
    {% include 'partials/config_styles.html' %}
    <script src="{{ url_for('static', filename='tab_enforcement.js') }}"></script>
    <script src="{{ url_for('static', filename='status_polling.js') }}"></script>
    <script>
        window.DB_VERSION = {{ db_version }};
        window.DB_WIPE_MESSAGE = "{{ db_wipe_message }}";
    </script>
    <script src="{{ url_for('static', filename='db_wipe_notice.js') }}"></script>
    <script src="{{ url_for('static', filename='custom_modals.js') }}"></script>
</head>
<body>
    <div class="panel">
        <nav class="navbar">
            <div class="navbar-content">
                <div class="navbar-left">
                    <div class="menu-icon" id="menu-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="3" y1="12" x2="21" y2="12"></line>
                            <line x1="3" y1="6" x2="21" y2="6"></line>
                            <line x1="3" y1="18" x2="21" y2="18"></line>
                        </svg>
                    </div>
                    <div class="navbar-text">
                        <h1 class="navbar-title">Ad <span class="gradient-z">Z</span> send</h1>
                        <p class="navbar-subtitle">Manage your team and set a message for your team to use</p>
                    </div>
                </div>
                {% if user %}
                <div class="nav-right">
                    <div style="display: flex; flex-direction: row; align-items: center; gap: 12px; background: #1A1A1E; padding: 8px 12px; border-radius: 8px; box-shadow: none;">
                        <div style="width: 32px; height: 32px; border-radius: 50%; background: #ff3333; flex-shrink: 0;"></div>
                        <span style="color: #dcddde; font-size: 0.9rem;">Welcome!</span>
                        <img src="{{ url_for('static', filename='gear.png') }}" alt="Settings" title="Settings" style="width: 20px; height: 20px; cursor: pointer; filter: brightness(0) saturate(100%) invert(55%) sepia(5%) saturate(368%) hue-rotate(202deg) brightness(92%) contrast(87%);" onclick="window.location.href='{{ url_for('settings') }}'">
                    </div>
                </div>
                {% else %}
                <div class="nav-right"></div>
                {% endif %}
            </div>

            <!-- Dropdown Menu -->
            <div class="dropdown-menu" id="dropdown-menu">
                <a href="{{ url_for('home') }}" class="dropdown-item">Home</a>
                <a href="{{ url_for('purchase') }}" class="dropdown-item">Purchase</a>
                {% if not (plan_status and plan_status.plan_id and plan_status.plan_id.startswith('team_plan_')) %}
                <a href="{{ url_for('panel') }}" class="dropdown-item">Personal Panel</a>
                {% endif %}
                {% if has_business %}
                {% if is_owner %}
                <a href="{{ url_for('team_management') }}" class="dropdown-item">Team Management</a>
                {% endif %}
                <a href="{{ url_for('team_panel') }}" class="dropdown-item">Team panel</a>
                {% endif %}
                <a href="{{ url_for('settings') }}" class="dropdown-item">Settings</a>
                {% if is_admin_user %}
                <a href="{{ url_for('admin_panel') }}" class="dropdown-item">Admin</a>
                {% endif %}
                <div class="dropdown-divider"></div>
                <a href="https://discord.gg/KWt6rvCukp" target="_blank" class="dropdown-item discord-item">Discord Server</a>
                <a href="{{ url_for('logout') }}" class="dropdown-item logout-item">Logout</a>
            </div>
        </nav>

        <div class="panel-container">
            {% if is_banned %}
            <!-- Banned User Overlay -->
            <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); z-index: 1000; display: flex; align-items: center; justify-content: center; flex-direction: column; gap: 1rem;">
                <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="#991a35" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="4.93" y1="4.93" x2="19.07" y2="19.07"></line>
                </svg>
                <h2 style="color: #991a35; margin: 0;">Account Banned</h2>
                <p style="color: #81828A; margin: 0; text-align: center; max-width: 400px;">Your account has been banned from using the panel. If you believe this is a mistake, please contact support.</p>
            </div>
            {% endif %}

            <div class="main-layout">
                <!-- Left Panel: Team Members -->
                <div class="selection-panel">
                    <div class="unified-header">
                        <div class="header-section">
                            <div class="panel-header">Team members ({{ active_member_count }}/{{ team.max_members }})</div>
                        </div>
                    </div>

                    <!-- Add Member Section -->
                    <div style="padding: 0.75rem 1rem; flex-shrink: 0;">
                        <div class="panel-subheader" style="margin-bottom: 0.5rem; color: #dcddde;">Add team member</div>
                        <div style="display: flex; gap: 0.5rem;">
                            <input type="text" id="member-adzsend-id" class="search-input" placeholder="Enter member's Adzsend ID (18 digits)..." style="flex: 1;" maxlength="18" pattern="[0-9]{18}">
                            <button id="add-member-btn" class="send-button" style="padding: 0 1rem; height: 40px; min-width: 80px;">Add</button>
                        </div>
                    </div>

                    <!-- Team Members List -->
                    <div class="channels-section" style="flex: 1; display: flex; flex-direction: column; min-height: 0; padding-top: 0;">
                        <div class="panel-header" style="padding: 0 1rem; margin-bottom: 0.5rem; margin-top: 0;">Team members</div>
                        <div id="members-list" class="channels-list">
                            {% if members|length == 0 %}
                                <div class="no-selection">No team members yet</div>
                            {% else %}
                                {% for member in members %}
                                    <div class="team-member-item" data-discord-id="{{ member.member_discord_id }}">
                                        <div class="member-avatar">
                                            <div style="width: 100%; height: 100%; border-radius: 50%; background: linear-gradient(135deg, #15d8bc, #006e59); display: flex; align-items: center; justify-content: center; color: #fff; font-weight: 600; font-size: 0.9rem;">{{ (member.member_adzsend_id or '??')[:2] }}</div>
                                        </div>
                                        <div class="member-info">
                                            <div class="member-username" style="font-family: monospace;">{{ member.member_adzsend_id or 'No ID' }}</div>
                                        </div>
                                        {% set status = member.invitation_status or 'pending' %}
                                        {% if status == 'pending' %}
                                            <span class="status-tag status-pending">Pending</span>
                                        {% elif status == 'accepted' %}
                                            <span class="status-tag status-accepted">Team member</span>
                                        {% elif status == 'denied' %}
                                            <span class="status-tag status-denied">Denied request</span>
                                            <button class="member-remove-btn member-remove-from-list" data-member-id="{{ member.id }}">Remove from list</button>
                                        {% elif status == 'owns_team' %}
                                            <span class="status-tag status-owns-team">Owns Team</span>
                                            <button class="member-remove-btn member-remove-from-list" data-member-id="{{ member.id }}">Remove from list</button>
                                        {% elif status == 'left' %}
                                            <span class="status-tag status-left">Left team</span>
                                            <button class="member-remove-btn member-remove-from-list" data-member-id="{{ member.id }}">Remove from list</button>
                                        {% elif status == 'banned' %}
                                            <span class="status-tag status-banned">Banned</span>
                                            <button class="member-remove-btn member-remove-from-list" data-member-id="{{ member.id }}">Remove from list</button>
                                        {% endif %}
                                        {% if status not in ['denied', 'left', 'banned', 'owns_team'] %}
                                            <button class="member-remove-btn" data-discord-id="{{ member.member_discord_id }}">✕</button>
                                        {% endif %}
                                    </div>
                                {% endfor %}
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Right Panel: Team Message -->
                <div class="action-panel">
                    <div class="unified-header">
                        <div class="header-section">
                            <div class="panel-header">Team advertisement message</div>
                        </div>
                    </div>

                    <!-- Message Section -->
                    <div class="message-section" style="display: flex; flex-direction: column; padding: 1rem; gap: 1rem; flex: 0.5;">
                        <div class="panel-subheader" style="margin-bottom: 0.5rem; color: #dcddde;">
                            This message will be used by all team members when sending from team panel
                        </div>
                        <textarea id="team-message-input" class="message-input" placeholder="Enter the message your team will be using, leaving this empty or setting the team message whilst empty will result in team members not being able to send anything..." maxlength="2000" style="flex: 1; margin-bottom: 0.5rem;">{{ team.team_message or '' }}</textarea>
                        <div class="message-footer">
                            <span class="char-count"><span id="char-count">{{ (team.team_message or '')|length }}</span>/2000</span>
                            <button id="set-message-btn" class="send-button">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                                    <polyline points="17 21 17 13 7 13 7 21"></polyline>
                                    <polyline points="7 3 7 8 15 8"></polyline>
                                </svg>
                                Set team message
                            </button>
                        </div>
                    </div>

                    <!-- Member Analytics Section -->
                    <div class="member-stats-section" style="display: flex; flex-direction: column; gap: 0.75rem; flex: 0.5; min-height: 0;">
                        <div class="panel-header" style="padding: 0 1rem; margin-bottom: 0.5rem; margin-top: 0.75rem;">Analytics</div>
                        <div id="member-stats-list" class="member-stats-list">
                            {% if member_stats|length == 0 %}
                                <div class="no-selection">No team members yet</div>
                            {% else %}
                                {% for stat in member_stats %}
                                    <div class="member-stat-item" data-member-id="{{ stat.user_id }}" data-member-name="{{ stat.member_adzsend_id or 'No ID' }}">
                                        <div class="member-stat-avatar">
                                            <div style="width: 100%; height: 100%; border-radius: 50%; background: linear-gradient(135deg, #15d8bc, #006e59); display: flex; align-items: center; justify-content: center; color: #fff; font-weight: 600; font-size: 0.9rem;">{{ (stat.member_adzsend_id or '??')[:2] }}</div>
                                        </div>
                                        <div class="member-stat-info">
                                            <div class="member-stat-username" style="font-family: monospace;">
                                                {{ stat.member_adzsend_id or 'No ID' }}
                                                {% if stat.is_owner %}
                                                    <span style="background: linear-gradient(to bottom, #15d8bc, #006e59); color: #121215; font-size: 0.6rem; padding: 0.2rem 0.4rem; border-radius: 3px; margin-left: 0.5rem; font-weight: 500; line-height: 1.2; display: inline-block; vertical-align: middle;">Owner</span>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="member-stat-usage">
                                            <div class="stat-number">{{ stat.business_all_time_sent }}</div>
                                            <div class="stat-label">Ads Sent</div>
                                        </div>
                                        <button class="view-analytics-btn" onclick="openAnalyticsDialog({{ stat.user_id }}, '{{ stat.member_adzsend_id or 'No ID' }}')">View</button>
                                    </div>
                                {% endfor %}
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Analytics Dialog -->
    <div class="analytics-dialog-overlay" id="analytics-dialog-overlay">
        <div class="analytics-dialog">
            <div class="analytics-dialog-header">
                <h3 class="analytics-dialog-title" id="analytics-dialog-title">Member Analytics</h3>
                <button class="analytics-dialog-close" onclick="closeAnalyticsDialog()">&times;</button>
            </div>
            <div class="analytics-tabs">
                <button class="analytics-tab active" data-tab="information" onclick="switchAnalyticsTab('information')">Information</button>
                <button class="analytics-tab" data-tab="dates" onclick="switchAnalyticsTab('dates')">Dates</button>
            </div>
            <div class="analytics-content">
                <!-- Information Panel -->
                <div class="analytics-panel active" id="panel-information">
                    <div id="analytics-info-content">
                        <div class="no-data-message">Loading...</div>
                    </div>
                </div>
                <!-- Dates Panel -->
                <div class="analytics-panel" id="panel-dates">
                    <div class="date-range-container">
                        <div class="date-input-group">
                            <label>From</label>
                            <input type="date" id="analytics-start-date">
                        </div>
                        <div class="date-input-group">
                            <label>To</label>
                            <input type="date" id="analytics-end-date">
                        </div>
                        <button class="apply-dates-btn" onclick="applyDateRange()">Apply</button>
                    </div>
                    <div class="chart-container">
                        <div class="chart-canvas-wrapper">
                            <canvas id="analytics-chart" class="chart-canvas"></canvas>
                            <div class="chart-tooltip" id="chart-tooltip"></div>
                        </div>
                        <div class="chart-summary" id="chart-summary">
                            <div class="chart-summary-item">
                                <div class="chart-summary-value" id="summary-total">0</div>
                                <div class="chart-summary-label">Total Ads</div>
                            </div>
                            <div class="chart-summary-item">
                                <div class="chart-summary-value" id="summary-avg">0</div>
                                <div class="chart-summary-label">Daily Avg</div>
                            </div>
                            <div class="chart-summary-item">
                                <div class="chart-summary-value" id="summary-peak">0</div>
                                <div class="chart-summary-label">Peak Day</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <style>
        .team-member-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background: #212227;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            transition: all 0.2s ease;
        }

        .team-member-item:hover {
            background: #2a2b32;
        }

        .member-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            overflow: hidden;
            flex-shrink: 0;
        }

        .member-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .member-info {
            flex: 1;
            min-width: 0;
        }

        .member-username {
            color: #dcddde;
            font-weight: 500;
            font-size: 0.95rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .member-email {
            color: #81828A;
            font-size: 0.8rem;
            font-family: 'gg sans', sans-serif;
        }

        .member-email-only {
            color: #dcddde;
            font-size: 0.9rem;
            font-family: 'gg sans', sans-serif;
        }

        .member-info {
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .status-tag {
            font-size: 0.7rem;
            padding: 0.3rem 0.6rem;
            border-radius: 4px;
            font-weight: 500;
            white-space: nowrap;
            border: none;
        }

        .status-pending {
            background: linear-gradient(to bottom, #3a3a4d, #2a2a3d);
            color: #ffffff;
        }

        .status-accepted {
            background: linear-gradient(to bottom, #15d8bc, #006e59);
            color: #121215;
        }

        .status-denied {
            background: linear-gradient(to bottom, #991a35, #6b1226);
            color: #ffffff;
        }

        .status-left {
            background: linear-gradient(to bottom, #991a35, #6b1226);
            color: #ffffff;
        }

        .status-banned {
            background: linear-gradient(to bottom, #991a35, #6b1226);
            color: #ffffff;
        }

        .status-owns-team {
            background: linear-gradient(to bottom, #15d8bc, #006e59);
            color: #121215;
        }

        .status-has-account {
            background: linear-gradient(to bottom, #3a3a4d, #2a2a3d);
            color: #ffffff;
        }

        .status-no-account {
            background: linear-gradient(to bottom, #3a3a4d, #2a2a3d);
            color: #81828A;
        }

        .member-remove-btn {
            padding: 0.4rem 0.75rem;
            background: transparent;
            border: none;
            border-radius: 4px;
            color: #991a35;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s ease;
            flex-shrink: 0;
            font-weight: 600;
        }

        .member-remove-btn:hover {
            background: rgba(223, 40, 31, 0.2);
            transform: scale(1.1);
        }

        .member-remove-from-list {
            font-size: 0.65rem;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap;
            background: rgba(231, 76, 60, 0.2);
            color: #E74C3C;
            border: 1px solid rgba(231, 76, 60, 0.4);
        }

        .member-remove-from-list:hover {
            background: rgba(231, 76, 60, 0.3);
            transform: none;
        }

        .panel-subheader {
            font-size: 0.9rem;
            color: #81828A;
        }

        /* Member Statistics Styles */
        .member-stats-list {
            background: transparent;
            overflow-y: auto;
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            min-height: 0;
        }

        .member-stats-list::-webkit-scrollbar {
            width: 8px;
        }

        .member-stats-list::-webkit-scrollbar-track {
            background: transparent;
        }

        .member-stats-list::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
        }

        .member-stat-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background: #212227;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .member-stat-item:hover {
            background: #2a2b32;
        }

        .member-stat-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            overflow: hidden;
            flex-shrink: 0;
        }

        .member-stat-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .member-stat-info {
            flex: 1;
            min-width: 0;
        }

        .member-stat-username {
            color: #dcddde;
            font-weight: 500;
            font-size: 0.95rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .member-stat-id {
            color: #81828A;
            font-size: 0.8rem;
            font-family: 'gg sans', sans-serif;
        }

        .member-stat-usage {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0.5rem 1rem;
            background: #121215;
            border-radius: 6px;
            min-width: 80px;
        }

        .stat-number {
            color: #15d8bc;
            font-weight: 700;
            font-size: 1.2rem;
            line-height: 1;
        }

        .stat-label {
            color: #81828A;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 0.25rem;
        }

        .view-analytics-btn {
            background: linear-gradient(to bottom, #15d8bc, #006e59);
            border: none;
            color: #121215;
            padding: 0.4rem 0.75rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 500;
            transition: all 0.2s ease;
            margin-left: auto;
        }

        .view-analytics-btn:hover {
            background: linear-gradient(to bottom, #10b89e, #004e40);
        }

        /* Analytics Dialog Styles */
        .analytics-dialog-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .analytics-dialog-overlay.show {
            display: flex;
        }

        .analytics-dialog {
            background: #1a1a1d;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 85vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .analytics-dialog-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.25rem;
            border-bottom: 1px solid #282930;
        }

        .analytics-dialog-title {
            color: #ffffff;
            font-size: 1.1rem;
            font-weight: 600;
            margin: 0;
        }

        .analytics-dialog-close {
            background: none;
            border: none;
            color: #81828A;
            cursor: pointer;
            font-size: 1.5rem;
            line-height: 1;
            padding: 0;
        }

        .analytics-dialog-close:hover {
            color: #ffffff;
        }

        .analytics-tabs {
            display: flex;
            border-bottom: 1px solid #282930;
        }

        .analytics-tab {
            flex: 1;
            padding: 0.75rem;
            background: none;
            border: none;
            color: #81828A;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s ease;
            border-bottom: 2px solid transparent;
        }

        .analytics-tab:hover {
            color: #dcddde;
        }

        .analytics-tab.active {
            color: #15d8bc;
            border-bottom-color: #15d8bc;
        }

        .analytics-content {
            padding: 0.75rem;
            overflow-y: auto;
            flex: 1;
        }

        .analytics-panel {
            display: none;
        }

        .analytics-panel.active {
            display: block;
        }

        .analytics-stat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid #282930;
        }

        .analytics-stat-row:last-child {
            border-bottom: none;
        }

        .analytics-stat-label {
            color: #81828A;
            font-size: 0.9rem;
        }

        .analytics-stat-value {
            color: #dcddde;
            font-weight: 600;
        }

        .analytics-progress-bar {
            width: 100%;
            height: 8px;
            background: #282930;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 0.5rem;
        }

        .analytics-progress-fill {
            height: 100%;
            background: linear-gradient(to right, #15d8bc, #006e59);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        /* Date picker styles */
        .date-range-container {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .date-input-group {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .date-input-group label {
            color: #81828A;
            font-size: 0.75rem;
            text-transform: uppercase;
        }

        .date-input-group input {
            background: #212227;
            border: 1px solid #282930;
            border-radius: 6px;
            padding: 0.5rem;
            color: #dcddde;
            font-size: 0.85rem;
        }

        .date-input-group input:focus {
            outline: none;
            border-color: #15d8bc;
        }

        /* Style the calendar icon */
        .date-input-group input[type="date"]::-webkit-calendar-picker-indicator {
            background: url('/static/calendar.png') no-repeat center;
            background-size: contain;
            filter: brightness(0) invert(1);
            cursor: pointer;
        }

        .apply-dates-btn {
            background: transparent;
            border: none;
            color: #15d8bc;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            margin-top: auto;
        }

        .apply-dates-btn:hover {
            color: #10b89e;
        }

        /* Chart styles */
        .chart-container {
            background: #121215;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .chart-canvas-wrapper {
            position: relative;
            width: 100%;
            height: 200px;
            overflow: hidden;
        }

        .chart-canvas {
            width: 100%;
            height: 100%;
        }

        .chart-tooltip {
            position: absolute;
            background: #282930;
            color: #dcddde;
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            font-size: 0.8rem;
            pointer-events: none;
            z-index: 10;
            display: none;
            white-space: nowrap;
        }

        .chart-summary {
            display: flex;
            justify-content: space-around;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #282930;
        }

        .chart-summary-item {
            text-align: center;
        }

        .chart-summary-value {
            color: #15d8bc;
            font-size: 1.2rem;
            font-weight: 700;
        }

        .chart-summary-label {
            color: #81828A;
            font-size: 0.7rem;
            text-transform: uppercase;
            margin-top: 0.25rem;
        }

        .no-data-message {
            text-align: center;
            color: #81828A;
            padding: 2rem;
        }
    </style>

    <script>
        // Prevent page from being stored in cache
        window.addEventListener('pageshow', function(event) {
            if (event.persisted) {
                window.location.reload();
            }
        });

        document.addEventListener('DOMContentLoaded', function() {
            const menuIcon = document.getElementById('menu-icon');
            const dropdownMenu = document.getElementById('dropdown-menu');
            const memberAdzsendIdInput = document.getElementById('member-adzsend-id');
            const addMemberBtn = document.getElementById('add-member-btn');
            const membersList = document.getElementById('members-list');
            const teamMessageInput = document.getElementById('team-message-input');
            const setMessageBtn = document.getElementById('set-message-btn');
            const charCount = document.getElementById('char-count');

            const maxMembers = {{ team.max_members }};
            let currentMemberCount = {{ active_member_count }};

            // Dropdown menu toggle
            if (menuIcon) {
                menuIcon.addEventListener('click', (e) => {
                    e.stopPropagation();
                    dropdownMenu.classList.toggle('show');
                });
            }

            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (dropdownMenu && !dropdownMenu.contains(e.target) && menuIcon && !menuIcon.contains(e.target)) {
                    dropdownMenu.classList.remove('show');
                }
            });

            // Character count for team message
            if (teamMessageInput && charCount) {
                teamMessageInput.addEventListener('input', function() {
                    charCount.textContent = this.value.length;
                });
            }

            // Only allow numeric input for Adzsend ID
            if (memberAdzsendIdInput) {
                memberAdzsendIdInput.addEventListener('input', function(e) {
                    this.value = this.value.replace(/[^0-9]/g, '');
                });
            }

            // Add team member
            if (addMemberBtn && memberAdzsendIdInput) {
                addMemberBtn.addEventListener('click', async function() {
                    const adzsendId = memberAdzsendIdInput.value.trim();

                    if (!adzsendId) {
                        showAlert('Please enter an Adzsend ID', 'Input Required');
                        return;
                    }

                    // Validate Adzsend ID format (18 digits)
                    if (!/^\d{18}$/.test(adzsendId)) {
                        showAlert('Please enter a valid 18-digit Adzsend ID', 'Invalid Format');
                        return;
                    }

                    if (currentMemberCount >= maxMembers) {
                        showAlert(`Team is full. Maximum ${maxMembers} members allowed for your plan.`, 'Team Full');
                        return;
                    }

                    addMemberBtn.disabled = true;
                    addMemberBtn.textContent = 'Adding...';

                    try {
                        const response = await fetch('/api/team/add-member', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRF-Token': '{{ csrf_token }}'
                            },
                            body: JSON.stringify({
                                adzsend_id: adzsendId
                            })
                        });

                        const data = await response.json();

                        if (response.ok && data.success) {
                            window.location.reload();
                        } else {
                            showAlert(data.error || 'Failed to add team member', 'Error');
                        }
                    } catch (error) {
                        console.error('Error adding member:', error);
                        showAlert('Failed to add team member. Please try again.', 'Error');
                    } finally {
                        addMemberBtn.disabled = false;
                        addMemberBtn.textContent = 'Add';
                    }
                });

                // Allow Enter key to add member
                memberAdzsendIdInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        addMemberBtn.click();
                    }
                });
            }

            // Remove team member
            document.querySelectorAll('.member-remove-btn').forEach(btn => {
                btn.addEventListener('click', async function() {
                    const discordId = this.dataset.discordId;
                    const memberId = this.dataset.memberId;
                    const isRemoveFromList = this.classList.contains('member-remove-from-list');

                    this.disabled = true;

                    try {
                        let endpoint, bodyData;

                        if (isRemoveFromList && memberId) {
                            // Remove denied/left member from list
                            endpoint = `/api/team/member/remove/${memberId}`;
                            bodyData = {};
                        } else if (discordId) {
                            // Regular removal (pending or accepted members)
                            endpoint = '/api/team/remove-member';
                            bodyData = { discord_id: discordId };
                        }

                        const response = await fetch(endpoint, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRF-Token': '{{ csrf_token }}'
                            },
                            body: JSON.stringify(bodyData)
                        });

                        const data = await response.json();

                        if (response.ok && data.success) {
                            window.location.reload();
                        } else {
                            showAlert(data.error || 'Failed to remove team member', 'Error');
                            this.disabled = false;
                        }
                    } catch (error) {
                        console.error('Error removing member:', error);
                        showAlert('Failed to remove team member. Please try again.', 'Error');
                        this.disabled = false;
                    }
                });
            });

            // Set team message
            if (setMessageBtn && teamMessageInput) {
                setMessageBtn.addEventListener('click', async function() {
                    const message = teamMessageInput.value.trim();

                    // Check for filtered content before saving (only if message is not empty)
                    if (message) {
                        const filteredWords = {{ BLACKLISTED_WORDS|tojson }};
                        const messageLower = message.toLowerCase();
                        let foundWords = [];

                        for (const word of filteredWords) {
                            if (messageLower.includes(word.toLowerCase())) {
                                foundWords.push(word);
                            }
                        }

                        if (foundWords.length > 0) {
                            // Flag the user for using banned words
                            try {
                                await fetch('/api/flag-self', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'X-CSRF-Token': '{{ csrf_token }}'
                                    },
                                    body: JSON.stringify({ words: foundWords })
                                });
                            } catch (e) {
                                console.error('Failed to report flagged content:', e);
                            }

                            showAlert(`Banned words used\n\nMessage contains prohibited content:\n• ${foundWords.join('\n• ')}\n\nPlease remove this content from your message before saving.`, 'Warning');
                            return; // Stop execution
                        }
                    }

                    setMessageBtn.disabled = true;
                    const originalHtml = setMessageBtn.innerHTML;
                    setMessageBtn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="spinner"><circle cx="12" cy="12" r="10" stroke-opacity="0.25"></circle><path d="M12 2 A10 10 0 0 1 22 12" stroke-linecap="round"></path></svg> Saving...';

                    try {
                        const response = await fetch('/api/team/set-team-message', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRF-Token': '{{ csrf_token }}'
                            },
                            body: JSON.stringify({
                                message: message
                            })
                        });

                        const data = await response.json();

                        if (response.ok && data.success) {
                            // Success - no alert needed
                        } else {
                            showAlert(data.error || 'Failed to update team message', 'Error');
                        }
                    } catch (error) {
                        console.error('Error setting team message:', error);
                        showAlert('Failed to update team message. Please try again.', 'Error');
                    } finally {
                        setMessageBtn.disabled = false;
                        setMessageBtn.innerHTML = originalHtml;
                    }
                });
            }
        });

        // ========================================
        // ANALYTICS DIALOG FUNCTIONALITY
        // ========================================

        let currentMemberId = null;
        let currentMemberName = null;
        let memberJoinDate = null;
        let serverDate = null;
        let chartData = [];

        function openAnalyticsDialog(memberId, memberName) {
            currentMemberId = memberId;
            currentMemberName = memberName;

            document.getElementById('analytics-dialog-title').textContent = `Analytics: ${memberName}`;
            document.getElementById('analytics-dialog-overlay').classList.add('show');

            // Reset to information tab
            switchAnalyticsTab('information');

            // Set default date range (last 30 days)
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - 30);

            document.getElementById('analytics-start-date').value = startDate.toISOString().split('T')[0];
            document.getElementById('analytics-end-date').value = endDate.toISOString().split('T')[0];

            // Load information data
            loadAnalyticsInfo();
        }

        function closeAnalyticsDialog() {
            document.getElementById('analytics-dialog-overlay').classList.remove('show');
            currentMemberId = null;
            currentMemberName = null;
        }

        // Close on overlay click
        document.getElementById('analytics-dialog-overlay').addEventListener('click', function(e) {
            if (e.target === this) {
                closeAnalyticsDialog();
            }
        });

        function switchAnalyticsTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.analytics-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.tab === tabName);
            });

            // Update panels
            document.querySelectorAll('.analytics-panel').forEach(panel => {
                panel.classList.toggle('active', panel.id === `panel-${tabName}`);
            });

            // Load data for the tab
            if (tabName === 'information') {
                loadAnalyticsInfo();
            } else if (tabName === 'dates') {
                loadDailyStats();
            }
        }

        async function loadAnalyticsInfo() {
            const container = document.getElementById('analytics-info-content');
            container.innerHTML = '<div class="no-data-message">Loading...</div>';

            try {
                const response = await fetch(`/api/team/member/${currentMemberId}/analytics`);
                const data = await response.json();

                if (data.success) {
                    const analytics = data.analytics;
                    // Format date as mm/dd/yy
                    const joinedDate = analytics.joined_at ? (() => {
                        const d = new Date(analytics.joined_at);
                        const month = String(d.getMonth() + 1).padStart(2, '0');
                        const day = String(d.getDate()).padStart(2, '0');
                        const year = String(d.getFullYear()).slice(-2);
                        return `${month}/${day}/${year}`;
                    })() : 'Unknown';

                    // Store dates for calendar restrictions
                    memberJoinDate = analytics.joined_at ? analytics.joined_at.split('T')[0] : null;
                    serverDate = analytics.server_date || new Date().toISOString().split('T')[0];

                    // Apply date restrictions to inputs
                    const startInput = document.getElementById('analytics-start-date');
                    const endInput = document.getElementById('analytics-end-date');
                    if (memberJoinDate) {
                        startInput.min = memberJoinDate;
                        endInput.min = memberJoinDate;
                    }
                    startInput.max = serverDate;
                    endInput.max = serverDate;

                    // Adjust default date range if join date is more recent than 30 days ago
                    if (memberJoinDate && new Date(memberJoinDate) > new Date(startInput.value)) {
                        startInput.value = memberJoinDate;
                    }

                    container.innerHTML = `
                        <div class="analytics-stat-row">
                            <span class="analytics-stat-label">All-time ads sent</span>
                            <span class="analytics-stat-value">${analytics.all_time.toLocaleString()}</span>
                        </div>
                        <div class="analytics-stat-row">
                            <span class="analytics-stat-label">Current cycle ads</span>
                            <span class="analytics-stat-value">${analytics.current_cycle.toLocaleString()}</span>
                        </div>
                        <div class="analytics-stat-row">
                            <span class="analytics-stat-label">Joined team (mm/dd/yy)</span>
                            <span class="analytics-stat-value">${joinedDate}</span>
                        </div>
                        <div class="analytics-stat-row" style="flex-direction: column; align-items: stretch;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                <span class="analytics-stat-label">Team contribution</span>
                                <span class="analytics-stat-value">${analytics.percentage}%</span>
                            </div>
                            <div class="analytics-progress-bar">
                                <div class="analytics-progress-fill" style="width: ${Math.min(analytics.percentage, 100)}%"></div>
                            </div>
                        </div>
                    `;
                } else {
                    container.innerHTML = `<div class="no-data-message">${data.error || 'Failed to load analytics'}</div>`;
                }
            } catch (error) {
                console.error('Error loading analytics:', error);
                container.innerHTML = '<div class="no-data-message">Error loading analytics</div>';
            }
        }

        async function loadDailyStats() {
            const startDate = document.getElementById('analytics-start-date').value;
            const endDate = document.getElementById('analytics-end-date').value;

            try {
                const response = await fetch(`/api/team/member/${currentMemberId}/daily-stats?start_date=${startDate}&end_date=${endDate}`);
                const data = await response.json();

                if (data.success) {
                    chartData = data.data.stats || [];

                    // Update summary
                    document.getElementById('summary-total').textContent = data.data.total.toLocaleString();
                    document.getElementById('summary-avg').textContent = data.data.average.toFixed(1);
                    document.getElementById('summary-peak').textContent = data.data.peak.toLocaleString();

                    // Draw chart
                    drawChart();
                } else {
                    console.error('Failed to load daily stats:', data.error);
                }
            } catch (error) {
                console.error('Error loading daily stats:', error);
            }
        }

        function applyDateRange() {
            loadDailyStats();
        }

        function drawChart() {
            const canvas = document.getElementById('analytics-chart');
            const ctx = canvas.getContext('2d');
            const wrapper = canvas.parentElement;

            // Set canvas size
            canvas.width = wrapper.offsetWidth;
            canvas.height = wrapper.offsetHeight;

            const width = canvas.width;
            const height = canvas.height;
            const padding = { top: 20, right: 20, bottom: 30, left: 40 };

            // Clear canvas
            ctx.clearRect(0, 0, width, height);

            if (chartData.length === 0) {
                ctx.fillStyle = '#81828A';
                ctx.font = '14px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('No data for selected period', width / 2, height / 2);
                return;
            }

            const chartWidth = width - padding.left - padding.right;
            const chartHeight = height - padding.top - padding.bottom;

            // Find max value for scaling
            const maxCount = Math.max(...chartData.map(d => d.count), 1);

            // Calculate points
            const points = chartData.map((d, i) => ({
                x: padding.left + (i / (chartData.length - 1 || 1)) * chartWidth,
                y: padding.top + chartHeight - (d.count / maxCount) * chartHeight,
                date: d.date,
                count: d.count
            }));

            // Draw gradient fill
            if (points.length > 1) {
                const gradient = ctx.createLinearGradient(0, padding.top, 0, height - padding.bottom);
                gradient.addColorStop(0, 'rgba(21, 216, 188, 0.3)');
                gradient.addColorStop(1, 'rgba(21, 216, 188, 0)');

                ctx.beginPath();
                ctx.moveTo(points[0].x, height - padding.bottom);
                points.forEach(p => ctx.lineTo(p.x, p.y));
                ctx.lineTo(points[points.length - 1].x, height - padding.bottom);
                ctx.closePath();
                ctx.fillStyle = gradient;
                ctx.fill();
            }

            // Draw line
            ctx.beginPath();
            ctx.strokeStyle = '#15d8bc';
            ctx.lineWidth = 2;
            points.forEach((p, i) => {
                if (i === 0) ctx.moveTo(p.x, p.y);
                else ctx.lineTo(p.x, p.y);
            });
            ctx.stroke();

            // Draw points
            points.forEach(p => {
                ctx.beginPath();
                ctx.arc(p.x, p.y, 4, 0, Math.PI * 2);
                ctx.fillStyle = '#15d8bc';
                ctx.fill();
                ctx.strokeStyle = '#121215';
                ctx.lineWidth = 2;
                ctx.stroke();
            });

            // Draw Y-axis labels
            ctx.fillStyle = '#81828A';
            ctx.font = '11px sans-serif';
            ctx.textAlign = 'right';
            ctx.fillText(maxCount.toString(), padding.left - 5, padding.top + 5);
            ctx.fillText('0', padding.left - 5, height - padding.bottom + 5);

            // Draw X-axis labels (first and last dates)
            if (chartData.length > 0) {
                ctx.textAlign = 'left';
                ctx.fillText(formatDateShort(chartData[0].date), padding.left, height - 5);
                ctx.textAlign = 'right';
                ctx.fillText(formatDateShort(chartData[chartData.length - 1].date), width - padding.right, height - 5);
            }

            // Store points for tooltip
            canvas.chartPoints = points;
        }

        function formatDateShort(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        // Chart tooltip
        const chartCanvas = document.getElementById('analytics-chart');
        const chartTooltip = document.getElementById('chart-tooltip');

        chartCanvas.addEventListener('mousemove', function(e) {
            if (!this.chartPoints || this.chartPoints.length === 0) return;

            const rect = this.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            // Find closest point
            let closest = null;
            let minDist = Infinity;

            this.chartPoints.forEach(p => {
                const dist = Math.sqrt(Math.pow(p.x - x, 2) + Math.pow(p.y - y, 2));
                if (dist < minDist && dist < 20) {
                    minDist = dist;
                    closest = p;
                }
            });

            if (closest) {
                chartTooltip.style.display = 'block';
                chartTooltip.innerHTML = `<strong>${closest.count} ads</strong><br>${formatDateShort(closest.date)}`;

                // Position tooltip below the point
                const tooltipHeight = chartTooltip.offsetHeight;
                const tooltipWidth = chartTooltip.offsetWidth;

                // Center horizontally under the point
                let left = closest.x - (tooltipWidth / 2);
                // Ensure it doesn't go off-screen horizontally
                if (left < 0) left = 0;
                if (left + tooltipWidth > rect.width) left = rect.width - tooltipWidth;

                // Position below the point
                let top = closest.y + 15;
                // If it would go off-screen below, position above instead
                if (top + tooltipHeight > rect.height) {
                    top = closest.y - tooltipHeight - 10;
                }

                chartTooltip.style.left = left + 'px';
                chartTooltip.style.top = top + 'px';
            } else {
                chartTooltip.style.display = 'none';
            }
        });

        chartCanvas.addEventListener('mouseleave', function() {
            chartTooltip.style.display = 'none';
        });

        // Redraw chart on window resize
        window.addEventListener('resize', function() {
            if (document.getElementById('analytics-dialog-overlay').classList.contains('show') &&
                document.getElementById('panel-dates').classList.contains('active')) {
                drawChart();
            }
        });
    </script>
</body>
</html>
